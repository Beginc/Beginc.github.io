{"title":"3-SQL优化之Explain","date":"2020-02-11T06:59:12.000Z","date_formatted":{"ll":"Feb 11, 2020","L":"02/11/2020","MM-DD":"02-11"},"thumbnail":"post/数据库/MySQL/3-SQL优化之Explain/cover.png","link":"post/数据库/MySQL/3-SQL优化之Explain","categories":["MySQL","数据库"],"updated":"2020-02-11T13:24:32.032Z","content":"<h1 id=\"explain使用方法\">Explain使用方法<a href=\"#explain使用方法\" title=\"Explain使用方法\"></a></h1><p><code>explain SQL语句</code>，如<code>explain select * from account</code></p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/1.png\" class=\"\">\n\n<h1 id=\"字段\">字段<a href=\"#字段\" title=\"字段\"></a></h1><h2 id=\"id\">id<a href=\"#id\" title=\"id\"></a></h2><p>该字段用于表示多张表被处理的顺序。</p>\n<p><strong>id相同</strong></p>\n<p>处理顺序由上至下。数据库小的表会优先处理，因为优先处理小表产生的中间表较小，占用内存少。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/2.png\" class=\"\">\n\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/3.png\" class=\"\">\n\n<p><strong>id不同</strong></p>\n<p>id越大越先被处理。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/4.png\" class=\"\">\n\n<h2 id=\"select_type\">select_type<a href=\"#select_type\" title=\"select_type\"></a></h2><p>表示查询的种类。</p>\n<p><strong>SIMPLE</strong></p>\n<p>简单查询，无子查询，无Union。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/5.png\" class=\"\">\n\n<p><strong>PRIMARY</strong></p>\n<p>带子查询的主查询。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/4.png\" class=\"\">\n\n<p><strong>DERIVED</strong></p>\n<p>衍生查询，在查询的时候用到了临时表。</p>\n<ul><li>在from子查询中只有一张表。</li>\n<li>在from子查询中只有一张表，如果有<code>table1 union table2</code>，则table1就是DERIVED。</li>\n</ul><p>此查询本应该是DERIVED，但在MySQL5.7中对SQL进行了改写，消除了子查询。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/6.png\" class=\"\">\n\n<p>可用<code>show warnings</code>查看。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/7.png\" class=\"\">\n\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/8.png\" class=\"\">\n\n<p><strong>UNION</strong></p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/8.png\" class=\"\">\n\n<p><strong>UNION RESULT</strong></p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/8.png\" class=\"\">\n\n<h2 id=\"table\">table<a href=\"#table\" title=\"table\"></a></h2><p>表名。</p>\n<h2 id=\"partitions\">partitions<a href=\"#partitions\" title=\"partitions\"></a></h2><p>TODO</p>\n<h2 id=\"type\">type<a href=\"#type\" title=\"type\"></a></h2><p>索引类型。性能排序为:</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">system &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; all</span><br></pre></td></tr></table></figure>\n\n<p><strong>system</strong></p>\n<ul><li><p>只有一条数据的系统表的查询。</p>\n</li>\n<li><p>衍生表只有一条记录的主查询。</p>\n</li>\n</ul><p>这里本来应该是system，但是由于MySQL5.7消除了子查询，所以为const。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/9.png\" class=\"\">\n\n<p><strong>const</strong></p>\n<p>仅仅能查到一条数据的查询。用于Primary Key或者Unique索引。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/10.png\" class=\"\">\n\n<p>注意需要是在主键索引或唯一索引上的查询。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/11.png\" class=\"\">\n\n<p><strong>eq_ref</strong></p>\n<p>唯一性索引。对于每个索引键，查询返回匹配的唯一数据（匹配到必须只有一条，匹配到的也不能为0条），常见于唯一索引和主键索引。</p>\n<p>在aid字段上建立唯一索引。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/12.png\" class=\"\">\n\n<p>此时，对于people中每个aid都在account中有唯一匹配，所以是eq_ref。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/14.png\" class=\"\">\n\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/15.png\" class=\"\">\n\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/13.png\" class=\"\">\n\n<p>但是，如果people中如果多了一条数据，在account中没有匹配，则不是eq_ref。先在aid字段上换成普通索引。然后插入一条aid为3的数据，最后进行查询。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/16.png\" class=\"\">\n\n<p><strong>ref</strong></p>\n<p>非唯一性索引，对于每个索引键，查询返回匹配的所有数据（匹配到可以只有一条，匹配到的可以为0条，也可以为多条）</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/16.png\" class=\"\">\n\n<p><strong>range</strong></p>\n<p>范围查询。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/17.png\" class=\"\">\n\n<p>当in后包含所有的索引键，则失效。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/18.png\" class=\"\">\n\n<p><strong>index</strong></p>\n<p>查询全部索引中的数据，不需要查表。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/19.png\" class=\"\">\n\n<p><strong>all</strong></p>\n<p>查询全部表中的数据。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/20.png\" class=\"\">\n\n<h2 id=\"possible_keys\">possible_keys<a href=\"#possible_keys\" title=\"possible_keys\"></a></h2><p>可能用到的索引，不准确。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/19.png\" class=\"\">\n\n<h2 id=\"key\">key<a href=\"#key\" title=\"key\"></a></h2><p>实际用到的索引。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/19.png\" class=\"\">\n\n<h2 id=\"key_len\">key_len<a href=\"#key_len\" title=\"key_len\"></a></h2><p>索引的长度。用于判断复合索引是否被完全使用。</p>\n<p>给people表添加复合索引。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/21.png\" class=\"\">\n\n<p><strong>计算方式</strong></p>\n<ol><li>考虑编码<ul><li>UTF-8:：1个字符3个字节</li>\n<li>GBK：1个字符2个字节</li>\n<li>Latin：1个字符1个字节</li>\n</ul></li>\n<li>考虑是否可以为NULL<ul><li>可以为NULL则添加1个字节用于标识</li>\n</ul></li>\n<li>考虑是否长度可变<ul><li>若长度可变则添加2个字节标识</li>\n</ul></li>\n</ol><p>按uname进行查询。varchar(50) + UTF-8 + 非空，则为<code>3 * 50 + 2 = 152</code></p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/22.png\" class=\"\">\n\n<p>按uname和aid进行查询。aid为int，占用4个字节。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/23.png\" class=\"\">\n\n<p>未按最左前缀原则进行书写，只用到了aid索引。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/24.png\" class=\"\">\n\n<h2 id=\"ref\">ref<a href=\"#ref\" title=\"ref\"></a></h2><p>指明当前表所参照的字段。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/13.png\" class=\"\">\n\n<p>参照常量。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/25.png\" class=\"\">\n\n<h2 id=\"rows\">rows<a href=\"#rows\" title=\"rows\"></a></h2><p> MySQL 查询优化器根据统计信息, 估算 SQL 要查找到结果集需要扫描读取的数据行数，越低越好。</p>\n<p>根据主键id对account进行查询，有索引，只需扫描一条记录。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/26.png\" class=\"\">\n\n<p>根据balance对account进行查询，无索引，需扫描全部两条记录。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/27.png\" class=\"\">\n\n<h2 id=\"filtered\">filtered<a href=\"#filtered\" title=\"filtered\"></a></h2><p>TODO</p>\n<h2 id=\"extra\">Extra<a href=\"#extra\" title=\"Extra\"></a></h2><p><strong>using filesort</strong></p>\n<p>需要额外的一次排序，性能消耗较大。</p>\n<ul><li>对于单索引，如果排序和查找用的是同一个字段，则无需额外的一次排序。</li>\n<li>对于复合索引，若查找和排序符合最佳左前缀原则，则无需额外的一次排序。</li>\n</ul><p>where和order by不用同一个字段</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/28.png\" class=\"\">\n\n<p>where和order by用同一个字段</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/29.png\" class=\"\">\n\n<p>创建(id, uname, aid)上的复合索引</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/30.png\" class=\"\">\n\n<p>按最佳左前缀原则查询</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">explain</span> <span class=\"keyword\">select</span> <span class=\"keyword\">id</span> <span class=\"keyword\">from</span> people <span class=\"keyword\">where</span> <span class=\"keyword\">id</span> = <span class=\"number\">1</span> <span class=\"keyword\">order</span> <span class=\"keyword\">by</span> uname;</span><br></pre></td></tr></table></figure>\n\n<p>不按最佳左前缀原则查询</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">explain</span> <span class=\"keyword\">select</span> <span class=\"keyword\">id</span> <span class=\"keyword\">from</span> people <span class=\"keyword\">where</span> <span class=\"keyword\">id</span> = <span class=\"number\">1</span> <span class=\"keyword\">order</span> <span class=\"keyword\">by</span> aid;</span><br></pre></td></tr></table></figure>\n\n<p><strong>using index</strong></p>\n<p>覆盖索引，不用读取数据文件，只从索引文件中获取数据。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/33.png\" class=\"\">\n\n<p><strong>using where</strong></p>\n<p>需要回表查询。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/3-SQL%E4%BC%98%E5%8C%96%E4%B9%8BExplain/34.png\" class=\"\">","prev":{"title":"Flexbox布局","link":"post/Web/CSS/Flexbox布局"},"next":{"title":"2-SQL优化之索引原理","link":"post/数据库/MySQL/2-SQL优化之索引原理"},"plink":"https://beginc.github.io/post/数据库/MySQL/3-SQL优化之Explain/","toc":[{"id":"explain使用方法","title":"Explain使用方法","index":"1"},{"id":"字段","title":"字段","index":"2","children":[{"id":"id","title":"id","index":"2.1"},{"id":"select_type","title":"select_type","index":"2.2"},{"id":"table","title":"table","index":"2.3"},{"id":"partitions","title":"partitions","index":"2.4"},{"id":"type","title":"type","index":"2.5"},{"id":"possible_keys","title":"possible_keys","index":"2.6"},{"id":"key","title":"key","index":"2.7"},{"id":"key_len","title":"key_len","index":"2.8"},{"id":"ref","title":"ref","index":"2.9"},{"id":"rows","title":"rows","index":"2.10"},{"id":"filtered","title":"filtered","index":"2.11"},{"id":"extra","title":"Extra","index":"2.12"}]}]}