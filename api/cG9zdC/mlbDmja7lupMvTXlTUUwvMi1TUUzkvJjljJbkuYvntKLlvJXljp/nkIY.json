{"title":"2-SQL优化之索引原理","date":"2020-02-11T06:58:57.000Z","date_formatted":{"ll":"Feb 11, 2020","L":"02/11/2020","MM-DD":"02-11"},"thumbnail":"post/数据库/MySQL/2-SQL优化之索引原理/cover.png","link":"post/数据库/MySQL/2-SQL优化之索引原理","categories":["MySQL","数据库"],"updated":"2020-02-12T08:30:55.983Z","content":"<h1 id=\"索引分类\">索引分类<a href=\"#索引分类\" title=\"索引分类\"></a></h1><h2 id=\"单列索引\">单列索引<a href=\"#单列索引\" title=\"单列索引\"></a></h2><p>单列索引即在单个字段上建立索引。</p>\n<h3 id=\"普通索引\">普通索引<a href=\"#普通索引\" title=\"普通索引\"></a></h3><ul><li>允许有重复值</li>\n<li>允许有NULL</li>\n</ul><h3 id=\"主键索引\">主键索引<a href=\"#主键索引\" title=\"主键索引\"></a></h3><ul><li>不允许有重复值</li>\n<li>不允许有NULL</li>\n</ul><h3 id=\"唯一索引\">唯一索引<a href=\"#唯一索引\" title=\"唯一索引\"></a></h3><ul><li>不允许有重复值</li>\n<li>允许有NULL</li>\n</ul><h2 id=\"复合索引\">复合索引<a href=\"#复合索引\" title=\"复合索引\"></a></h2><p>在表中的多个字段组合上创建的索引。</p>\n<h2 id=\"全文索引\">全文索引<a href=\"#全文索引\" title=\"全文索引\"></a></h2><ol><li>MySQL 5.6 以前的版本，只有 MyISAM 存储引擎支持全文索引。</li>\n<li>MySQL 5.6 及以后的版本，MyISAM 和 InnoDB 存储引擎均支持全文索引。</li>\n<li>只有字段的数据类型为 char、varchar、text 及其系列才可以建全文索引。</li>\n</ol><h2 id=\"空间索引\">空间索引<a href=\"#空间索引\" title=\"空间索引\"></a></h2><p>MyISAM 存储引擎支持空间数据索引（R-Tree），可以用于地理数据存储。空间数据索引会从所有维度来索引数据，可以有效地使用任意维度来进行组合查询。必须使用 GIS 相关的函数来维护数据。</p>\n<h1 id=\"索引结构\">索引结构<a href=\"#索引结构\" title=\"索引结构\"></a></h1><h2 id=\"btree\">B+Tree<a href=\"#btree\" title=\"B+Tree\"></a></h2><p><strong>M阶B-Tree特点</strong></p>\n<ol><li>若根节点不是终端节点，则至少有两颗子树（即至少一个关键字）。</li>\n<li>每个结点至多有M棵子树（即至多M - 1个关键字）。</li>\n<li>除根节点外的所有非叶节点至少有<code>ceil(M / 2)</code>棵子树（即至少包含<code>ceil(M / 2) - 1</code>个关键字）。</li>\n<li>所有非叶节点的结构类似如下:</li>\n</ol><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> |P1|K1|P2|K2|P3|</span><br><span class=\"line\">  &#x2F;     |      \\</span><br><span class=\"line\">Child  Child  Child</span><br></pre></td></tr></table></figure>\n\n<ol><li>所有叶子节点出现在同一层次，不带任何信息，表示查找失败。</li>\n</ol><img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/2-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E7%B4%A2%E5%BC%95%E5%8E%9F%E7%90%86/1.png\" class=\"\">\n\n\n\n<p><strong>M阶B+Tree特点</strong></p>\n<p>与B-Tree不同的点有：</p>\n<ol><li><p>结点中每个关键字 对应一颗子树。</p>\n</li>\n<li><p>每个结点至多有M棵子树（即至多M个关键字）。</p>\n</li>\n<li><p>除根节点外的所有非叶节点至少有<code>ceil(M / 2)</code> 棵子树（即至少包含<code>ceil(M / 2)</code>个关键字）。</p>\n</li>\n<li><p>所有非叶节点不包含信息，只包含对应子树的最大关键字和指向该子树的指针，仅仅起索引作用。</p>\n</li>\n<li><p>叶节点包含了全部关键字，叶子节点的指针指向记录存储的地址。</p>\n</li>\n<li><p>所有叶子节点连接成一个单链表，有一个指针指向关键字最小的叶子节点。</p>\n</li>\n</ol><img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/2-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E7%B4%A2%E5%BC%95%E5%8E%9F%E7%90%86/2.png\" class=\"\">\n\n\n\n<p><strong>B+Tree的优点</strong></p>\n<ol><li>查找效率高。</li>\n<li>相对于B-Tree，B+Tree具有有序性，适用于全键值、键值范围和键前缀查找，其中键前缀查找只适用于最左前缀查找（联合索引）。</li>\n</ol><p><strong>复合索引下B+Tree的结构</strong></p>\n<p>TODO</p>\n<h2 id=\"hash\">Hash<a href=\"#hash\" title=\"Hash\"></a></h2><p><strong>Hash索引优点</strong></p>\n<ol><li>查找效率高，<code>O(1)</code>。</li>\n</ol><p><strong>Hash索引缺点</strong></p>\n<ol><li>无法用于排序和分组。</li>\n<li>无法用于区间查找。</li>\n</ol><h1 id=\"mysql索引\">MySQL索引<a href=\"#mysql索引\" title=\"MySQL索引\"></a></h1><p>索引是在存储引擎层实现的，而不是在服务器层实现的，所以不同存储引擎具有不同的索引类型和实现。</p>\n<h2 id=\"myisam\">MyISAM<a href=\"#myisam\" title=\"MyISAM\"></a></h2><h3 id=\"非聚簇索引\">非聚簇索引<a href=\"#非聚簇索引\" title=\"非聚簇索引\"></a></h3><p>非聚簇索引指指索引项的排序方式和表中数据记录排序方式不一致的索引。</p>\n<p>一张表分三个文件存储。数据和索引分开存储。</p>\n<div class=\"cz\"><div class=\"db\"><table><thead><tr>\n<th>文件</th><th>内容</th></tr>\n</thead><tbody><tr>\n<td>表名.frm</td><td>存储表结构</td></tr>\n<tr>\n<td>表名.MYD</td><td>存储行数据</td></tr>\n<tr>\n<td>表名.MYI</td><td>存储索引</td></tr>\n</tbody></table></div></div><h3 id=\"索引结构-1\">索引结构<a href=\"#索引结构-1\" title=\"索引结构\"></a></h3><p>MyISAM使用B+Tree作为索引结构，在叶子结点上存储指向记录的指针。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/2-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E7%B4%A2%E5%BC%95%E5%8E%9F%E7%90%86/3.png\" class=\"\">\n\n\n\n<h2 id=\"innodb\">InnoDB<a href=\"#innodb\" title=\"InnoDB\"></a></h2><h3 id=\"聚簇索引\">聚簇索引<a href=\"#聚簇索引\" title=\"聚簇索引\"></a></h3><p>非聚簇索引指指索引项的排序方式和表中数据记录排序方式一致的索引。</p>\n<p>一张表分两个文件存储。数据和索引存储在一个文件中。</p>\n<div class=\"cz\"><div class=\"db\"><table><thead><tr>\n<th>文件</th><th>内容</th></tr>\n</thead><tbody><tr>\n<td>表名.frm</td><td>存储表结构</td></tr>\n<tr>\n<td>表名.idb</td><td>存储行数据和索引</td></tr>\n</tbody></table></div></div><ul><li>如果一个主键被定义了，那么这个主键就是作为聚集索引。</li>\n<li>如果没有主键被定义，那么该表的第一个唯一非空索引被作为聚集索引。</li>\n<li>如果没有主键也没有合适的唯一索引，那么InnoDB内部会生成一个隐藏的主键作为聚集索引，这个隐藏的主键是一个6个字节的列，该列的值会随着数据的插入自增。</li>\n</ul><h3 id=\"索引结构-2\">索引结构<a href=\"#索引结构-2\" title=\"索引结构\"></a></h3><p>InnoDB使用B+Tree作为索引结构，在叶子结点上直接存储了行数据。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/2-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E7%B4%A2%E5%BC%95%E5%8E%9F%E7%90%86/4.png\" class=\"\">\n\n\n\n<h1 id=\"mysql索引操作\">MySQL索引操作<a href=\"#mysql索引操作\" title=\"MySQL索引操作\"></a></h1><h1 id=\"建立索引\">建立索引<a href=\"#建立索引\" title=\"建立索引\"></a></h1><p><strong>普通索引</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">INDEX</span> 索引名称 <span class=\"keyword\">ON</span> 表名(列名);</span><br><span class=\"line\">或者</span><br><span class=\"line\"><span class=\"keyword\">ALTER</span> <span class=\"keyword\">TABLE</span> 表名 <span class=\"keyword\">ADD</span> <span class=\"keyword\">INDEX</span> 索引名称(列名);</span><br></pre></td></tr></table></figure>\n\n<p><strong>唯一索引</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">UNIQUE</span> <span class=\"keyword\">INDEX</span> 索引名称 <span class=\"keyword\">ON</span> 表名(列名);</span><br><span class=\"line\">或者</span><br><span class=\"line\"><span class=\"keyword\">ALTER</span> <span class=\"keyword\">TABLE</span> 表名 <span class=\"keyword\">ADD</span> <span class=\"keyword\">UNIQUE</span> <span class=\"keyword\">INDEX</span> 索引名称(列名);</span><br></pre></td></tr></table></figure>\n\n<p><strong>主键索引</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">ALTER</span> <span class=\"keyword\">TABLE</span> 表名 <span class=\"keyword\">ADD</span> PRIMARY <span class=\"keyword\">KEY</span> (列名)</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"删除索引\">删除索引<a href=\"#删除索引\" title=\"删除索引\"></a></h1><p><strong>删除普通/唯一索引</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">DROP</span> <span class=\"keyword\">INDEX</span> 索引名称 <span class=\"keyword\">ON</span> 表名;</span><br><span class=\"line\">或</span><br><span class=\"line\"><span class=\"keyword\">ALTER</span> <span class=\"keyword\">TABLE</span> 表名 <span class=\"keyword\">DROP</span> <span class=\"keyword\">INDEX</span> 索引名称;</span><br></pre></td></tr></table></figure>\n\n<p><strong>删除主键</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">ALTER</span> <span class=\"keyword\">TABLE</span> 表名 <span class=\"keyword\">DROP</span> PRIMARY <span class=\"keyword\">KEY</span>;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"查看索引\">查看索引<a href=\"#查看索引\" title=\"查看索引\"></a></h1><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SHOW</span> <span class=\"keyword\">INDEX</span> <span class=\"keyword\">FROM</span> 表名;</span><br></pre></td></tr></table></figure>\n\n\n\n","prev":{"title":"3-SQL优化之Explain","link":"post/数据库/MySQL/3-SQL优化之Explain"},"next":{"title":"1-SQL优化之SQL解析顺序","link":"post/数据库/MySQL/1-SQL优化之SQL解析顺序"},"plink":"https://beginc.github.io/post/数据库/MySQL/2-SQL优化之索引原理/","toc":[{"id":"索引分类","title":"索引分类","index":"1","children":[{"id":"单列索引","title":"单列索引","index":"1.1","children":[{"id":"普通索引","title":"普通索引","index":"1.1.1"},{"id":"主键索引","title":"主键索引","index":"1.1.2"},{"id":"唯一索引","title":"唯一索引","index":"1.1.3"}]},{"id":"复合索引","title":"复合索引","index":"1.2"},{"id":"全文索引","title":"全文索引","index":"1.3"},{"id":"空间索引","title":"空间索引","index":"1.4"}]},{"id":"索引结构","title":"索引结构","index":"2","children":[{"id":"btree","title":"B+Tree","index":"2.1"},{"id":"hash","title":"Hash","index":"2.2"}]},{"id":"mysql索引","title":"MySQL索引","index":"3","children":[{"id":"myisam","title":"MyISAM","index":"3.1","children":[{"id":"非聚簇索引","title":"非聚簇索引","index":"3.1.1"},{"id":"索引结构-1","title":"索引结构","index":"3.1.2"}]},{"id":"innodb","title":"InnoDB","index":"3.2","children":[{"id":"聚簇索引","title":"聚簇索引","index":"3.2.1"},{"id":"索引结构-2","title":"索引结构","index":"3.2.2"}]}]},{"id":"mysql索引操作","title":"MySQL索引操作","index":"4"},{"id":"建立索引","title":"建立索引","index":"5"},{"id":"删除索引","title":"删除索引","index":"6"},{"id":"查看索引","title":"查看索引","index":"7"}]}