{"title":"Redis之哨兵模式","date":"2020-03-02T07:48:21.000Z","date_formatted":{"ll":"Mar 2, 2020","L":"03/02/2020","MM-DD":"03-02"},"thumbnail":"post/中间件/Redis/Redis之哨兵模式/cover.png","link":"post/中间件/Redis/Redis之哨兵模式","categories":["Redis","中间件"],"updated":"2020-03-02T10:26:54.031Z","content":"<h1 id=\"哨兵的作用\">哨兵的作用<a href=\"#哨兵的作用\" title=\"哨兵的作用\"></a></h1><ul><li>监控<ul><li>Master存活检测</li>\n<li>Slave存活检测</li>\n</ul></li>\n<li>通知<ul><li>当被监控的主服务器出现问题时，向其他哨兵，客户端发送通知</li>\n</ul></li>\n<li>自动故障转移<ul><li>断开Master与Slave的连接</li>\n<li>投票选取新的Master</li>\n<li>连接Slave到新的Master</li>\n<li>告知客户端新的服务器地址</li>\n</ul></li>\n</ul><h1 id=\"哨兵搭建\">哨兵搭建<a href=\"#哨兵搭建\" title=\"哨兵搭建\"></a></h1><h2 id=\"配置\">配置<a href=\"#配置\" title=\"配置\"></a></h2><p>redis-sentinel.conf</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 哨兵服务断开</span></span><br><span class=\"line\">port 26379</span><br><span class=\"line\"><span class=\"comment\"># 监控的主机地址 端口 超过几个哨兵认为其宕机时认定为真的宕机</span></span><br><span class=\"line\">sentinel monitor master 192.168.31.201 6379 2</span><br><span class=\"line\"><span class=\"comment\"># 超过多少毫秒无响应时认为其宕机</span></span><br><span class=\"line\">sentinel down-after-milliseconds master 10000</span><br><span class=\"line\"><span class=\"comment\"># 新的Master进行数据同步时并行的Slave同步数量</span></span><br><span class=\"line\">sentinel parallel-syncs master 1</span><br><span class=\"line\"><span class=\"comment\"># 超过多长时间同步算超时</span></span><br><span class=\"line\">sentinel failover-timeout master 180000</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"启动\">启动<a href=\"#启动\" title=\"启动\"></a></h2><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">redis-sentinel redis-sentinal.conf</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"基于docker-compose搭建哨兵模式集群\">基于Docker Compose搭建哨兵模式集群<a href=\"#基于docker-compose搭建哨兵模式集群\" title=\"基于Docker Compose搭建哨兵模式集群\"></a></h1><h2 id=\"配置-1\">配置<a href=\"#配置-1\" title=\"配置\"></a></h2><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">redis-sentinal\\</span><br><span class=\"line\">\tsentinal\\</span><br><span class=\"line\">\t\tDockerfile</span><br><span class=\"line\">\t\tredis-sentinal.conf</span><br><span class=\"line\">\tdocker-compose.yml</span><br></pre></td></tr></table></figure>\n\n<p><strong>Dockerfile</strong></p>\n<p>用于构建redis-sentinal镜像</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">FROM</span> redis:<span class=\"number\">5.0</span>.<span class=\"number\">7</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"bash\"> ./redis-sentinel.conf /usr/<span class=\"built_in\">local</span>/etc/redis-sentinel.conf</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"bash\"> [ <span class=\"string\">\"redis-sentinel\"</span>, <span class=\"string\">\"/usr/local/etc/redis/redis-sentinel.conf\"</span> ]</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>redis-sentinal.conf</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">port 26379</span><br><span class=\"line\">sentinel monitor master redis-master 6379 2</span><br><span class=\"line\">sentinel down-after-milliseconds master 10000</span><br><span class=\"line\">sentinel parallel-syncs master 1</span><br><span class=\"line\">sentinel failover-timeout master 180000</span><br></pre></td></tr></table></figure>\n\n<p><strong>docker-compose.yml</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">\"3\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">redis-mater:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">redis:5.0.7</span></span><br><span class=\"line\">    <span class=\"attr\">expose:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"number\">6379</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"attr\">redis-slave:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">redis:5.0.7</span></span><br><span class=\"line\">    <span class=\"attr\">command:</span> <span class=\"string\">redis-server</span> <span class=\"string\">--replicaof</span> <span class=\"string\">redis-master</span> <span class=\"number\">6379</span></span><br><span class=\"line\">    <span class=\"attr\">depends_on:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">redis-mater</span></span><br><span class=\"line\">    <span class=\"attr\">expose:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"number\">6379</span></span><br><span class=\"line\">    <span class=\"attr\">links:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">redis-mater:redis-master</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">redis-sentinel:</span></span><br><span class=\"line\">    <span class=\"attr\">build:</span> <span class=\"string\">./sentinel</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">redis-sentinel</span></span><br><span class=\"line\">    <span class=\"attr\">depends_on:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">redis-mater</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">redis-slave</span></span><br><span class=\"line\">    <span class=\"attr\">expose:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"number\">26379</span></span><br><span class=\"line\">    <span class=\"attr\">links:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">redis-mater:redis-master</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">networks:</span></span><br><span class=\"line\">  <span class=\"attr\">redis-cluster:</span></span><br><span class=\"line\">    <span class=\"attr\">driver:</span> <span class=\"string\">bridge</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"启动-1\">启动<a href=\"#启动-1\" title=\"启动\"></a></h2><p><strong>启动</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker-compose up -d</span><br></pre></td></tr></table></figure>\n\n<p><strong>扩展</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker-compose scale redis-slave=3 redis-sentinal=3</span><br></pre></td></tr></table></figure>\n\n","prev":{"title":"Redis之常见解决方案","link":"post/中间件/Redis/Redis之常见解决方案"},"next":{"title":"Redis之主从复制","link":"post/中间件/Redis/Redis之主从复制"},"plink":"https://beginc.github.io/post/中间件/Redis/Redis之哨兵模式/","toc":[{"id":"哨兵的作用","title":"哨兵的作用","index":"1"},{"id":"哨兵搭建","title":"哨兵搭建","index":"2","children":[{"id":"配置","title":"配置","index":"2.1"},{"id":"启动","title":"启动","index":"2.2"}]},{"id":"基于docker-compose搭建哨兵模式集群","title":"基于Docker Compose搭建哨兵模式集群","index":"3","children":[{"id":"配置-1","title":"配置","index":"3.1"},{"id":"启动-1","title":"启动","index":"3.2"}]}]}