{"title":"RocketMQ之高可用消息发送","date":"2020-02-27T11:43:36.000Z","date_formatted":{"ll":"Feb 27, 2020","L":"02/27/2020","MM-DD":"02-27"},"thumbnail":"post/中间件/RocketMQ/RocketMQ之高可用消息发送/cover.png","link":"post/中间件/RocketMQ/RocketMQ之高可用消息发送","categories":["RocketMQ","中间件"],"updated":"2020-02-29T16:17:16.812Z","content":"<h1 id=\"消息发送流程\">消息发送流程<a href=\"#消息发送流程\" title=\"消息发送流程\"></a></h1><h2 id=\"验证消息\">验证消息<a href=\"#验证消息\" title=\"验证消息\"></a></h2><ul><li>确保Producer处于运行状态</li>\n<li>确保消息符合规范</li>\n</ul><h2 id=\"查找路由\">查找路由<a href=\"#查找路由\" title=\"查找路由\"></a></h2><p><strong>路由缓存</strong></p>\n<p>Producer本地会缓存查找过的路由信息，当本地缓存存在时，无需向NameServer查找。</p>\n<p><strong>查找路由</strong></p>\n<p>当本地缓存不存在需要查找的路由时，Producer会从NameServer拉取路由信息。</p>\n<h2 id=\"消息发送\">消息发送<a href=\"#消息发送\" title=\"消息发送\"></a></h2><h3 id=\"负载均衡\">负载均衡<a href=\"#负载均衡\" title=\"负载均衡\"></a></h3><p>在对应Topic的多个消息队列中，Producer使用Round-Robin的方式进行队列选择，来实现消息发送的负载均衡。</p>\n<h1 id=\"高可用消息发送\">高可用消息发送<a href=\"#高可用消息发送\" title=\"高可用消息发送\"></a></h1><p>由于NameServer不会主动推送最新的路由信息，所以Producer本地路由信息中可能包含已经宕机的Broker信息，此时需要一定机制来保证高可用的消息发送。</p>\n<h2 id=\"重试机制\">重试机制<a href=\"#重试机制\" title=\"重试机制\"></a></h2><p>当消息发送失败时，Producer会进行retryTimesWhenSendFailed(同步)/retryTimesWhenSendAsyncFailed(异步)次重试。</p>\n<h2 id=\"规避故障broker\">规避故障Broker<a href=\"#规避故障broker\" title=\"规避故障Broker\"></a></h2><p>可通过设置sendLatencyFaultEnable来控制规避模式。</p>\n<h3 id=\"非故障延迟\">非故障延迟<a href=\"#非故障延迟\" title=\"非故障延迟\"></a></h3><p>该模式下，若尝试给一个Broker发送消息失败时，会将其记录下来，在下次重试时，则会跳过该故障Broker的队列，选择其他队列进行消息发送。<strong>但是这种机制只能保证一次消息发送中规避掉故障Broker，在下次发送信息时，还要经历失败---&gt;规避的过程。</strong></p>\n<h3 id=\"故障延迟\">故障延迟<a href=\"#故障延迟\" title=\"故障延迟\"></a></h3><p>该机制下，在发送消息给一个队列之前，会先验证其是否可用（处于可用时间），若不可用，则会获取下一个消息队列。当在某一个Broker处第一次发送消息失败时，会为其<strong>预估出一个故障时间</strong>，在此时间内该Broker都被认为是不可用状态，在下次发送消息时，该Broker的消息队列会通不过可用验证，直接跳过。若当前所有Broker都处于故障时间，则会随机在其中选择一个消息队列进行发送。</p>\n","prev":{"title":"RocketMQ之高性能消息存储","link":"post/中间件/RocketMQ/RocketMQ之高性能消息存储"},"next":{"title":"RocketMQ之NameServer","link":"post/中间件/RocketMQ/RocketMQ之NameServer"},"plink":"https://beginc.github.io/post/中间件/RocketMQ/RocketMQ之高可用消息发送/","toc":[{"id":"消息发送流程","title":"消息发送流程","index":"1","children":[{"id":"验证消息","title":"验证消息","index":"1.1"},{"id":"查找路由","title":"查找路由","index":"1.2"},{"id":"消息发送","title":"消息发送","index":"1.3","children":[{"id":"负载均衡","title":"负载均衡","index":"1.3.1"}]}]},{"id":"高可用消息发送","title":"高可用消息发送","index":"2","children":[{"id":"重试机制","title":"重试机制","index":"2.1"},{"id":"规避故障broker","title":"规避故障Broker","index":"2.2","children":[{"id":"非故障延迟","title":"非故障延迟","index":"2.2.1"},{"id":"故障延迟","title":"故障延迟","index":"2.2.2"}]}]}]}