{"title":"5-Ansible之Jinja2语法","date":"2020-02-07T12:34:09.000Z","date_formatted":{"ll":"Feb 7, 2020","L":"02/07/2020","MM-DD":"02-07"},"thumbnail":"post/自动化运维/Ansible/6-Ansible之Jinja2语法/cover.png","link":"post/自动化运维/Ansible/6-Ansible之Jinja2语法","categories":["Ansible","自动化运维"],"updated":"2020-02-08T02:53:58.099Z","content":"<h1 id=\"变量\">变量<a href=\"#变量\" title=\"变量\"></a></h1><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 直接使用</span></span><br><span class=\"line\">&#123;&#123; var &#125;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 做运算</span></span><br><span class=\"line\">&#123;&#123; var * <span class=\"number\">2</span> &#125;&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"控制结构\">控制结构<a href=\"#控制结构\" title=\"控制结构\"></a></h1><h3 id=\"判断\">判断<a href=\"#判断\" title=\"判断\"></a></h3><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;%<span class=\"keyword\">if</span> var == <span class=\"number\">10</span> %&#125;</span><br><span class=\"line\">    等于<span class=\"number\">10</span></span><br><span class=\"line\">&#123;% <span class=\"keyword\">else</span> %&#125;</span><br><span class=\"line\">    不等于<span class=\"number\">10</span></span><br><span class=\"line\">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>去除前导空字符</strong></p>\n<p>使用<code>-</code>去除前导空字符</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;%- <span class=\"keyword\">if</span> var == <span class=\"number\">10</span> -%&#125;</span><br><span class=\"line\">    等于<span class=\"number\">10</span></span><br><span class=\"line\">&#123;%- <span class=\"keyword\">else</span> -%&#125;</span><br><span class=\"line\">    不等于<span class=\"number\">10</span></span><br><span class=\"line\">&#123;%- endif -%&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"循环\">循环<a href=\"#循环\" title=\"循环\"></a></h2><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(var) %&#125;</span><br><span class=\"line\">    &#123;&#123; i &#125;&#125;</span><br><span class=\"line\">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"过滤器\">过滤器<a href=\"#过滤器\" title=\"过滤器\"></a></h1><p>使用过滤器可对变量或常量做一些处理。使用管道符<code>|</code>进行传递。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Abc</span></span><br><span class=\"line\">&#123;&#123; <span class=\"string\">\"abc\"</span> | capitalize   &#125;&#125;</span><br><span class=\"line\"><span class=\"comment\"># 1</span></span><br><span class=\"line\">&#123;&#123; [<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>] | first &#125;&#125;</span><br><span class=\"line\"><span class=\"comment\"># 12</span></span><br><span class=\"line\">&#123;&#123; <span class=\"string\">\"12\"</span> | int &#125;&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>Ansible</code>中所有的过滤器见<a href=\"https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html#regular-expression-filters\" target=\"_blank\">Filter</a>。</p>\n<h1 id=\"测试\">测试<a href=\"#测试\" title=\"测试\"></a></h1><p>过滤器会对变量做一些处理后返回，而测试主要是进行一些判断，返回布尔值。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># True</span></span><br><span class=\"line\">&#123;&#123; <span class=\"number\">1</span> <span class=\"keyword\">is</span> eq <span class=\"number\">1</span> &#125;&#125;</span><br><span class=\"line\"><span class=\"comment\"># False</span></span><br><span class=\"line\">&#123;&#123; var <span class=\"keyword\">is</span> defined &#125;&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>Ansible</code>中所有的测试见<a href=\"https://docs.ansible.com/ansible/latest/user_guide/playbooks_tests.html\" target=\"_blank\">Test</a>。</p>\n<h1 id=\"ansible之when\">Ansible之When<a href=\"#ansible之when\" title=\"Ansible之When\"></a></h1><p>在<code>when</code>中我们可以使用<code>Jinja2</code>语法进行模板书写，但是要注意的是，我们引用变量不用写<code>{{}}</code>。通常我们可以搭配<code>register</code>注册变量进行使用。<code>register</code>将命令的返回值存储到注册的变量当中。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">check</span> <span class=\"string\">if</span> <span class=\"string\">$ROCKET_HOME</span> <span class=\"string\">exists</span></span><br><span class=\"line\">  <span class=\"attr\">shell:</span> <span class=\"string\">cat</span> <span class=\"string\">/etc/bashrc</span></span><br><span class=\"line\">  <span class=\"attr\">register:</span> <span class=\"string\">bashrc</span></span><br><span class=\"line\">  <span class=\"attr\">changed_when:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">append</span> <span class=\"string\">$ROCKET_HOME</span></span><br><span class=\"line\">  <span class=\"attr\">shell:</span> <span class=\"string\">echo</span> <span class=\"string\">ROCKET_HOME=/usr/local/&#123;&#123;</span> <span class=\"string\">unarchive_filename</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">&gt;&gt;</span> <span class=\"string\">/etc/bashrc;</span> <span class=\"string\">echo</span> <span class=\"string\">PATH='$PATH:$ROCKET_HOME'/bin</span> <span class=\"string\">&gt;&gt;</span> <span class=\"string\">/etc/bashrc</span></span><br><span class=\"line\">  <span class=\"attr\">when:</span> <span class=\"string\">not</span> <span class=\"string\">bashrc.stdout</span> <span class=\"string\">is</span> <span class=\"string\">search(\"ROCKET_HOME\")</span></span><br></pre></td></tr></table></figure>\n\n","prev":{"title":"6-Ansible常用Playbook关键字","link":"post/自动化运维/Ansible/7-Ansible常用Playbook关键字"},"next":{"title":"4-Ansible之导入","link":"post/自动化运维/Ansible/5-Ansible之导入"},"plink":"https://beginc.github.io/post/自动化运维/Ansible/6-Ansible之Jinja2语法/","toc":[{"id":"变量","title":"变量","index":"1"},{"id":"控制结构","title":"控制结构","index":"2","children":[{"id":"判断","title":"判断","index":"2.1"}]},{"id":"循环","title":"循环","index":"3"}]}