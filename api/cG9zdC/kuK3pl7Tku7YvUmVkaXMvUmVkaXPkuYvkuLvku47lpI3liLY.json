{"title":"Redis之主从复制","date":"2020-03-01T15:18:37.000Z","date_formatted":{"ll":"Mar 1, 2020","L":"03/01/2020","MM-DD":"03-01"},"thumbnail":"post/中间件/Redis/Redis之主从复制/cover.png","link":"post/中间件/Redis/Redis之主从复制","categories":["Redis","中间件"],"updated":"2020-03-02T10:25:26.336Z","content":"<h1 id=\"主从复制的作用\">主从复制的作用<a href=\"#主从复制的作用\" title=\"主从复制的作用\"></a></h1><ul><li>读写分离</li>\n<li>负载均衡</li>\n<li>故障恢复</li>\n<li>数据备份</li>\n</ul><h1 id=\"主从复制流程\">主从复制流程<a href=\"#主从复制流程\" title=\"主从复制流程\"></a></h1><h2 id=\"建立连接阶段\">建立连接阶段<a href=\"#建立连接阶段\" title=\"建立连接阶段\"></a></h2><h3 id=\"slave\">Slave<a href=\"#slave\" title=\"Slave\"></a></h3><h4 id=\"连接\">连接<a href=\"#连接\" title=\"连接\"></a></h4><p><strong>方式一：命令</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">slaveof &lt;masterIP&gt; &lt;masterPort&gt;</span><br></pre></td></tr></table></figure>\n\n<p><strong>方式二：启动参数</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">redis-server --replicaof &lt;masterIP&gt; &lt;masterPort&gt;</span><br></pre></td></tr></table></figure>\n\n<p><strong>方式三：配置</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">replicaof &lt;masterIP&gt; &lt;masterPort&gt;</span><br><span class=\"line\"><span class=\"comment\"># slave只读</span></span><br><span class=\"line\">replica-read-only yes</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"认证\">认证<a href=\"#认证\" title=\"认证\"></a></h4><p><strong>配置</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">masterauth &lt;password&gt;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"数据同步阶段\">数据同步阶段<a href=\"#数据同步阶段\" title=\"数据同步阶段\"></a></h2><h3 id=\"全量复制\">全量复制<a href=\"#全量复制\" title=\"全量复制\"></a></h3><p>第一次主从同步时发生的是全量复制</p>\n<ul><li>Master生成RDB文件发送给Slave</li>\n<li>Slave接收RDB文件，清空数据库，执行RDB数据恢复</li>\n</ul><h3 id=\"增量复制\">增量复制<a href=\"#增量复制\" title=\"增量复制\"></a></h3><p>全量复制时，Master还会建立一个复制积压缓冲区（AOF），记录发送到Master的写指令，在全量复制后</p>\n<ul><li>Master会将复制积压缓冲区的数据发送给Slave</li>\n<li>Slave收到后会执行bgrewriteaof进行AOF重写，然后增量恢复数据</li>\n</ul><img src=\"/post/%E4%B8%AD%E9%97%B4%E4%BB%B6/Redis/Redis%E4%B9%8B%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/image-20200302000949427.png\" class=\"\">\n\n<h4 id=\"复制积压缓冲区\">复制积压缓冲区<a href=\"#复制积压缓冲区\" title=\"复制积压缓冲区\"></a></h4><ul><li>将写指令转换成AOF的格式放入复制缓冲缓冲区</li>\n<li>使用offset来区分不同的Slave当前同步的进度<ul><li>Master需要存Slave的offset</li>\n<li>Slave需要存自己的offset</li>\n<li><strong>双方都存offset是为了在出现网络异常时进行offset同步</strong></li>\n</ul></li>\n<li><strong>当超过复制积压缓冲区大小时，会丢弃队头指令</strong></li>\n</ul><img src=\"/post/%E4%B8%AD%E9%97%B4%E4%BB%B6/Redis/Redis%E4%B9%8B%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/image-20200302152955986.png\" class=\"\">\n\n<h2 id=\"命令传播阶段\">命令传播阶段<a href=\"#命令传播阶段\" title=\"命令传播阶段\"></a></h2><p>当Master收到写指令时</p>\n<ul><li>使用命令传播程序将指令分发到所有的Slave</li>\n<li>将写指令存入复制积压缓冲区（备份）</li>\n</ul><p><strong>网络异常</strong></p>\n<ul><li>若短暂超时重连，则此时Slave发过来的offset对应的数据可能还在复制缓冲区中，此时<strong>执行部分复制</strong></li>\n<li>若长时间断线后重连，则此时Slave发过来的offset对应的数据可能已经出队，此时<strong>执行全量复制</strong></li>\n</ul><img src=\"/post/%E4%B8%AD%E9%97%B4%E4%BB%B6/Redis/Redis%E4%B9%8B%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/image-20200302153401728.png\" class=\"\">\n\n<img src=\"/post/%E4%B8%AD%E9%97%B4%E4%BB%B6/Redis/Redis%E4%B9%8B%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/image-20200302153227263.png\" class=\"\">\n\n<h1 id=\"主从复制配置\">主从复制配置<a href=\"#主从复制配置\" title=\"主从复制配置\"></a></h1><h2 id=\"slave-1\">Slave<a href=\"#slave-1\" title=\"Slave\"></a></h2><div class=\"cz\"><div class=\"db\"><table><thead><tr>\n<th>配置</th><th>功能</th></tr>\n</thead><tbody><tr>\n<td>replicaof <masterIP> <masterPort></td><td>配置主服务器</td></tr>\n<tr>\n<td>replica-read-only yes</td><td>从机是否只读</td></tr>\n<tr>\n<td>replica-serve-stale-data yes</td><td>在复制未完成或者与主机失去连接时是否还提供读服务</td></tr>\n</tbody></table></div></div><h2 id=\"master\">Master<a href=\"#master\" title=\"Master\"></a></h2><div class=\"cz\"><div class=\"db\"><table><thead><tr>\n<th>配置</th><th>功能</th></tr>\n</thead><tbody><tr>\n<td>repl-backlog-size 1mb</td><td>复制积压缓冲区大小</td></tr>\n<tr>\n<td>min-replicas-to-write 2</td><td>当Slave多数掉线，数量小于该值时，Master写功能关闭，拒绝信息同步</td></tr>\n<tr>\n<td>min-replicas-max-lag 8</td><td>当所有Slave延迟大于8秒时，Master写功能关闭，拒绝信息同步</td></tr>\n</tbody></table></div></div>","prev":{"title":"Redis之哨兵模式","link":"post/中间件/Redis/Redis之哨兵模式"},"next":{"title":"Redis之持久化","link":"post/中间件/Redis/Redis之持久化"},"plink":"https://beginc.github.io/post/中间件/Redis/Redis之主从复制/","toc":[{"id":"主从复制的作用","title":"主从复制的作用","index":"1"},{"id":"主从复制流程","title":"主从复制流程","index":"2","children":[{"id":"建立连接阶段","title":"建立连接阶段","index":"2.1","children":[{"id":"slave","title":"Slave","index":"2.1.1"}]},{"id":"数据同步阶段","title":"数据同步阶段","index":"2.2","children":[{"id":"全量复制","title":"全量复制","index":"2.2.1"},{"id":"增量复制","title":"增量复制","index":"2.2.2"}]},{"id":"命令传播阶段","title":"命令传播阶段","index":"2.3"}]},{"id":"主从复制配置","title":"主从复制配置","index":"3","children":[{"id":"slave-1","title":"Slave","index":"3.1"},{"id":"master","title":"Master","index":"3.2"}]}]}