{"title":"TCP三次握手四次挥手","date":"2020-02-28T04:23:24.000Z","date_formatted":{"ll":"Feb 28, 2020","L":"02/28/2020","MM-DD":"02-28"},"thumbnail":"post/计算机网络/TCP三次握手四次挥手/cover.jpg","link":"post/计算机网络/TCP三次握手四次挥手","categories":["计算机网络"],"updated":"2020-02-29T16:14:27.926Z","content":"<h1 id=\"三次握手\">三次握手<a href=\"#三次握手\" title=\"三次握手\"></a></h1><h2 id=\"tcp建立连接的作用\">TCP建立连接的作用<a href=\"#tcp建立连接的作用\" title=\"TCP建立连接的作用\"></a></h2><p>TCP基于网络层IP协议，IP协议只提供点到点的首部校验，并未对数据部分承诺可靠传输，因此TCP需要实现端到端的可靠传输。TCP实现可靠传输的核心就是：</p>\n<ul><li>序号：表示当前传输的报文段第一个字节的编号</li>\n<li>确认号：表示确认收到了确认号之前的所有字节（累积确认）</li>\n</ul><p>通过这两个字段，在收到报文时就可确认报文是否合法，因此在建立连接时的任务就是要确认通信双方的<strong>初始序号大小</strong>。</p>\n<h2 id=\"三次握手过程\">三次握手过程<a href=\"#三次握手过程\" title=\"三次握手过程\"></a></h2><img src=\"/post/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B/image-20200228132045224.png\" class=\"\">\n\n<h2 id=\"为何需要三次握手\">为何需要三次握手<a href=\"#为何需要三次握手\" title=\"为何需要三次握手\"></a></h2><ol><li>如果要双方都确认对方的初始序号，那么至少需要一来一回两次通信</li>\n</ol><ul><li>Client: SYN + 客户端初始序号x</li>\n<li>Server：SYN  + ACK + 服务端初始序号y + 对客户端的确认号x + 1（确认收到了客户端的初始序号）</li>\n</ul><ol><li>为何需要第三次：由于底层IP协议不提供可靠传输，因此服务端发送给客户端的初始序号报文可能丢失，因此客户端必须收到后给予服务端一个ACK确认报文</li>\n</ol><h2 id=\"异常情况\">异常情况<a href=\"#异常情况\" title=\"异常情况\"></a></h2><p><strong>第一次握手包丢失</strong></p>\n<p>客户端收不到服务端的ACK确认报文，会不断超时重传</p>\n<p><strong>第二次握手包丢失</strong></p>\n<p>服务端收不到客户端的ACK确认报文，会不断超时重传</p>\n<p><strong>第三次握手包丢失</strong></p>\n<p>客户端收到ACK后，已经进入了Established状态</p>\n<ul><li>客户端不发送数据：服务端会超时重传第二次握手包</li>\n<li>客户端发送数据：会带上ACK和数据，服务端收到确认后进入Established状态</li>\n<li>服务端没有收到确认，无法发送数据，定时超时重传第二次握手包</li>\n</ul><h1 id=\"四次挥手\">四次挥手<a href=\"#四次挥手\" title=\"四次挥手\"></a></h1><h2 id=\"tcp拆除连接的作用\">TCP拆除连接的作用<a href=\"#tcp拆除连接的作用\" title=\"TCP拆除连接的作用\"></a></h2><p>很显然，是用于告诉对方结束发送数据。</p>\n<h2 id=\"四次挥手过程\">四次挥手过程<a href=\"#四次挥手过程\" title=\"四次挥手过程\"></a></h2><img src=\"/post/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B/image-20200228133205489.png\" class=\"\">\n\n<h2 id=\"为何需要四次挥手\">为何需要四次挥手<a href=\"#为何需要四次挥手\" title=\"为何需要四次挥手\"></a></h2><ol><li>第一次：A告诉B我发送完毕了</li>\n<li>第二次：B告诉A，收到</li>\n<li>第三次：由于A单方面告诉B结束发送数据，但是B可能还有数据未发送完成，此时他会继续发送数据直到发送完毕，<strong>此时B需要通知A我已经发送完毕了，连接可以完全拆除</strong></li>\n<li>第四次：相同的原因，底层网络不可靠，A需要给B发送ACK确认报文</li>\n</ol><h2 id=\"异常情况-1\">异常情况<a href=\"#异常情况-1\" title=\"异常情况\"></a></h2><p><strong>第一次挥手包丢失</strong></p>\n<p>A会超时重传</p>\n<p><strong>第二次挥手包丢失</strong></p>\n<p>B会在后续发送数据，或者第三次挥手时发送ACK确认</p>\n<p><strong>第三次挥手包丢失</strong></p>\n<p>B会超时重传</p>\n<p><strong>第四次挥手包丢失</strong></p>\n<p>B会重发第三次挥手包，直到收到确认</p>\n<h1 id=\"参考\">参考<a href=\"#参考\" title=\"参考\"></a></h1><ol><li><a href=\"https://www.zhihu.com/question/24853633/answer/115173386\" target=\"_blank\">TCP 为什么是三次握手，而不是两次或四次？</a></li>\n</ol>","prev":{"title":"TCP状态转换","link":"post/计算机网络/TCP状态转换"},"next":{"title":"Java之NIO","link":"post/Java/Java语言/Java之NIO"},"plink":"https://beginc.github.io/post/计算机网络/TCP三次握手四次挥手/","toc":[{"id":"三次握手","title":"三次握手","index":"1","children":[{"id":"tcp建立连接的作用","title":"TCP建立连接的作用","index":"1.1"},{"id":"三次握手过程","title":"三次握手过程","index":"1.2"},{"id":"为何需要三次握手","title":"为何需要三次握手","index":"1.3"},{"id":"异常情况","title":"异常情况","index":"1.4"}]},{"id":"四次挥手","title":"四次挥手","index":"2","children":[{"id":"tcp拆除连接的作用","title":"TCP拆除连接的作用","index":"2.1"},{"id":"四次挥手过程","title":"四次挥手过程","index":"2.2"},{"id":"为何需要四次挥手","title":"为何需要四次挥手","index":"2.3"},{"id":"异常情况-1","title":"异常情况","index":"2.4"}]},{"id":"参考","title":"参考","index":"3"}]}