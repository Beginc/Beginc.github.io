{"title":"RocketMQ集群搭建","date":"2020-02-24T11:50:46.000Z","date_formatted":{"ll":"Feb 24, 2020","L":"02/24/2020","MM-DD":"02-24"},"thumbnail":"post/中间件/RocketMQ/RocketMQ集群搭建/cover.png","link":"post/中间件/RocketMQ/RocketMQ集群搭建","categories":["RocketMQ","中间件"],"updated":"2020-02-29T16:17:12.687Z","content":"<h1 id=\"环境\">环境<a href=\"#环境\" title=\"环境\"></a></h1><h2 id=\"节点\">节点<a href=\"#节点\" title=\"节点\"></a></h2><p>使用两台CentOS7的虚拟机来部署双Name Server + 双主双从Broker</p>\n<p><strong>Name Server</strong></p>\n<ul><li>192.168.31.101</li>\n<li>192.168.31.102</li>\n</ul><p><strong>Broker Master</strong></p>\n<ul><li>192.168.31.103</li>\n</ul><p><strong>Broker Slave</strong></p>\n<ul><li>192.168.31.104</li>\n</ul><p><strong>防火墙</strong></p>\n<p>这里选择直接将防火墙关闭</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl stop firewalld.service</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"软件\">软件<a href=\"#软件\" title=\"软件\"></a></h2><ul><li>JDK1.8</li>\n</ul><h1 id=\"nameserver集群\">NameServer集群<a href=\"#nameserver集群\" title=\"NameServer集群\"></a></h1><h2 id=\"文件准备\">文件准备<a href=\"#文件准备\" title=\"文件准备\"></a></h2><ol><li>下载<a href=\"http://apache.website-solution.net/rocketmq/4.6.1/rocketmq-all-4.6.1-bin-release.zip\" target=\"_blank\">rocketmq-all-4.6.1-bin-release.zip</a></li>\n<li>解压到/usr/local/</li>\n</ol><img src=\"/post/%E4%B8%AD%E9%97%B4%E4%BB%B6/RocketMQ/RocketMQ%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/image-20200224211316778.png\" class=\"\">\n\n<h2 id=\"启动\">启动<a href=\"#启动\" title=\"启动\"></a></h2><p><strong>192.168.31.101</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/rocketmq-all-4.6.0-bin-release/bin/</span><br><span class=\"line\">nohup ./mqnamesrv &gt; /dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>\n\n<p><strong>192.168.31.102</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/rocketmq-all-4.6.0-bin-release/bin/</span><br><span class=\"line\">nohup ./mqnamesrv &gt; /dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"broker集群\">Broker集群<a href=\"#broker集群\" title=\"Broker集群\"></a></h1><h2 id=\"文件准备-1\">文件准备<a href=\"#文件准备-1\" title=\"文件准备\"></a></h2><ol><li>下载<a href=\"http://apache.website-solution.net/rocketmq/4.6.1/rocketmq-all-4.6.1-bin-release.zip\" target=\"_blank\">rocketmq-all-4.6.1-bin-release.zip</a></li>\n<li>解压到/usr/local/</li>\n</ol><img src=\"/post/%E4%B8%AD%E9%97%B4%E4%BB%B6/RocketMQ/RocketMQ%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/image-20200224211316778.png\" class=\"\">\n\n<h2 id=\"配置文件\">配置文件<a href=\"#配置文件\" title=\"配置文件\"></a></h2><h3 id=\"master\">Master<a href=\"#master\" title=\"Master\"></a></h3><p><strong>配置文件</strong></p>\n<p>/usr/local/rocketmq-all-4.6.0-bin-release/conf/myconf/broker-0.properties</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 集群名字</span></span><br><span class=\"line\"><span class=\"attr\">brokerClusterName</span>=cluster</span><br><span class=\"line\"><span class=\"comment\"># broker名称，相同名称的broker为一组</span></span><br><span class=\"line\"><span class=\"comment\">#\t- brokerId == 0 ---&gt; Master</span></span><br><span class=\"line\"><span class=\"comment\">#\t- brokerId &gt; 0  ---&gt; Slave</span></span><br><span class=\"line\"><span class=\"attr\">brokerName</span>=brokera</span><br><span class=\"line\"><span class=\"attr\">brokerId</span>=<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"comment\"># NameServer</span></span><br><span class=\"line\"><span class=\"attr\">namesrvAddr</span>=<span class=\"number\">192.168</span>.<span class=\"number\">31.101</span>:<span class=\"number\">9876</span><span class=\"comment\">;192.168.31.102:9876</span></span><br><span class=\"line\"><span class=\"comment\"># 每个Topic对应的消息队列的数量</span></span><br><span class=\"line\"><span class=\"attr\">defaultTopicQueueNums</span>=<span class=\"number\">4</span></span><br><span class=\"line\"><span class=\"comment\"># 是否自动创建Topic</span></span><br><span class=\"line\"><span class=\"attr\">autoCreateTopicEnable</span>=<span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"comment\"># 是否自动创建订阅组</span></span><br><span class=\"line\"><span class=\"attr\">autoCreateSubscriptionGroup</span>=<span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"comment\"># 监听端口</span></span><br><span class=\"line\"><span class=\"attr\">listenPort</span>=<span class=\"number\">10911</span></span><br><span class=\"line\"><span class=\"comment\"># 何时删除文件</span></span><br><span class=\"line\"><span class=\"attr\">deleteWhen</span>=<span class=\"number\">4</span></span><br><span class=\"line\"><span class=\"comment\"># 消息保留时间（小时）</span></span><br><span class=\"line\"><span class=\"attr\">fileReservedTime</span>=<span class=\"number\">120</span></span><br><span class=\"line\"><span class=\"comment\"># 单个commitLog文件大小</span></span><br><span class=\"line\"><span class=\"attr\">mapedFileSizeCommitLog</span>=<span class=\"number\">1073741824</span></span><br><span class=\"line\"><span class=\"comment\"># 单个ConsumeQueue文件大小</span></span><br><span class=\"line\"><span class=\"attr\">mapedFileSizeConsumeQueue</span>=<span class=\"number\">300000</span></span><br><span class=\"line\"><span class=\"comment\"># 超过该磁盘使用比例，触发过期文件删除</span></span><br><span class=\"line\"><span class=\"attr\">diskMaxUsedSpaceRatio</span>=<span class=\"number\">88</span></span><br><span class=\"line\"><span class=\"attr\">storePathRootDir</span>=/usr/local/rocketmq-all-<span class=\"number\">4.6</span>.<span class=\"number\">0</span>-bin-release/store</span><br><span class=\"line\"><span class=\"attr\">storePathCommitLog</span>=/usr/local/rocketmq-all-<span class=\"number\">4.6</span>.<span class=\"number\">0</span>-bin-release/store/commitlog</span><br><span class=\"line\"><span class=\"attr\">storePathConsumeQueue</span>=/usr/local/rocketmq-all-<span class=\"number\">4.6</span>.<span class=\"number\">0</span>-bin-release/store/consumequeue</span><br><span class=\"line\"><span class=\"attr\">storePathIndex</span>=/usr/local/rocketmq-all-<span class=\"number\">4.6</span>.<span class=\"number\">0</span>-bin-release/store/index</span><br><span class=\"line\"><span class=\"attr\">storeCheckpoint</span>=/usr/local/rocketmq-all-<span class=\"number\">4.6</span>.<span class=\"number\">0</span>-bin-release/store/checkpoint</span><br><span class=\"line\"><span class=\"attr\">abortFile</span>=/usr/local/rocketmq-all-<span class=\"number\">4.6</span>.<span class=\"number\">0</span>-bin-release/store/abort</span><br><span class=\"line\"><span class=\"comment\"># 最大消息大小</span></span><br><span class=\"line\"><span class=\"attr\">maxMessageSize</span>=<span class=\"number\">65536</span></span><br><span class=\"line\"><span class=\"comment\"># 同步主从架构的Master</span></span><br><span class=\"line\"><span class=\"attr\">brokerRole</span>=SYNC_MASTER</span><br><span class=\"line\"><span class=\"comment\"># 同步刷盘</span></span><br><span class=\"line\"><span class=\"attr\">flushDiskType</span>=SYNC_FLUSH</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"slave\">Slave<a href=\"#slave\" title=\"Slave\"></a></h3><p>/usr/local/rocketmq-all-4.6.0-bin-release/conf/myconf/broker-1.properties</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 集群名字</span></span><br><span class=\"line\"><span class=\"attr\">brokerClusterName</span>=cluster</span><br><span class=\"line\"><span class=\"comment\"># broker名称，相同名称的broker为一组</span></span><br><span class=\"line\"><span class=\"comment\">#\t- brokerId == 0 ---&gt; Master</span></span><br><span class=\"line\"><span class=\"comment\">#\t- brokerId &gt; 0  ---&gt; Slave</span></span><br><span class=\"line\"><span class=\"attr\">brokerName</span>=brokera</span><br><span class=\"line\"><span class=\"attr\">brokerId</span>=<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"comment\"># NameServer</span></span><br><span class=\"line\"><span class=\"attr\">namesrvAddr</span>=<span class=\"number\">192.168</span>.<span class=\"number\">31.101</span>:<span class=\"number\">9876</span><span class=\"comment\">;192.168.31.102:9876</span></span><br><span class=\"line\"><span class=\"comment\"># 每个Topic对应的消息队列的数量</span></span><br><span class=\"line\"><span class=\"attr\">defaultTopicQueueNums</span>=<span class=\"number\">4</span></span><br><span class=\"line\"><span class=\"comment\"># 是否自动创建Topic</span></span><br><span class=\"line\"><span class=\"attr\">autoCreateTopicEnable</span>=<span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"comment\"># 是否自动创建订阅组</span></span><br><span class=\"line\"><span class=\"attr\">autoCreateSubscriptionGroup</span>=<span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"comment\"># 监听端口</span></span><br><span class=\"line\"><span class=\"attr\">listenPort</span>=<span class=\"number\">10911</span></span><br><span class=\"line\"><span class=\"comment\"># 何时删除文件</span></span><br><span class=\"line\"><span class=\"attr\">deleteWhen</span>=<span class=\"number\">4</span></span><br><span class=\"line\"><span class=\"comment\"># 消息保留时间（小时）</span></span><br><span class=\"line\"><span class=\"attr\">fileReservedTime</span>=<span class=\"number\">120</span></span><br><span class=\"line\"><span class=\"comment\"># 单个commitLog文件大小</span></span><br><span class=\"line\"><span class=\"attr\">mapedFileSizeCommitLog</span>=<span class=\"number\">1073741824</span></span><br><span class=\"line\"><span class=\"comment\"># 单个ConsumeQueue文件大小</span></span><br><span class=\"line\"><span class=\"attr\">mapedFileSizeConsumeQueue</span>=<span class=\"number\">300000</span></span><br><span class=\"line\"><span class=\"comment\"># 超过该磁盘使用比例，触发过期文件删除</span></span><br><span class=\"line\"><span class=\"attr\">diskMaxUsedSpaceRatio</span>=<span class=\"number\">88</span></span><br><span class=\"line\"><span class=\"attr\">storePathRootDir</span>=/usr/local/rocketmq-all-<span class=\"number\">4.6</span>.<span class=\"number\">0</span>-bin-release/store</span><br><span class=\"line\"><span class=\"attr\">storePathCommitLog</span>=/usr/local/rocketmq-all-<span class=\"number\">4.6</span>.<span class=\"number\">0</span>-bin-release/store/commitlog</span><br><span class=\"line\"><span class=\"attr\">storePathConsumeQueue</span>=/usr/local/rocketmq-all-<span class=\"number\">4.6</span>.<span class=\"number\">0</span>-bin-release/store/consumequeue</span><br><span class=\"line\"><span class=\"attr\">storePathIndex</span>=/usr/local/rocketmq-all-<span class=\"number\">4.6</span>.<span class=\"number\">0</span>-bin-release/store/index</span><br><span class=\"line\"><span class=\"attr\">storeCheckpoint</span>=/usr/local/rocketmq-all-<span class=\"number\">4.6</span>.<span class=\"number\">0</span>-bin-release/store/checkpoint</span><br><span class=\"line\"><span class=\"attr\">abortFile</span>=/usr/local/rocketmq-all-<span class=\"number\">4.6</span>.<span class=\"number\">0</span>-bin-release/store/abort</span><br><span class=\"line\"><span class=\"comment\"># 最大消息大小</span></span><br><span class=\"line\"><span class=\"attr\">maxMessageSize</span>=<span class=\"number\">65536</span></span><br><span class=\"line\"><span class=\"comment\"># 同步主从架构的Master</span></span><br><span class=\"line\"><span class=\"attr\">brokerRole</span>=SLAVE</span><br><span class=\"line\"><span class=\"comment\"># 同步刷盘</span></span><br><span class=\"line\"><span class=\"attr\">flushDiskType</span>=SYNC_FLUSH</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"启动-1\">启动<a href=\"#启动-1\" title=\"启动\"></a></h2><p><strong>Master</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/rocketmq-all-4.6.0-bin-release/bin/</span><br><span class=\"line\">nohup ./mqbroker -c /usr/<span class=\"built_in\">local</span>/rocketmq-all-4.6.0-bin-release/conf/myconf/broker-0.properties &gt; /dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>\n\n<p><strong>Slave</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/rocketmq-all-4.6.0-bin-release/bin/</span><br><span class=\"line\">nohup ./mqbroker -c /usr/<span class=\"built_in\">local</span>/rocketmq-all-4.6.0-bin-release/conf/myconf/broker-1.properties &gt; /dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"监控平台\">监控平台<a href=\"#监控平台\" title=\"监控平台\"></a></h1><p>TODO</p>\n","prev":{"title":"RocketMQ各种消息","link":"post/中间件/RocketMQ/RocketMQ各种消息"},"next":{"title":"消息队列应用","link":"post/中间件/RocketMQ/消息队列应用"},"plink":"https://beginc.github.io/post/中间件/RocketMQ/RocketMQ集群搭建/","toc":[{"id":"环境","title":"环境","index":"1","children":[{"id":"节点","title":"节点","index":"1.1"},{"id":"软件","title":"软件","index":"1.2"}]},{"id":"nameserver集群","title":"NameServer集群","index":"2","children":[{"id":"文件准备","title":"文件准备","index":"2.1"},{"id":"启动","title":"启动","index":"2.2"}]},{"id":"broker集群","title":"Broker集群","index":"3","children":[{"id":"文件准备-1","title":"文件准备","index":"3.1"},{"id":"配置文件","title":"配置文件","index":"3.2","children":[{"id":"master","title":"Master","index":"3.2.1"},{"id":"slave","title":"Slave","index":"3.2.2"}]},{"id":"启动-1","title":"启动","index":"3.3"}]},{"id":"监控平台","title":"监控平台","index":"4"}]}