{"title":"4-Ansible之导入","date":"2020-02-07T11:57:43.000Z","date_formatted":{"ll":"Feb 7, 2020","L":"02/07/2020","MM-DD":"02-07"},"thumbnail":"post/自动化运维/Ansible/5-Ansible之导入/cover.png","link":"post/自动化运维/Ansible/5-Ansible之导入","categories":["Ansible","自动化运维"],"updated":"2020-02-08T02:53:55.231Z","content":"<h1 id=\"ansible复用\">Ansible复用<a href=\"#ansible复用\" title=\"Ansible复用\"></a></h1><p>在<code>ansible</code>中，<code>task</code>, <code>var</code>, <code>handler</code>到<code>playbook</code>和<code>role</code>都是可以进行复用的，因此我们需要类似于<code>Java</code>中<code>import</code>的机制来对复用组件进行导入。</p>\n<h1 id=\"动态导入与静态导入\">动态导入与静态导入<a href=\"#动态导入与静态导入\" title=\"动态导入与静态导入\"></a></h1><p>在<code>Ansible</code>中<code>include_*</code>为动态导入，<code>import_*</code>为静态导入。</p>\n<p><strong>区别</strong></p>\n<ul><li>静态导入相当于<code>C</code>语言中的预处理，它在解析<code>Playbook</code>时进行处理，而不是在运行时。</li>\n<li>动态导入在运行时进行处理时才进行导入。</li>\n<li>在使用<code>when</code>对<code>include_*</code>和<code>import_*</code>处理时，行为有些许不同。</li>\n</ul><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># common_tasks.yml</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">placeholder</span> <span class=\"string\">foo</span></span><br><span class=\"line\">  <span class=\"attr\">command:</span> <span class=\"string\">/bin/foo</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">placeholder</span> <span class=\"string\">bar</span></span><br><span class=\"line\">  <span class=\"attr\">command:</span> <span class=\"string\">/bin/bar</span></span><br></pre></td></tr></table></figure>\n\n<ol><li><code>import_tasks</code>静态导入。</li>\n</ol><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># main.yml</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">import_tasks:</span> <span class=\"string\">other_tasks.yml</span></span><br><span class=\"line\">  <span class=\"attr\">when:</span> <span class=\"string\">x</span> <span class=\"string\">is</span> <span class=\"string\">not</span> <span class=\"string\">defined</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\"># other_tasks.yml</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">set_fact:</span></span><br><span class=\"line\">    <span class=\"attr\">x:</span> <span class=\"string\">foo</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">debug:</span></span><br><span class=\"line\">    <span class=\"attr\">var:</span> <span class=\"string\">x</span></span><br></pre></td></tr></table></figure>\n\n<p>在预处理后相当于给<code>other_tasks.yml</code>中的每一个<code>task</code>都加上了<code>when</code>语句，造成只有一个任务执行了，不符合我们的预期。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 该任务会执行，因为初始情况下x未定义</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">set_fact:</span></span><br><span class=\"line\">    <span class=\"attr\">x:</span> <span class=\"string\">foo</span></span><br><span class=\"line\">  <span class=\"attr\">when:</span> <span class=\"string\">x</span> <span class=\"string\">is</span> <span class=\"string\">not</span> <span class=\"string\">defined</span></span><br><span class=\"line\"><span class=\"comment\"># 该任务不会执行，因为执行了上面的任务后，x已经定义了</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">debug:</span></span><br><span class=\"line\">    <span class=\"attr\">var:</span> <span class=\"string\">x</span></span><br><span class=\"line\">  <span class=\"attr\">when:</span> <span class=\"string\">x</span> <span class=\"string\">is</span> <span class=\"string\">not</span> <span class=\"string\">defined</span></span><br></pre></td></tr></table></figure>\n\n<ol><li><code>include_tasks</code>动态导入</li>\n</ol><p>该处的<code>when</code>只控制导入的这个行为是否发生，因此第一个任务和第二个任务都会得到执行。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># main.yml</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">include_tasks:</span> <span class=\"string\">other_tasks.yml</span></span><br><span class=\"line\">  <span class=\"attr\">when:</span> <span class=\"string\">x</span> <span class=\"string\">is</span> <span class=\"string\">not</span> <span class=\"string\">defined</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\"># other_tasks.yml</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">set_fact:</span></span><br><span class=\"line\">    <span class=\"attr\">x:</span> <span class=\"string\">foo</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">debug:</span></span><br><span class=\"line\">    <span class=\"attr\">var:</span> <span class=\"string\">x</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"各种导入\">各种导入<a href=\"#各种导入\" title=\"各种导入\"></a></h1><h2 id=\"include_\">include_*<a href=\"#include_\" title=\"include_*\"></a></h2><h3 id=\"include_tasks\">include_tasks<a href=\"#include_tasks\" title=\"include_tasks\"></a></h3><p>动态导入任务。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\">  <span class=\"attr\">tasks:</span></span><br><span class=\"line\">\t<span class=\"comment\"># 和普通命令一样使用</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Include</span> <span class=\"string\">task</span> <span class=\"string\">list</span> <span class=\"string\">in</span> <span class=\"string\">play</span></span><br><span class=\"line\">      <span class=\"attr\">include_tasks:</span> <span class=\"string\">stuff.yaml</span></span><br><span class=\"line\">    <span class=\"comment\"># 可使用vars传入变量</span></span><br><span class=\"line\">      <span class=\"attr\">vars:</span></span><br><span class=\"line\">      \t<span class=\"attr\">name:</span> <span class=\"string\">lhw</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"include_role\">include_role<a href=\"#include_role\" title=\"include_role\"></a></h3><p>动态导入角色。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\">  <span class=\"attr\">tasks:</span></span><br><span class=\"line\">    <span class=\"comment\"># 和普通命令一样使用</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">include_role:</span> <span class=\"string\">name=role_A</span></span><br><span class=\"line\">    <span class=\"comment\"># 可使用vars传入变量</span></span><br><span class=\"line\">      <span class=\"attr\">vars:</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">maurice</span></span><br><span class=\"line\">        <span class=\"attr\">age:</span> <span class=\"number\">100</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">import_role:</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">role_B</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"import_\">import_*<a href=\"#import_\" title=\"import_*\"></a></h2><h3 id=\"import_tasks\">import_tasks<a href=\"#import_tasks\" title=\"import_tasks\"></a></h3><p>用法同<code>include_tasks</code></p>\n<h3 id=\"import_role\">import_role<a href=\"#import_role\" title=\"import_role\"></a></h3><p>用法同<code>include_role</code></p>\n<h3 id=\"import_playbook\">import_playbook<a href=\"#import_playbook\" title=\"import_playbook\"></a></h3><p>用于在一个<code>Playbook</code>中导入另一个<code>Playbook</code>的<code>Play</code>，且只能在顶层<code>Playbook</code>中导入，不能在<code>tasks</code>中导入</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">hosts:</span> <span class=\"string\">localhost</span></span><br><span class=\"line\">  <span class=\"attr\">tasks:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">debug:</span></span><br><span class=\"line\">        <span class=\"attr\">msg:</span> <span class=\"string\">play1</span></span><br><span class=\"line\"><span class=\"comment\"># 导入Playbook</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Include</span> <span class=\"string\">a</span> <span class=\"string\">play</span> <span class=\"string\">after</span> <span class=\"string\">another</span> <span class=\"string\">play</span></span><br><span class=\"line\">  <span class=\"attr\">import_playbook:</span> <span class=\"string\">otherplays.yaml</span></span><br><span class=\"line\"><span class=\"comment\"># 错误导入方法，不能在tasks中导入</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">This</span> <span class=\"string\">DOES</span> <span class=\"string\">NOT</span> <span class=\"string\">WORK</span></span><br><span class=\"line\">  <span class=\"attr\">hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\">  <span class=\"attr\">tasks:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">debug:</span></span><br><span class=\"line\">        <span class=\"attr\">msg:</span> <span class=\"string\">task1</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">This</span> <span class=\"string\">fails</span> <span class=\"string\">because</span> <span class=\"string\">I'm</span> <span class=\"string\">inside</span> <span class=\"string\">a</span> <span class=\"string\">play</span> <span class=\"string\">already</span></span><br><span class=\"line\">      <span class=\"attr\">import_playbook:</span> <span class=\"string\">stuff.yaml</span></span><br></pre></td></tr></table></figure>\n\n\n\n","prev":{"title":"5-Ansible之Jinja2语法","link":"post/自动化运维/Ansible/6-Ansible之Jinja2语法"},"next":{"title":"3-Ansible之Roles","link":"post/自动化运维/Ansible/4-Ansible之Roles"},"plink":"https://beginc.github.io/post/自动化运维/Ansible/5-Ansible之导入/","toc":[{"id":"ansible复用","title":"Ansible复用","index":"1"},{"id":"动态导入与静态导入","title":"动态导入与静态导入","index":"2"},{"id":"各种导入","title":"各种导入","index":"3","children":[{"id":"include_","title":"include_*","index":"3.1","children":[{"id":"include_tasks","title":"include_tasks","index":"3.1.1"},{"id":"include_role","title":"include_role","index":"3.1.2"}]},{"id":"import_","title":"import_*","index":"3.2","children":[{"id":"import_tasks","title":"import_tasks","index":"3.2.1"},{"id":"import_role","title":"import_role","index":"3.2.2"},{"id":"import_playbook","title":"import_playbook","index":"3.2.3"}]}]}]}