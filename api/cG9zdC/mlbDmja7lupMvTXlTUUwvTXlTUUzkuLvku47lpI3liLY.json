{"title":"MySQL主从复制","date":"2020-02-12T08:31:43.000Z","date_formatted":{"ll":"Feb 12, 2020","L":"02/12/2020","MM-DD":"02-12"},"thumbnail":"post/数据库/MySQL/MySQL主从复制/cover.png","link":"post/数据库/MySQL/MySQL主从复制","categories":["MySQL","数据库"],"updated":"2020-02-12T13:19:15.969Z","content":"<h1 id=\"mysql主从复制原理\">MySQL主从复制原理<a href=\"#mysql主从复制原理\" title=\"MySQL主从复制原理\"></a></h1><h2 id=\"工作线程\">工作线程<a href=\"#工作线程\" title=\"工作线程\"></a></h2><p><strong>Binary Log Dump线程</strong></p>\n<p>主节点上的该线程用于将数据更改写到本机上的二进制日志bin-log中。</p>\n<p><strong>I/O线程</strong></p>\n<p>从节点上的该线程用于从主节点上读取二进制日志，并写入本机的中继日志relay log中。</p>\n<p><strong>SQL线程</strong></p>\n<p>从节点上的该线程用于读取中继日志，解析数据更改，并在从节点上进行重放。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/1.png\" class=\"\">\n\n<h2 id=\"复制模式\">复制模式<a href=\"#复制模式\" title=\"复制模式\"></a></h2><h3 id=\"异步模式\">异步模式<a href=\"#异步模式\" title=\"异步模式\"></a></h3><p>slave主动连接master，获取bin-log，不能保证数据的强一致性。该模式为默认的模式。</p>\n<h3 id=\"同步模式\">同步模式<a href=\"#同步模式\" title=\"同步模式\"></a></h3><p>主节点和从节点全部commit之后才会向客户端返回成功，可保证数据的强一致性。</p>\n<h3 id=\"半同步模式\">半同步模式<a href=\"#半同步模式\" title=\"半同步模式\"></a></h3><p>主节点只要等到一个从节点的commit之后就会执行commit，否则会等到超时之后切换成异步模式再提交。该模式不是内置的，需要安装插件。</p>\n<h1 id=\"mysql主从复制配置\">MySQL主从复制配置<a href=\"#mysql主从复制配置\" title=\"MySQL主从复制配置\"></a></h1><h2 id=\"主节点\">主节点<a href=\"#主节点\" title=\"主节点\"></a></h2><h3 id=\"配置文件\">配置文件<a href=\"#配置文件\" title=\"配置文件\"></a></h3><p>重启服务。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[mysqld]</span></span><br><span class=\"line\"><span class=\"comment\"># id</span></span><br><span class=\"line\"><span class=\"attr\">server-id</span>=<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"comment\"># 二进制日志文件</span></span><br><span class=\"line\"><span class=\"attr\">log-bin</span>=/var/lib/mysql/mysql-bin</span><br><span class=\"line\"><span class=\"comment\"># 错误记录文件</span></span><br><span class=\"line\"><span class=\"attr\">log-error</span>=/var/lib/mysql/mysql-error</span><br><span class=\"line\"><span class=\"comment\"># 主从复制时同步的数据库</span></span><br><span class=\"line\"><span class=\"attr\">binlog-do-db</span>=test</span><br><span class=\"line\"><span class=\"comment\"># 主从复制时忽略的数据库</span></span><br><span class=\"line\"><span class=\"comment\"># binlog-ignore-db=mysql</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"授权从节点\">授权从节点<a href=\"#授权从节点\" title=\"授权从节点\"></a></h3><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">GRANT</span> <span class=\"keyword\">REPLICATION</span> <span class=\"keyword\">SLAVE</span> <span class=\"keyword\">ON</span> *.* <span class=\"keyword\">TO</span> <span class=\"string\">'root'</span>@<span class=\"string\">'192.168.31.202'</span> <span class=\"keyword\">IDENTIFIED</span> <span class=\"keyword\">BY</span> <span class=\"string\">'Lq18851195070.'</span>;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"查看主节点状态\">查看主节点状态<a href=\"#查看主节点状态\" title=\"查看主节点状态\"></a></h3><p>记录下两个字段，配置从节点需要用。</p>\n<ul><li>File</li>\n<li>Position</li>\n</ul><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">show</span> <span class=\"keyword\">master</span> <span class=\"keyword\">status</span>;</span><br></pre></td></tr></table></figure>\n\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/2.png\" class=\"\">\n\n<h3 id=\"防火墙配置\">防火墙配置<a href=\"#防火墙配置\" title=\"防火墙配置\"></a></h3><p>这里直接关闭防火墙。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl <span class=\"keyword\">stop</span> firewalld.service</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"从节点\">从节点<a href=\"#从节点\" title=\"从节点\"></a></h2><h3 id=\"配置文件-1\">配置文件<a href=\"#配置文件-1\" title=\"配置文件\"></a></h3><p>重启服务。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[mysqld]</span></span><br><span class=\"line\"><span class=\"comment\"># id</span></span><br><span class=\"line\"><span class=\"attr\">server-id</span>=<span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"comment\"># 二进制日志文件</span></span><br><span class=\"line\"><span class=\"attr\">log-bin</span>=/var/lib/mysql/mysql-bin</span><br><span class=\"line\"><span class=\"comment\"># 错误记录文件</span></span><br><span class=\"line\"><span class=\"attr\">log-error</span>=/var/lib/mysql/mysql-error</span><br><span class=\"line\"><span class=\"comment\"># 主从复制时同步的数据库</span></span><br><span class=\"line\"><span class=\"attr\">replicate-do-db</span>=test</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"授权主节点\">授权主节点<a href=\"#授权主节点\" title=\"授权主节点\"></a></h3><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">CHANGE</span> <span class=\"keyword\">MASTER</span> <span class=\"keyword\">TO</span></span><br><span class=\"line\">MASTER_HOST = <span class=\"string\">'192.168.31.201'</span>,</span><br><span class=\"line\">MASTER_USER = <span class=\"string\">'root'</span>,</span><br><span class=\"line\">MASTER_PASSWORD = <span class=\"string\">'Lq18851195070.'</span>,</span><br><span class=\"line\">MASTER_PORT = <span class=\"number\">3306</span>,</span><br><span class=\"line\">master_log_file = <span class=\"string\">'mysql-bin.000001'</span>,</span><br><span class=\"line\">master_log_pos = <span class=\"number\">154</span>;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"开启主从同步\">开启主从同步<a href=\"#开启主从同步\" title=\"开启主从同步\"></a></h3><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">start</span> <span class=\"keyword\">slave</span>;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"查看同步状态\">查看同步状态<a href=\"#查看同步状态\" title=\"查看同步状态\"></a></h3><p>主要看两个属性是否为yes</p>\n<ul><li>Slave_IO_Running</li>\n<li>Slave_SQL_Running</li>\n</ul><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">show</span> <span class=\"keyword\">slave</span> <span class=\"keyword\">status</span> \\G;</span><br></pre></td></tr></table></figure>\n\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/3.png\" class=\"\">\n\n<h3 id=\"处理错误\">处理错误<a href=\"#处理错误\" title=\"处理错误\"></a></h3><p>观察到Last_IO_Error说主从节点有一样的UUID，查看/usr/lib/mysql.auto.cnf发现果然一样（由于是复制的虚拟机）。解决办法为停止从节点的mysqld服务，删除它的auto.cnf文件，再启动数据库服务即可。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/4.png\" class=\"\">","next":{"title":"MySQL锁机制","link":"post/数据库/MySQL/MySQL锁机制"},"plink":"https://beginc.github.io/post/数据库/MySQL/MySQL主从复制/","toc":[{"id":"mysql主从复制原理","title":"MySQL主从复制原理","index":"1","children":[{"id":"工作线程","title":"工作线程","index":"1.1"},{"id":"复制模式","title":"复制模式","index":"1.2","children":[{"id":"异步模式","title":"异步模式","index":"1.2.1"},{"id":"同步模式","title":"同步模式","index":"1.2.2"},{"id":"半同步模式","title":"半同步模式","index":"1.2.3"}]}]},{"id":"mysql主从复制配置","title":"MySQL主从复制配置","index":"2","children":[{"id":"主节点","title":"主节点","index":"2.1","children":[{"id":"配置文件","title":"配置文件","index":"2.1.1"},{"id":"授权从节点","title":"授权从节点","index":"2.1.2"},{"id":"查看主节点状态","title":"查看主节点状态","index":"2.1.3"},{"id":"防火墙配置","title":"防火墙配置","index":"2.1.4"}]},{"id":"从节点","title":"从节点","index":"2.2","children":[{"id":"配置文件-1","title":"配置文件","index":"2.2.1"},{"id":"授权主节点","title":"授权主节点","index":"2.2.2"},{"id":"开启主从同步","title":"开启主从同步","index":"2.2.3"},{"id":"查看同步状态","title":"查看同步状态","index":"2.2.4"},{"id":"处理错误","title":"处理错误","index":"2.2.5"}]}]}]}