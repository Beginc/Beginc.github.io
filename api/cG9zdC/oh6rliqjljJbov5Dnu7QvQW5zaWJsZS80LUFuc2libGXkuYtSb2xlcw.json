{"title":"3-Ansible之Roles","date":"2020-02-06T14:06:26.000Z","date_formatted":{"ll":"Feb 6, 2020","L":"02/06/2020","MM-DD":"02-06"},"thumbnail":"post/自动化运维/Ansible/4-Ansible之Roles/cover.png","link":"post/自动化运维/Ansible/4-Ansible之Roles","categories":["Ansible","自动化运维"],"updated":"2020-02-08T02:53:52.261Z","content":"<h1 id=\"roles简介\">Roles简介<a href=\"#roles简介\" title=\"Roles简介\"></a></h1><p><code>Roles</code>可以层次性、结构化地组织<code>Playbook</code>，对重复的部分进行复用，实现更为复杂的任务。</p>\n<h1 id=\"roles目录结构\">Roles目录结构<a href=\"#roles目录结构\" title=\"Roles目录结构\"></a></h1><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">site.yml</span><br><span class=\"line\">webserver.yml</span><br><span class=\"line\">dbserver.yml</span><br><span class=\"line\">group_vars/</span><br><span class=\"line\">\tall/</span><br><span class=\"line\">\tgroup1/</span><br><span class=\"line\">\tgroup2/</span><br><span class=\"line\">host_vars/</span><br><span class=\"line\">\t192.168.31.101/</span><br><span class=\"line\">\t192.168.31.102/</span><br><span class=\"line\">roles/</span><br><span class=\"line\">    dbserver/</span><br><span class=\"line\">        <span class=\"comment\"># 存放各种任务</span></span><br><span class=\"line\">        tasks/</span><br><span class=\"line\">        \tmain.yml</span><br><span class=\"line\">        <span class=\"comment\"># 存放各种handler</span></span><br><span class=\"line\">        handlers/</span><br><span class=\"line\">        \tmain.yml</span><br><span class=\"line\">        <span class=\"comment\"># 存放文件</span></span><br><span class=\"line\">        files/</span><br><span class=\"line\">        <span class=\"comment\"># 存放模板文件</span></span><br><span class=\"line\">        templates/</span><br><span class=\"line\">        <span class=\"comment\"># 存放变量定义文件</span></span><br><span class=\"line\">        vars/</span><br><span class=\"line\">        \tmain.yml</span><br><span class=\"line\">        <span class=\"comment\"># 存放默认变量</span></span><br><span class=\"line\">        defaults/</span><br><span class=\"line\">        \tmain.yml</span><br><span class=\"line\">        <span class=\"comment\"># 存放角色依赖关系</span></span><br><span class=\"line\">        meta/</span><br><span class=\"line\">        \tmain.yml</span><br><span class=\"line\">    webserver/</span><br><span class=\"line\">        <span class=\"comment\"># 存放各种任务</span></span><br><span class=\"line\">        tasks/</span><br><span class=\"line\">        \tmain.yml</span><br><span class=\"line\">        <span class=\"comment\"># 存放各种handler</span></span><br><span class=\"line\">        handlers/</span><br><span class=\"line\">        \tmain.yml</span><br><span class=\"line\">        <span class=\"comment\"># 存放文件</span></span><br><span class=\"line\">        files/</span><br><span class=\"line\">        <span class=\"comment\"># 存放模板文件</span></span><br><span class=\"line\">        templates/</span><br><span class=\"line\">        <span class=\"comment\"># 存放变量定义文件</span></span><br><span class=\"line\">        vars/</span><br><span class=\"line\">        \tmain.yml</span><br><span class=\"line\">        <span class=\"comment\"># 存放默认变量</span></span><br><span class=\"line\">        defaults/</span><br><span class=\"line\">        \tmain.yml</span><br><span class=\"line\">        <span class=\"comment\"># 存放角色依赖关系</span></span><br><span class=\"line\">        meta/</span><br><span class=\"line\">        \tmain.yml</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"tasks\">Tasks<a href=\"#tasks\" title=\"Tasks\"></a></h2><p>该目录可以存放各种任务文件，还必须包含一个<code>main.yml</code>来组织起目录下各个任务的执行。</p>\n<ul><li>使用<code>include_tasks</code>来导入。</li>\n</ul><p><strong>tasks/task1.yml</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">task1</span></span><br><span class=\"line\">  <span class=\"attr\">shell:</span> <span class=\"string\">echo</span> <span class=\"string\">hello</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>tasks/task2.yml</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">task1</span></span><br><span class=\"line\">  <span class=\"attr\">shell:</span> <span class=\"string\">echo</span> <span class=\"string\">hello</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>tasks/main.yml</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">include_tasks:</span> <span class=\"string\">task1.yml</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">include_tasks:</span> <span class=\"string\">task2.yml</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"handlers\">Handlers<a href=\"#handlers\" title=\"Handlers\"></a></h2><p>该目录可以存放各种包含<code>handler</code>的文件，还必须包含一个<code>main.yml</code>。</p>\n<ul><li>使用<code>include</code>来导入</li>\n</ul><p><strong>handlers/handler1.yml</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">handler1</span></span><br><span class=\"line\">  <span class=\"attr\">shell:</span> <span class=\"string\">echo</span> <span class=\"string\">handler1</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>handlers/handler2.yml</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">handler2</span></span><br><span class=\"line\">  <span class=\"attr\">shell:</span> <span class=\"string\">echo</span> <span class=\"string\">handler2</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>handlers/main.yml</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">include:</span> <span class=\"string\">handler1.yml</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">include:</span> <span class=\"string\">handler2.yml</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"files\">files<a href=\"#files\" title=\"files\"></a></h2><p>该目录用于存放文件，放在该文件夹里的文件可以使用文件名直接引用。</p>\n<h2 id=\"templates\">templates<a href=\"#templates\" title=\"templates\"></a></h2><p>该目录用于存放模板文件，放在该文件夹里的模板文件可以使用文件名直接引用。</p>\n<h2 id=\"vars\">vars<a href=\"#vars\" title=\"vars\"></a></h2><p>该目录用于存放变量定义文件，在此处定义过的变量可以直接引用。</p>\n<h3 id=\"方式一：所有变量定义都放在varsmainyml中\">方式一：所有变量定义都放在vars/main.yml中<a href=\"#方式一：所有变量定义都放在varsmainyml中\" title=\"方式一：所有变量定义都放在vars/main.yml中\"></a></h3><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">name:</span> <span class=\"string\">lhw</span></span><br><span class=\"line\"><span class=\"attr\">age:</span> <span class=\"number\">18</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"方式二：变量定义在varsmain目录下的yaml文件中\">方式二：变量定义在vars/main目录下的YAML文件中<a href=\"#方式二：变量定义在varsmain目录下的yaml文件中\" title=\"方式二：变量定义在vars/main目录下的YAML文件中\"></a></h3><p>该方式可以将变量分成多个文件进行定义。</p>\n<p><strong>vars/main/var1.yml</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">name:</span> <span class=\"string\">lhw</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>vars/main/var2.yml</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">age:</span> <span class=\"number\">18</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"defaults\">defaults<a href=\"#defaults\" title=\"defaults\"></a></h2><p>该目录用于存放默认变量定义文件，在此处定义过的默认变量可以直接引用。默认变量不同的地方是，它的优先级最低，任何其他地方定义的变量优先级都高于它。</p>\n<h3 id=\"方式一：所有变量定义都放在defaultsmainyml中\">方式一：所有变量定义都放在defaults/main.yml中<a href=\"#方式一：所有变量定义都放在defaultsmainyml中\" title=\"方式一：所有变量定义都放在defaults/main.yml中\"></a></h3><p>同<code>vars</code></p>\n<h3 id=\"方式二：变量定义在varsmain目录下的yaml文件中-1\">方式二：变量定义在vars/main目录下的YAML文件中<a href=\"#方式二：变量定义在varsmain目录下的yaml文件中-1\" title=\"方式二：变量定义在vars/main目录下的YAML文件中\"></a></h3><p>同<code>vars</code></p>\n<h2 id=\"meta\">meta<a href=\"#meta\" title=\"meta\"></a></h2><p>用于存放角色间的依赖关系，例如<code>rocketmq-broker</code>角色要想执行其任务，必须先有<code>Java</code>的环境，因此该角色依赖于<code>Java</code>角色。</p>\n<ul><li>在<code>dependencies</code>中定义，可为依赖的角色传入参数。</li>\n</ul><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">dependencies:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">&#123;</span> <span class=\"attr\">role: java arg1:</span> <span class=\"string\">\"123\"</span><span class=\"string\">,</span> <span class=\"attr\">arg2:</span> <span class=\"string\">\"456\"</span><span class=\"string\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"group_vars\">group_vars<a href=\"#group_vars\" title=\"group_vars\"></a></h2><p>该方式用于定义组变量，效果和在<code>/etc/ansible/hosts</code>中定义组变量效果相同，但是其优先级高于<code>/etc/ansible/hosts</code>中的组变量。</p>\n<h3 id=\"方式一：组变量定义在group_vars组名yml中\">方式一：组变量定义在group_vars/组名.yml中<a href=\"#方式一：组变量定义在group_vars组名yml中\" title=\"方式一：组变量定义在group_vars/组名.yml中\"></a></h3><p><strong>group_vars/broker.yml</strong></p>\n<p>该文件里定义的变量只能由<code>broker</code>组使用。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">brokerName: broker</span><br></pre></td></tr></table></figure>\n\n<p><strong>group_vars/namesrv.yml</strong></p>\n<p>该文件里定义的变量只能由<code>namesrv</code>组使用。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">port:</span> <span class=\"number\">9876</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>group_vars/all.yml</strong></p>\n<p>该文件里定义的变量可由所有组使用。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">msg:</span> <span class=\"string\">global</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"方式二：组变量定义在group_vars组名目录下的yaml文件中\">方式二：组变量定义在group_vars/组名/目录下的YAML文件中<a href=\"#方式二：组变量定义在group_vars组名目录下的yaml文件中\" title=\"方式二：组变量定义在group_vars/组名/目录下的YAML文件中\"></a></h3><p>这种方式允许我们将一个组的变量定义在不同的文件中。</p>\n<h2 id=\"host_vars\">host_vars<a href=\"#host_vars\" title=\"host_vars\"></a></h2><p>该方式用于定义主机变量，效果和在<code>/etc/ansible/hosts</code>中定义主机变量效果相同，但是其优先级高于<code>/etc/ansible/hosts</code>中的主机变量。</p>\n<h3 id=\"方式一：主机变量定义在host_vars主机名yml中\">方式一：主机变量定义在host_vars/主机名.yml中<a href=\"#方式一：主机变量定义在host_vars主机名yml中\" title=\"方式一：主机变量定义在host_vars/主机名.yml中\"></a></h3><p>同<code>group_vars</code>。</p>\n<h3 id=\"方式二：主机变量定义在host_vars主机名目录下的yaml文件中\">方式二：主机变量定义在host_vars/主机名/目录下的YAML文件中<a href=\"#方式二：主机变量定义在host_vars主机名目录下的yaml文件中\" title=\"方式二：主机变量定义在host_vars/主机名/目录下的YAML文件中\"></a></h3><p>同<code>group_vars</code>。</p>\n<h1 id=\"使用roles\">使用Roles<a href=\"#使用roles\" title=\"使用Roles\"></a></h1><p>在与<code>roles</code>目录同级的地方定义<code>Playbook</code>，使用定义好的角色。</p>\n<p><strong>dbserver.yml</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">hosts:</span> <span class=\"string\">dbserver</span></span><br><span class=\"line\">  <span class=\"attr\">remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\">  <span class=\"attr\">gather_facts:</span> <span class=\"literal\">no</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">roles:</span></span><br><span class=\"line\">  \t<span class=\"comment\"># 直接使用</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">dbserver</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>webserver.yml</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">hosts:</span> <span class=\"string\">webserver</span></span><br><span class=\"line\">  <span class=\"attr\">remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\">  <span class=\"attr\">gather_facts:</span> <span class=\"literal\">no</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">roles:</span></span><br><span class=\"line\">  \t<span class=\"comment\"># 使用多个角色</span></span><br><span class=\"line\">  \t<span class=\"comment\"># 传参给角色</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">role:</span> <span class=\"string\">dbserver</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">3306</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">role:</span> <span class=\"string\">webserver</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">8080</span></span><br></pre></td></tr></table></figure>\n\n","prev":{"title":"4-Ansible之导入","link":"post/自动化运维/Ansible/5-Ansible之导入"},"next":{"title":"3-Ansible之Playbook","link":"post/自动化运维/Ansible/3-Ansible之Playbook"},"plink":"https://beginc.github.io/post/自动化运维/Ansible/4-Ansible之Roles/","toc":[{"id":"roles简介","title":"Roles简介","index":"1"},{"id":"roles目录结构","title":"Roles目录结构","index":"2","children":[{"id":"tasks","title":"Tasks","index":"2.1"},{"id":"handlers","title":"Handlers","index":"2.2"},{"id":"files","title":"files","index":"2.3"},{"id":"templates","title":"templates","index":"2.4"},{"id":"vars","title":"vars","index":"2.5","children":[{"id":"方式一：所有变量定义都放在varsmainyml中","title":"方式一：所有变量定义都放在vars&#x2F;main.yml中","index":"2.5.1"},{"id":"方式二：变量定义在varsmain目录下的yaml文件中","title":"方式二：变量定义在vars&#x2F;main目录下的YAML文件中","index":"2.5.2"}]},{"id":"defaults","title":"defaults","index":"2.6","children":[{"id":"方式一：所有变量定义都放在defaultsmainyml中","title":"方式一：所有变量定义都放在defaults&#x2F;main.yml中","index":"2.6.1"},{"id":"方式二：变量定义在varsmain目录下的yaml文件中-1","title":"方式二：变量定义在vars&#x2F;main目录下的YAML文件中","index":"2.6.2"}]},{"id":"meta","title":"meta","index":"2.7"},{"id":"group_vars","title":"group_vars","index":"2.8","children":[{"id":"方式一：组变量定义在group_vars组名yml中","title":"方式一：组变量定义在group_vars&#x2F;组名.yml中","index":"2.8.1"},{"id":"方式二：组变量定义在group_vars组名目录下的yaml文件中","title":"方式二：组变量定义在group_vars&#x2F;组名&#x2F;目录下的YAML文件中","index":"2.8.2"}]},{"id":"host_vars","title":"host_vars","index":"2.9","children":[{"id":"方式一：主机变量定义在host_vars主机名yml中","title":"方式一：主机变量定义在host_vars&#x2F;主机名.yml中","index":"2.9.1"},{"id":"方式二：主机变量定义在host_vars主机名目录下的yaml文件中","title":"方式二：主机变量定义在host_vars&#x2F;主机名&#x2F;目录下的YAML文件中","index":"2.9.2"}]}]},{"id":"使用roles","title":"使用Roles","index":"3"}]}