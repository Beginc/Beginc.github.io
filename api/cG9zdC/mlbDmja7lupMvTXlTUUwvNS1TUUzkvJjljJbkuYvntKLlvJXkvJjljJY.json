{"title":"5-SQL优化之索引优化","date":"2020-02-12T08:30:35.000Z","date_formatted":{"ll":"Feb 12, 2020","L":"02/12/2020","MM-DD":"02-12"},"thumbnail":"post/数据库/MySQL/5-SQL优化之索引优化/cover.png","link":"post/数据库/MySQL/5-SQL优化之索引优化","categories":["MySQL","数据库"],"updated":"2020-02-12T13:19:05.210Z","content":"<h1 id=\"建立索引的原则\">建立索引的原则<a href=\"#建立索引的原则\" title=\"建立索引的原则\"></a></h1><p><strong>建立索引</strong></p>\n<ul><li>主键自动建立索引</li>\n<li>频繁作为查询条件的字段应该创建索引</li>\n<li>查询中与其他表关联的字段应该创建索引</li>\n</ul><p><strong>不建立索引</strong></p>\n<ul><li>频繁更新的字段不建立索引</li>\n<li>Where条件用不到的字段不建立索引</li>\n<li>表记录太少不建立索引</li>\n</ul><h1 id=\"索引优化的一些原则\">索引优化的一些原则<a href=\"#索引优化的一些原则\" title=\"索引优化的一些原则\"></a></h1><h2 id=\"复合索引\">复合索引<a href=\"#复合索引\" title=\"复合索引\"></a></h2><h3 id=\"最佳左前缀原则\">最佳左前缀原则<a href=\"#最佳左前缀原则\" title=\"最佳左前缀原则\"></a></h3><p>使用复合索引时不要跳列进行查询，否则会导致需要回表查询。</p>\n<p><strong>建表</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">create</span> <span class=\"keyword\">table</span> people(</span><br><span class=\"line\">\t<span class=\"keyword\">id</span> <span class=\"built_in\">int</span> primary <span class=\"keyword\">key</span> auto_increment,</span><br><span class=\"line\">    <span class=\"keyword\">name</span> <span class=\"built_in\">varchar</span>(<span class=\"number\">50</span>) <span class=\"keyword\">not</span> <span class=\"literal\">null</span>,</span><br><span class=\"line\">    age <span class=\"built_in\">int</span> <span class=\"keyword\">not</span> <span class=\"literal\">null</span>,</span><br><span class=\"line\">    hobby <span class=\"built_in\">varchar</span>(<span class=\"number\">50</span>) <span class=\"keyword\">not</span> <span class=\"literal\">null</span></span><br><span class=\"line\">)<span class=\"keyword\">engine</span>=<span class=\"keyword\">innodb</span> <span class=\"keyword\">default</span> <span class=\"keyword\">charset</span>=utf8;</span><br></pre></td></tr></table></figure>\n\n<p><strong>插入数据</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">insert</span> <span class=\"keyword\">into</span> people(<span class=\"keyword\">name</span>, age, hobby) <span class=\"keyword\">values</span></span><br><span class=\"line\">(<span class=\"string\">'p1'</span>, <span class=\"number\">18</span>, <span class=\"string\">'soccer'</span>),</span><br><span class=\"line\">(<span class=\"string\">'p2'</span>, <span class=\"number\">19</span>, <span class=\"string\">'tennis'</span>),</span><br><span class=\"line\">(<span class=\"string\">'p3'</span>, <span class=\"number\">20</span>, <span class=\"string\">'swimming'</span>),</span><br><span class=\"line\">(<span class=\"string\">'p4'</span>, <span class=\"number\">21</span>, <span class=\"string\">'bike'</span>);</span><br></pre></td></tr></table></figure>\n\n<p><strong>建立复合索引</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">create</span> <span class=\"keyword\">index</span> ind <span class=\"keyword\">on</span> people(<span class=\"keyword\">name</span>, age, hobby);</span><br></pre></td></tr></table></figure>\n\n<p><strong>符合最佳左前缀原则进行查询</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">explain</span> <span class=\"keyword\">select</span> <span class=\"keyword\">id</span> <span class=\"keyword\">from</span> people <span class=\"keyword\">where</span> <span class=\"keyword\">name</span> = <span class=\"string\">'p1'</span> <span class=\"keyword\">and</span> age = <span class=\"number\">18</span> <span class=\"keyword\">and</span> hobby=<span class=\"string\">'soccer'</span>;</span><br></pre></td></tr></table></figure>\n\n<p>type为ref，rows为1，Extra为using index，索引全部用上，效果很好。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/5-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96/1.png\" class=\"\">\n\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">explain</span> <span class=\"keyword\">select</span> <span class=\"keyword\">id</span> <span class=\"keyword\">from</span> people <span class=\"keyword\">where</span> hobby=<span class=\"string\">'soccer'</span> <span class=\"keyword\">and</span> <span class=\"keyword\">name</span> = <span class=\"string\">'p1'</span> <span class=\"keyword\">and</span> age = <span class=\"number\">18</span>;</span><br></pre></td></tr></table></figure>\n\n<p>打乱顺序也没有关系。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/5-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96/2.png\" class=\"\">\n\n<p><strong>不符合最佳左前缀原则进行查询</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">explain</span> <span class=\"keyword\">select</span> <span class=\"keyword\">id</span> <span class=\"keyword\">from</span> people <span class=\"keyword\">where</span> age = <span class=\"number\">18</span> <span class=\"keyword\">and</span> hobby=<span class=\"string\">'soccer'</span>;</span><br></pre></td></tr></table></figure>\n\n<p>缺了带头大哥name，出现了using where回表查询，rows为4。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/5-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96/3.png\" class=\"\">\n\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">explain</span> <span class=\"keyword\">select</span> <span class=\"keyword\">id</span> <span class=\"keyword\">from</span> people <span class=\"keyword\">where</span> <span class=\"keyword\">name</span> = <span class=\"string\">'p1'</span> <span class=\"keyword\">and</span> hobby=<span class=\"string\">'soccer'</span>;</span><br></pre></td></tr></table></figure>\n\n<p>却了中间的跟班小弟age，出现了using where回表查询。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/5-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96/4.png\" class=\"\">\n\n<h2 id=\"order-by优化\">Order By优化<a href=\"#order-by优化\" title=\"Order By优化\"></a></h2><h3 id=\"order-by和where保持一致\">order by和where保持一致<a href=\"#order-by和where保持一致\" title=\"order by和where保持一致\"></a></h3><p>保持一致可以避免using filesort。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">explain</span> <span class=\"keyword\">select</span> <span class=\"keyword\">id</span> <span class=\"keyword\">from</span> people <span class=\"keyword\">where</span> <span class=\"keyword\">id</span> = <span class=\"number\">1</span> <span class=\"keyword\">order</span> <span class=\"keyword\">by</span> <span class=\"keyword\">name</span>;</span><br></pre></td></tr></table></figure>\n\n<p>此处where中使用的是id，然而排序使用的是name，带来了using filesort。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/5-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96/11.png\" class=\"\">\n\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">explain</span> <span class=\"keyword\">select</span> <span class=\"keyword\">id</span> <span class=\"keyword\">from</span> people <span class=\"keyword\">where</span> <span class=\"keyword\">id</span> = <span class=\"number\">1</span> <span class=\"keyword\">order</span> <span class=\"keyword\">by</span> <span class=\"keyword\">id</span>;</span><br></pre></td></tr></table></figure>\n\n<p>此处where中使用的是id，排序也使用的是id，无using filesort。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/5-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96/12.png\" class=\"\">\n\n<h3 id=\"using-filesort优化\">using filesort优化<a href=\"#using-filesort优化\" title=\"using filesort优化\"></a></h3><p>using filesort有两种算法，当max_length_for_sort_data太低时，MySQL会切换到双路排序，因此可以调大max_length_for_sort_data。</p>\n<ul><li>双路排序：MySQL4.1之前默认使用</li>\n<li>单路排序：MySQL4.1之后默认使用</li>\n</ul><h2 id=\"多表查询优化\">多表查询优化<a href=\"#多表查询优化\" title=\"多表查询优化\"></a></h2><h3 id=\"小表驱动大表\">小表驱动大表<a href=\"#小表驱动大表\" title=\"小表驱动大表\"></a></h3><p>在查询中最好使用小表驱动大表，因为在外层表循环内层的时候，会锁定外层表，如果大表在外，会被锁定较多的次数。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 小表驱动大表</span></span><br><span class=\"line\">where 小表.x = 大表.y;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"外连接索引\">外连接索引<a href=\"#外连接索引\" title=\"外连接索引\"></a></h3><ul><li>对于左外连接，给左表加索引。</li>\n<li>对于右外连接，给右表加索引。</li>\n</ul><h2 id=\"子查询优化\">子查询优化<a href=\"#子查询优化\" title=\"子查询优化\"></a></h2><h3 id=\"exists与in\">exists与in<a href=\"#exists与in\" title=\"exists与in\"></a></h3><p>对于</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> ... <span class=\"keyword\">from</span> <span class=\"keyword\">table</span> <span class=\"keyword\">where</span> <span class=\"keyword\">exists</span>/<span class=\"keyword\">in</span> (子查询)</span><br></pre></td></tr></table></figure>\n\n<ul><li>主查询数据较多，使用in。</li>\n<li>子查询数据较多，使用exists。</li>\n</ul><h2 id=\"覆盖索引\">覆盖索引<a href=\"#覆盖索引\" title=\"覆盖索引\"></a></h2><p>所谓覆盖索引就是要查询的字段全部都在索引之中，无需回表查询。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 回表</span></span><br><span class=\"line\"><span class=\"keyword\">select</span> * <span class=\"keyword\">from</span> people <span class=\"keyword\">where</span> <span class=\"keyword\">id</span> = <span class=\"number\">1</span>;</span><br><span class=\"line\"><span class=\"comment\"># 不覆盖索引</span></span><br><span class=\"line\"><span class=\"keyword\">select</span> <span class=\"keyword\">id</span> <span class=\"keyword\">from</span> people <span class=\"keyword\">where</span> <span class=\"keyword\">id</span> = <span class=\"number\">1</span>;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"索引失效情况\">索引失效情况<a href=\"#索引失效情况\" title=\"索引失效情况\"></a></h2><h3 id=\"避免在索引上进行计算\">避免在索引上进行计算<a href=\"#避免在索引上进行计算\" title=\"避免在索引上进行计算\"></a></h3><p>在索引上进行任何计算（计算，函数，类型转换）都会导致索引失效。</p>\n<p>先删除people表的复合索引。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">drop</span> <span class=\"keyword\">index</span> ind <span class=\"keyword\">on</span> people;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">explain</span> <span class=\"keyword\">select</span> <span class=\"keyword\">id</span> <span class=\"keyword\">from</span> people <span class=\"keyword\">where</span> <span class=\"keyword\">id</span> + <span class=\"number\">1</span> = <span class=\"number\">2</span>;</span><br></pre></td></tr></table></figure>\n\n<p>对主键索引id进行计算，索引失效。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/5-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96/5.png\" class=\"\">\n\n<h3 id=\"避免在索引上使用不等于\">避免在索引上使用不等于<a href=\"#避免在索引上使用不等于\" title=\"避免在索引上使用不等于\"></a></h3><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">explain</span> <span class=\"keyword\">select</span> <span class=\"keyword\">id</span> <span class=\"keyword\">from</span> people <span class=\"keyword\">where</span> <span class=\"keyword\">id</span> != <span class=\"number\">1</span>;</span><br></pre></td></tr></table></figure>\n\n<p>对主键索引id进行不等于操作，索引失效。</p>\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/5-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96/6.png\" class=\"\">\n\n<h3 id=\"避免在索引上使用判空\">避免在索引上使用判空<a href=\"#避免在索引上使用判空\" title=\"避免在索引上使用判空\"></a></h3><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">explain</span> <span class=\"keyword\">select</span> <span class=\"keyword\">id</span> <span class=\"keyword\">from</span> people <span class=\"keyword\">where</span> <span class=\"keyword\">id</span> <span class=\"keyword\">is</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\"><span class=\"keyword\">explain</span> <span class=\"keyword\">select</span> <span class=\"keyword\">id</span> <span class=\"keyword\">from</span> people <span class=\"keyword\">where</span> <span class=\"keyword\">id</span> <span class=\"keyword\">is</span> <span class=\"keyword\">not</span> <span class=\"literal\">null</span>;</span><br></pre></td></tr></table></figure>\n\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/5-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96/7.png\" class=\"\">\n\n<h3 id=\"避免在索引上使用范围查询和in\">避免在索引上使用范围查询和in<a href=\"#避免在索引上使用范围查询和in\" title=\"避免在索引上使用范围查询和in\"></a></h3><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">explain</span> <span class=\"keyword\">select</span> <span class=\"keyword\">id</span> <span class=\"keyword\">from</span> people <span class=\"keyword\">where</span> <span class=\"keyword\">id</span> &gt; <span class=\"number\">2</span>;</span><br><span class=\"line\"><span class=\"keyword\">explain</span> <span class=\"keyword\">select</span> <span class=\"keyword\">id</span> <span class=\"keyword\">from</span> people <span class=\"keyword\">where</span> <span class=\"keyword\">id</span> <span class=\"keyword\">in</span> (<span class=\"number\">1</span>, <span class=\"number\">2</span>);</span><br></pre></td></tr></table></figure>\n\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/5-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96/8.png\" class=\"\">\n\n<h3 id=\"避免在索引上使用以开头的模糊查询\">避免在索引上使用以%开头的模糊查询<a href=\"#避免在索引上使用以开头的模糊查询\" title=\"避免在索引上使用以%开头的模糊查询\"></a></h3><p>在name上建立索引。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">create</span> <span class=\"keyword\">index</span> ind <span class=\"keyword\">on</span> people(<span class=\"keyword\">name</span>);</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">explain</span> <span class=\"keyword\">select</span> <span class=\"keyword\">id</span> <span class=\"keyword\">from</span> people <span class=\"keyword\">where</span> <span class=\"keyword\">name</span> <span class=\"keyword\">like</span> <span class=\"string\">'%p%'</span>;</span><br><span class=\"line\"><span class=\"keyword\">drop</span> <span class=\"keyword\">index</span> ind <span class=\"keyword\">on</span> people;</span><br></pre></td></tr></table></figure>\n\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/5-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96/9.png\" class=\"\">\n\n<h3 id=\"避免在索引上使用or\">避免在索引上使用or<a href=\"#避免在索引上使用or\" title=\"避免在索引上使用or\"></a></h3><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">explain</span> <span class=\"keyword\">select</span> <span class=\"keyword\">id</span> <span class=\"keyword\">from</span> people <span class=\"keyword\">where</span> <span class=\"keyword\">id</span> = <span class=\"number\">1</span> <span class=\"keyword\">or</span> <span class=\"keyword\">id</span> = <span class=\"number\">2</span>;</span><br></pre></td></tr></table></figure>\n\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/5-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96/10.png\" class=\"\">","prev":{"title":"MySQL锁机制","link":"post/数据库/MySQL/MySQL锁机制"},"next":{"title":"4-SQL优化之排查方法","link":"post/数据库/MySQL/4-SQL优化之排查方法"},"plink":"https://beginc.github.io/post/数据库/MySQL/5-SQL优化之索引优化/","toc":[{"id":"建立索引的原则","title":"建立索引的原则","index":"1"},{"id":"索引优化的一些原则","title":"索引优化的一些原则","index":"2","children":[{"id":"复合索引","title":"复合索引","index":"2.1","children":[{"id":"最佳左前缀原则","title":"最佳左前缀原则","index":"2.1.1"}]},{"id":"order-by优化","title":"Order By优化","index":"2.2","children":[{"id":"order-by和where保持一致","title":"order by和where保持一致","index":"2.2.1"},{"id":"using-filesort优化","title":"using filesort优化","index":"2.2.2"}]},{"id":"多表查询优化","title":"多表查询优化","index":"2.3","children":[{"id":"小表驱动大表","title":"小表驱动大表","index":"2.3.1"},{"id":"外连接索引","title":"外连接索引","index":"2.3.2"}]},{"id":"子查询优化","title":"子查询优化","index":"2.4","children":[{"id":"exists与in","title":"exists与in","index":"2.4.1"}]},{"id":"覆盖索引","title":"覆盖索引","index":"2.5"},{"id":"索引失效情况","title":"索引失效情况","index":"2.6","children":[{"id":"避免在索引上进行计算","title":"避免在索引上进行计算","index":"2.6.1"},{"id":"避免在索引上使用不等于","title":"避免在索引上使用不等于","index":"2.6.2"},{"id":"避免在索引上使用判空","title":"避免在索引上使用判空","index":"2.6.3"},{"id":"避免在索引上使用范围查询和in","title":"避免在索引上使用范围查询和in","index":"2.6.4"},{"id":"避免在索引上使用以开头的模糊查询","title":"避免在索引上使用以%开头的模糊查询","index":"2.6.5"},{"id":"避免在索引上使用or","title":"避免在索引上使用or","index":"2.6.6"}]}]}]}