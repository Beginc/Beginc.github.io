{"title":"Redis之持久化","date":"2020-03-01T14:42:05.000Z","date_formatted":{"ll":"Mar 1, 2020","L":"03/01/2020","MM-DD":"03-01"},"thumbnail":"post/中间件/Redis/Redis之持久化/cover.png","link":"post/中间件/Redis/Redis之持久化","categories":["Redis","中间件"],"updated":"2020-03-02T01:39:27.882Z","content":"<h1 id=\"redis持久化机制\">Redis持久化机制<a href=\"#redis持久化机制\" title=\"Redis持久化机制\"></a></h1><h2 id=\"内存快照rdb\">内存快照RDB<a href=\"#内存快照rdb\" title=\"内存快照RDB\"></a></h2><p>对内存的数据做一个全盘的持久化备份。</p>\n<h2 id=\"日志aof\">日志AOF<a href=\"#日志aof\" title=\"日志AOF\"></a></h2><p>对写操作进行日志记录。</p>\n<h1 id=\"rdb\">RDB<a href=\"#rdb\" title=\"RDB\"></a></h1><p>对内存做快照。</p>\n<h2 id=\"相关命令\">相关命令<a href=\"#相关命令\" title=\"相关命令\"></a></h2><p><strong>save</strong></p>\n<p>执行一次内存快照。</p>\n<ul><li>会阻塞服务器直到快照完成</li>\n</ul><p><strong>bgsave</strong></p>\n<p>后台执行一次内存快照。</p>\n<ul><li>使用Fork生成一个子进程做内存快照</li>\n</ul><h2 id=\"相关配置\">相关配置<a href=\"#相关配置\" title=\"相关配置\"></a></h2><div class=\"cz\"><div class=\"db\"><table><thead><tr>\n<th>配置</th><th>默认</th><th>功能</th></tr>\n</thead><tbody><tr>\n<td>dbfilename</td><td>dump.rdb</td><td>本地RDB文件名</td></tr>\n<tr>\n<td>dir</td><td></td><td>本地RDB文件目录</td></tr>\n<tr>\n<td>rdbcompression</td><td>yes</td><td>是否使用LZF对RDB文件进行压缩</td></tr>\n<tr>\n<td>rdbchecksum</td><td>yes</td><td>是否对RDB文件进行校验，设置为no可节约10%时间</td></tr>\n<tr>\n<td>save second changes</td><td></td><td>时间范围内发生了changes次改变则进行RDB持久化</td></tr>\n</tbody></table></div></div><h2 id=\"优缺点\">优缺点<a href=\"#优缺点\" title=\"优缺点\"></a></h2><p><strong>优点</strong></p>\n<ul><li>存储效率高</li>\n<li>全量备份</li>\n<li>恢复速度快</li>\n</ul><p><strong>缺点</strong></p>\n<ul><li>无法做到实时持久化，会丢失数据</li>\n<li>Fork子进程做内存快照，内存消耗大</li>\n<li>全量备份，效率低</li>\n<li>各版本RDB格式不统一</li>\n</ul><h1 id=\"aof\">AOF<a href=\"#aof\" title=\"AOF\"></a></h1><p>对写操作做日志记录，<strong>恢复时优先级高于RDB。</strong></p>\n<img src=\"/post/%E4%B8%AD%E9%97%B4%E4%BB%B6/Redis/Redis%E4%B9%8B%E6%8C%81%E4%B9%85%E5%8C%96/image-20200301230042272.png\" class=\"\">\n\n<h2 id=\"持久化策略\">持久化策略<a href=\"#持久化策略\" title=\"持久化策略\"></a></h2><p><strong>always</strong></p>\n<p>每次写操作都马上同步到AOF文件中</p>\n<p><strong>everysec</strong></p>\n<p>每秒将写操作同步到AOF文件中</p>\n<p><strong>no</strong></p>\n<p>系统控制</p>\n<h2 id=\"aof重写\">AOF重写<a href=\"#aof重写\" title=\"AOF重写\"></a></h2><p>对AOF文件进行指令分析重写，压缩文件体积。</p>\n<ul><li>已经超时的数据不再写入文件</li>\n<li>忽略无效指令</li>\n<li>同一条数据的多条写指令进行合并</li>\n</ul><h3 id=\"自动重写\">自动重写<a href=\"#自动重写\" title=\"自动重写\"></a></h3><ul><li>bgrewriteaof<ul><li>Fork一个子进程重写AOF文件</li>\n</ul></li>\n</ul><h3 id=\"配置\">配置<a href=\"#配置\" title=\"配置\"></a></h3><p><strong>配置项</strong></p>\n<ul><li>auto-aof-rewrite-min-size</li>\n<li>auto-aof-rewrite-percentage</li>\n</ul><p><strong>比对参数</strong></p>\n<ul><li>aof_current_size</li>\n<li>aof_base_size</li>\n</ul><p><strong>触发条件</strong></p>\n<ul><li>aof_current_size &gt; auto-aof-rewrite-min-size</li>\n<li>(aof_current_size - aof_base_size) / aof_base_size &gt;= auto-aof-rewrite-percentage</li>\n</ul><h2 id=\"相关配置-1\">相关配置<a href=\"#相关配置-1\" title=\"相关配置\"></a></h2><div class=\"cz\"><div class=\"db\"><table><thead><tr>\n<th>配置</th><th>默认</th><th>功能</th></tr>\n</thead><tbody><tr>\n<td>appendonly yes|no</td><td>no</td><td>是否开启AOF</td></tr>\n<tr>\n<td>appendfsync always|everysec|no</td><td></td><td>持久化策略</td></tr>\n<tr>\n<td>appendfilename</td><td>appendonly.aof</td><td>AOF持久化文件名</td></tr>\n<tr>\n<td>dir</td><td></td><td>持久化文件目录</td></tr>\n</tbody></table></div></div><h2 id=\"优缺点-1\">优缺点<a href=\"#优缺点-1\" title=\"优缺点\"></a></h2><p><strong>优点</strong></p>\n<ul><li>存储速度快</li>\n<li>数据安全性相对RDB要高</li>\n<li>资源消耗小（没有Fork子进程）</li>\n</ul><p><strong>缺点</strong></p>\n<ul><li>文件体积大</li>\n<li>恢复速度慢</li>\n</ul>","prev":{"title":"Redis之主从复制","link":"post/中间件/Redis/Redis之主从复制"},"next":{"title":"Redis配置文件","link":"post/中间件/Redis/Redis配置文件"},"plink":"https://beginc.github.io/post/中间件/Redis/Redis之持久化/","toc":[{"id":"redis持久化机制","title":"Redis持久化机制","index":"1","children":[{"id":"内存快照rdb","title":"内存快照RDB","index":"1.1"},{"id":"日志aof","title":"日志AOF","index":"1.2"}]},{"id":"rdb","title":"RDB","index":"2","children":[{"id":"相关命令","title":"相关命令","index":"2.1"},{"id":"相关配置","title":"相关配置","index":"2.2"},{"id":"优缺点","title":"优缺点","index":"2.3"}]},{"id":"aof","title":"AOF","index":"3","children":[{"id":"持久化策略","title":"持久化策略","index":"3.1"},{"id":"aof重写","title":"AOF重写","index":"3.2","children":[{"id":"自动重写","title":"自动重写","index":"3.2.1"},{"id":"配置","title":"配置","index":"3.2.2"}]},{"id":"相关配置-1","title":"相关配置","index":"3.3"},{"id":"优缺点-1","title":"优缺点","index":"3.4"}]}]}