{"title":"TCP连接队列","date":"2020-02-28T04:24:02.000Z","date_formatted":{"ll":"Feb 28, 2020","L":"02/28/2020","MM-DD":"02-28"},"thumbnail":"post/计算机网络/TCP连接队列/cover.jpg","link":"post/计算机网络/TCP连接队列","categories":["计算机网络"],"updated":"2020-02-29T16:14:25.457Z","content":"<h1 id=\"连接队列\">连接队列<a href=\"#连接队列\" title=\"连接队列\"></a></h1><p>当服务端调用listen函数监听端口的时候，内核会为每个监听的socket创建两个队列</p>\n<ul><li>半连接队列(SYN Queue)</li>\n<li>全连接队列(Accept Queue)</li>\n</ul><h1 id=\"半连接队列\">半连接队列<a href=\"#半连接队列\" title=\"半连接队列\"></a></h1><p>在三次握手时，当服务端收到客户端的SYN段，发送完ACK + SYN段后，服务端进入SYN_RCVD状态，这个时候会将socket放入半连接队列里。</p>\n<img src=\"/post/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%E8%BF%9E%E6%8E%A5%E9%98%9F%E5%88%97/image-20200228132045224.png\" class=\"\">\n\n<h2 id=\"syn-flood攻击\">SYN Flood攻击<a href=\"#syn-flood攻击\" title=\"SYN Flood攻击\"></a></h2><p>SYN Flood攻击是DDoS攻击的一种，攻击者会发送大量SYN段给服务端，服务端会建立大量半连接，在半连接队列满时，服务端会忽略后续连接，导致工作异常。</p>\n<h3 id=\"解决方法\">解决方法<a href=\"#解决方法\" title=\"解决方法\"></a></h3><p><strong>syn_cookies</strong></p>\n<p>TODO</p>\n<h1 id=\"全连接队列\">全连接队列<a href=\"#全连接队列\" title=\"全连接队列\"></a></h1><p>当三次握手都完成后，服务端会将socket从半连接队列里移除，放入全连接队列里。</p>\n<h1 id=\"连接队列调优\">连接队列调优<a href=\"#连接队列调优\" title=\"连接队列调优\"></a></h1><h2 id=\"内核调优\">内核调优<a href=\"#内核调优\" title=\"内核调优\"></a></h2><p><strong>半连接队列大小</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> 4096 &gt; /proc/sys/net/ipv4/tcp_max_syn_backlog</span><br></pre></td></tr></table></figure>\n\n<p><strong>全连接队列大小</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> 4096 &gt; /proc/sys/net/core/somaxconn</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"应用调优\">应用调优<a href=\"#应用调优\" title=\"应用调优\"></a></h2><p><strong>listen(int sockfd, int backlog)</strong></p>\n<p>backlog参数可以控制连接队列大小</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">半连接队列长度 = min(backlog，net.core.somaxconn，tcp_max_syn_backlog)</span><br><span class=\"line\">全连接队列长度 = min(backlog，net.core.somaxconn)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"连接队列监控\">连接队列监控<a href=\"#连接队列监控\" title=\"连接队列监控\"></a></h2><p><strong>查看连接队列溢出次数</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">netstat -s | egrep <span class=\"string\">\"listen|LISTEN\"</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>查看全连接队列状态</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ss -lnt</span><br></pre></td></tr></table></figure>\n\n<img src=\"/post/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%E8%BF%9E%E6%8E%A5%E9%98%9F%E5%88%97/image-20200228143859044.png\" class=\"\">\n\n<ul><li>Send-Q表示全连接队列大小的最大值</li>\n<li>Recv-Q表示全连接队列的使用大小</li>\n</ul><h1 id=\"参考\">参考<a href=\"#参考\" title=\"参考\"></a></h1><ol><li><a href=\"https://zhuanlan.zhihu.com/p/99152064\" target=\"_blank\">TCP的全连接和半连接队列</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/77334450\" target=\"_blank\">成为高手前必懂的TCP干货</a></li>\n</ol>","prev":{"title":"8-Spring之纯注解开发","link":"post/Java/Spring/8-Spring之纯注解开发"},"next":{"title":"TCP状态转换","link":"post/计算机网络/TCP状态转换"},"plink":"https://beginc.github.io/post/计算机网络/TCP连接队列/","toc":[{"id":"连接队列","title":"连接队列","index":"1"},{"id":"半连接队列","title":"半连接队列","index":"2","children":[{"id":"syn-flood攻击","title":"SYN Flood攻击","index":"2.1","children":[{"id":"解决方法","title":"解决方法","index":"2.1.1"}]}]},{"id":"全连接队列","title":"全连接队列","index":"3"},{"id":"连接队列调优","title":"连接队列调优","index":"4","children":[{"id":"内核调优","title":"内核调优","index":"4.1"},{"id":"应用调优","title":"应用调优","index":"4.2"},{"id":"连接队列监控","title":"连接队列监控","index":"4.3"}]},{"id":"参考","title":"参考","index":"5"}]}