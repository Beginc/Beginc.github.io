{"title":"MySQL锁机制","date":"2020-02-12T08:31:24.000Z","date_formatted":{"ll":"Feb 12, 2020","L":"02/12/2020","MM-DD":"02-12"},"thumbnail":"post/数据库/MySQL/MySQL锁机制/cover.png","link":"post/数据库/MySQL/MySQL锁机制","categories":["MySQL","数据库"],"updated":"2020-03-11T16:08:41.973Z","content":"<h1 id=\"锁分类\">锁分类<a href=\"#锁分类\" title=\"锁分类\"></a></h1><h2 id=\"根据操作\">根据操作<a href=\"#根据操作\" title=\"根据操作\"></a></h2><p><strong>读锁</strong></p>\n<p>即共享锁，锁定时其他会话可以进行读，但不能写。</p>\n<p><strong>写锁</strong></p>\n<p>即排他锁，锁定时其他会话不能进行读，也不能进行写。</p>\n<h2 id=\"根据范围\">根据范围<a href=\"#根据范围\" title=\"根据范围\"></a></h2><p><strong>表锁</strong></p>\n<p>锁定一张表。开销小，加锁快，不会出现死锁，锁定的粒度大，容易发生冲突，并发度低。</p>\n<p><strong>行锁</strong></p>\n<p>只锁定一行数据。开销大，加锁慢，会出现死锁，锁定的粒度小，不容易发生冲突，并发度高。</p>\n<p><strong>页锁</strong></p>\n<p>TODO</p>\n<h1 id=\"表锁\">表锁<a href=\"#表锁\" title=\"表锁\"></a></h1><h2 id=\"加锁后的行为\">加锁后的行为<a href=\"#加锁后的行为\" title=\"加锁后的行为\"></a></h2><p>若对表T进行加锁的会话是A。</p>\n<p><strong>读锁</strong></p>\n<div class=\"cz\"><div class=\"db\"><table><thead><tr>\n<th style=\"padding:0\"></th><th>读：表T</th><th>写：表T</th><th>读：其他表</th><th>写：其他表</th></tr>\n</thead><tbody><tr>\n<td>会话A</td><td>允许</td><td>不允许</td><td>不允许</td><td>不允许</td></tr>\n<tr>\n<td>其他会话</td><td>允许</td><td>不允许</td><td>允许</td><td>允许</td></tr>\n</tbody></table></div></div><p><strong>写锁</strong></p>\n<div class=\"cz\"><div class=\"db\"><table><thead><tr>\n<th style=\"padding:0\"></th><th>读：表T</th><th>写：表T</th><th>读：其他表</th><th>写：其他表</th></tr>\n</thead><tbody><tr>\n<td>会话A</td><td>允许</td><td>允许</td><td>不允许</td><td>不允许</td></tr>\n<tr>\n<td>其他会话</td><td>不允许</td><td>不允许</td><td>允许</td><td>允许</td></tr>\n</tbody></table></div></div><h2 id=\"锁操作\">锁操作<a href=\"#锁操作\" title=\"锁操作\"></a></h2><h3 id=\"读锁\">读锁<a href=\"#读锁\" title=\"读锁\"></a></h3><p><strong>加锁</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">lock</span> <span class=\"keyword\">table</span> 表名 <span class=\"keyword\">read</span>;</span><br></pre></td></tr></table></figure>\n\n<p><strong>解锁</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">unlock</span> <span class=\"keyword\">tables</span>;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"写锁\">写锁<a href=\"#写锁\" title=\"写锁\"></a></h3><p><strong>加锁</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">lock</span> <span class=\"keyword\">table</span> 表名 write;</span><br></pre></td></tr></table></figure>\n\n<p><strong>解锁</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">unlock</span> <span class=\"keyword\">tables</span>;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"查看锁定状态\">查看锁定状态<a href=\"#查看锁定状态\" title=\"查看锁定状态\"></a></h3><p><strong>查看哪些表加了锁</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">show</span> <span class=\"keyword\">open</span> <span class=\"keyword\">tables</span>;</span><br></pre></td></tr></table></figure>\n\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%E9%94%81%E6%9C%BA%E5%88%B6/1.png\" class=\"\">\n\n<p><strong>查看锁定表数量</strong></p>\n<ul><li>Table_locks_immediate未被上锁的表的数量</li>\n<li>Table_locks_waited被上锁的表的数量</li>\n</ul><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">show</span> <span class=\"keyword\">status</span> <span class=\"keyword\">like</span> <span class=\"string\">'table%'</span>;</span><br></pre></td></tr></table></figure>\n\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%E9%94%81%E6%9C%BA%E5%88%B6/2.png\" class=\"\">\n\n<h1 id=\"行锁\">行锁<a href=\"#行锁\" title=\"行锁\"></a></h1><h2 id=\"加锁后的行为-1\">加锁后的行为<a href=\"#加锁后的行为-1\" title=\"加锁后的行为\"></a></h2><p>若对行T进行加锁的会话是A。</p>\n<p><strong>读锁</strong></p>\n<div class=\"cz\"><div class=\"db\"><table><thead><tr>\n<th style=\"padding:0\"></th><th>读：行T</th><th>写：行T</th><th>读：其他行</th><th>写：其他行</th></tr>\n</thead><tbody><tr>\n<td>会话A</td><td>允许</td><td>允许</td><td>允许</td><td>允许</td></tr>\n<tr>\n<td>其他会话</td><td>允许</td><td>不允许</td><td>允许</td><td>允许</td></tr>\n</tbody></table></div></div><p><strong>写锁</strong></p>\n<div class=\"cz\"><div class=\"db\"><table><thead><tr>\n<th style=\"padding:0\"></th><th>读：行T</th><th>写：行T</th><th>读：其他行</th><th>写：其他行</th></tr>\n</thead><tbody><tr>\n<td>会话A</td><td>允许</td><td>允许</td><td>允许</td><td>允许</td></tr>\n<tr>\n<td>其他会话</td><td>允许</td><td>不允许</td><td>允许</td><td>允许</td></tr>\n</tbody></table></div></div><h2 id=\"锁操作-1\">锁操作<a href=\"#锁操作-1\" title=\"锁操作\"></a></h2><h3 id=\"加锁\">加锁<a href=\"#加锁\" title=\"加锁\"></a></h3><p><strong>隐式加锁</strong></p>\n<p>自动加锁。</p>\n<p><strong>显示加锁</strong></p>\n<ol><li>for update</li>\n</ol><p>上排他锁。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> * <span class=\"keyword\">from</span> 表名 <span class=\"keyword\">for</span> <span class=\"keyword\">update</span></span><br></pre></td></tr></table></figure>\n\n<ol><li>lock in share mode</li>\n</ol><p>上共享锁。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> * <span class=\"keyword\">from</span> 表名 <span class=\"keyword\">lock</span> <span class=\"keyword\">in</span> <span class=\"keyword\">share</span> <span class=\"keyword\">mode</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"解锁\">解锁<a href=\"#解锁\" title=\"解锁\"></a></h3><p>提交事务或者回滚事务时解除锁定。</p>\n<h1 id=\"不同存储引擎的锁模式\">不同存储引擎的锁模式<a href=\"#不同存储引擎的锁模式\" title=\"不同存储引擎的锁模式\"></a></h1><h2 id=\"myisam\">MyISAM<a href=\"#myisam\" title=\"MyISAM\"></a></h2><ul><li>采用表锁。</li>\n<li>查询时自动给涉及的所有表加读锁。</li>\n<li>更新时自动给涉及的表加写锁。</li>\n</ul><p>因为是一次性获取所需要的全部锁，所以不会产生死锁。</p>\n<h2 id=\"innodb\">InnoDB<a href=\"#innodb\" title=\"InnoDB\"></a></h2><h3 id=\"锁种类\">锁种类<a href=\"#锁种类\" title=\"锁种类\"></a></h3><p>InnoDB使用行锁与表锁共存。</p>\n<p><strong>行锁</strong></p>\n<ul><li>共享锁</li>\n<li>排他锁</li>\n</ul><p><strong>表锁</strong></p>\n<ul><li>意向共享锁<ul><li>事务在给一个数据行加共享锁前必须先取得该表的 IS 锁。</li>\n</ul></li>\n<li>意向排他锁<ul><li>事务在给一个数据行加排他锁前必须先取得该表的 IX 锁。</li>\n</ul></li>\n</ul><h3 id=\"锁模式兼容\">锁模式兼容<a href=\"#锁模式兼容\" title=\"锁模式兼容\"></a></h3><ul><li>意向锁之间不冲突。</li>\n<li>表被意向共享锁锁定后不能加排他锁。</li>\n<li>表被意向排他锁锁定后不能加排他锁和共享锁。</li>\n</ul><img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%E9%94%81%E6%9C%BA%E5%88%B6/3.jpg\" class=\"\">\n\n<h3 id=\"锁操作-2\">锁操作<a href=\"#锁操作-2\" title=\"锁操作\"></a></h3><h4 id=\"加锁-1\">加锁<a href=\"#加锁-1\" title=\"加锁\"></a></h4><p><strong>隐式加锁</strong></p>\n<ul><li>意向锁由InnoDB自动加。</li>\n<li>UPDATE, DELETE, INSERT操作InnoDB自动加排他锁。</li>\n<li>SELECT语句InnoDB不会自动加任何锁。</li>\n</ul><p><strong>显示加锁</strong></p>\n<ol><li>for update</li>\n</ol><p>上排他锁。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> * <span class=\"keyword\">from</span> 表名 <span class=\"keyword\">for</span> <span class=\"keyword\">update</span></span><br></pre></td></tr></table></figure>\n\n<ol><li>lock in share mode</li>\n</ol><p>上共享锁。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> * <span class=\"keyword\">from</span> 表名 <span class=\"keyword\">lock</span> <span class=\"keyword\">in</span> <span class=\"keyword\">share</span> <span class=\"keyword\">mode</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"解锁-1\">解锁<a href=\"#解锁-1\" title=\"解锁\"></a></h4><p>锁只有在执行commit或者rollback的时候才会释放，并且所有的锁都是在<strong>同一时刻</strong>被释放。</p>\n<h3 id=\"间隙锁\">间隙锁<a href=\"#间隙锁\" title=\"间隙锁\"></a></h3><p>当语句带有范围时，如<code>update people set name = &#39;p&#39; where id &lt; 4</code>, 此时若加行锁，则id为1,2,3的行都会加上行锁，<strong>若id为2的行不存在，也会加上行锁</strong>。</p>\n<p><strong>目的</strong></p>\n<p>解决幻读</p>\n<h3 id=\"innodb行锁实现\">InnoDB行锁实现<a href=\"#innodb行锁实现\" title=\"InnoDB行锁实现\"></a></h3><p>InnoDB行锁是通过给索引上的索引项加锁来实现的。</p>\n<ul><li><strong>只有通过索引检索数据时才加行锁，否则直接用表锁</strong></li>\n</ul><h1 id=\"死锁问题\">死锁问题<a href=\"#死锁问题\" title=\"死锁问题\"></a></h1><p>TODO</p>\n","prev":{"title":"MySQL主从复制","link":"post/数据库/MySQL/MySQL主从复制"},"next":{"title":"5-SQL优化之索引优化","link":"post/数据库/MySQL/5-SQL优化之索引优化"},"plink":"https://beginc.github.io/post/数据库/MySQL/MySQL锁机制/","toc":[{"id":"锁分类","title":"锁分类","index":"1","children":[{"id":"根据操作","title":"根据操作","index":"1.1"},{"id":"根据范围","title":"根据范围","index":"1.2"}]},{"id":"表锁","title":"表锁","index":"2","children":[{"id":"加锁后的行为","title":"加锁后的行为","index":"2.1"},{"id":"锁操作","title":"锁操作","index":"2.2","children":[{"id":"读锁","title":"读锁","index":"2.2.1"},{"id":"写锁","title":"写锁","index":"2.2.2"},{"id":"查看锁定状态","title":"查看锁定状态","index":"2.2.3"}]}]},{"id":"行锁","title":"行锁","index":"3","children":[{"id":"加锁后的行为-1","title":"加锁后的行为","index":"3.1"},{"id":"锁操作-1","title":"锁操作","index":"3.2","children":[{"id":"加锁","title":"加锁","index":"3.2.1"},{"id":"解锁","title":"解锁","index":"3.2.2"}]}]},{"id":"不同存储引擎的锁模式","title":"不同存储引擎的锁模式","index":"4","children":[{"id":"myisam","title":"MyISAM","index":"4.1"},{"id":"innodb","title":"InnoDB","index":"4.2","children":[{"id":"锁种类","title":"锁种类","index":"4.2.1"},{"id":"锁模式兼容","title":"锁模式兼容","index":"4.2.2"},{"id":"锁操作-2","title":"锁操作","index":"4.2.3"},{"id":"间隙锁","title":"间隙锁","index":"4.2.4"},{"id":"innodb行锁实现","title":"InnoDB行锁实现","index":"4.2.5"}]}]},{"id":"死锁问题","title":"死锁问题","index":"5"}]}