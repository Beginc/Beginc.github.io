{"title":"数据库故障恢复","date":"2020-03-12T05:17:12.000Z","date_formatted":{"ll":"Mar 12, 2020","L":"03/12/2020","MM-DD":"03-12"},"thumbnail":"post/数据库/数据库原理/数据库故障恢复/cover.jpg","link":"post/数据库/数据库原理/数据库故障恢复","categories":["数据库","数据库原理"],"updated":"2020-03-13T16:13:38.975Z","content":"<h1 id=\"故障恢复\">故障恢复<a href=\"#故障恢复\" title=\"故障恢复\"></a></h1><h2 id=\"恢复手段\">恢复手段<a href=\"#恢复手段\" title=\"恢复手段\"></a></h2><h3 id=\"重做事务redo\">重做事务Redo<a href=\"#重做事务redo\" title=\"重做事务Redo\"></a></h3><p>保证已经提交的事务的持久性。</p>\n<h3 id=\"撤销事务undo\">撤销事务Undo<a href=\"#撤销事务undo\" title=\"撤销事务Undo\"></a></h3><p>保证未提交事务的原子性。</p>\n<h2 id=\"运行日志\">运行日志<a href=\"#运行日志\" title=\"运行日志\"></a></h2><p>即Redis中的AOF。</p>\n<ol><li>先写运行日志</li>\n<li>再进行数据库操作</li>\n</ol><p><strong>日志信息</strong></p>\n<ul><li><Start T>开始事务</li>\n<li><Commit T>提交事务</li>\n<li><Abort T>回滚事务</li>\n<li>&lt;T, X, oldValue, newValue&gt;事务改变了数据</li>\n</ul><h2 id=\"检查点\">检查点<a href=\"#检查点\" title=\"检查点\"></a></h2><p>在检查点时刻，数据库管理系统强制把缓存中的数据刷新到磁盘中</p>\n<ul><li>在检查点之前内存中和磁盘中数据具有一致性</li>\n<li>检查点之前提交的事务不需要恢复</li>\n<li>检查点之后提交的事务故障时需要<strong>Redo</strong></li>\n<li>检查点之后还未提交的事务需要<strong>Undo</strong></li>\n</ul><h2 id=\"刷盘策略\">刷盘策略<a href=\"#刷盘策略\" title=\"刷盘策略\"></a></h2><p>讨论何时将缓冲区内容同步到磁盘中。</p>\n<p><strong>Force</strong></p>\n<p>最晚在commit时刷盘。</p>\n<p><strong>No Force</strong></p>\n<p>在事务commit过后一段时间再刷盘。</p>\n<p><strong>No Steal</strong></p>\n<p>不允许在事务commit之前刷盘。</p>\n<p><strong>Steal</strong></p>\n<p>允许在事务commit之前刷盘。</p>\n<h2 id=\"日志类型\">日志类型<a href=\"#日志类型\" title=\"日志类型\"></a></h2><h3 id=\"undo日志\">Undo日志<a href=\"#undo日志\" title=\"Undo日志\"></a></h3><h4 id=\"记录顺序\">记录顺序<a href=\"#记录顺序\" title=\"记录顺序\"></a></h4><p>数据写到磁盘之前不能提交</p>\n<ol><li>&lt;T, x, oldValue&gt;</li>\n<li>Output(x)刷盘</li>\n<li>&lt;Commit T&gt; / &lt;Abort T&gt;</li>\n</ol><h4 id=\"恢复\">恢复<a href=\"#恢复\" title=\"恢复\"></a></h4><p>对找不到<Commit T>或<Abort T>的数据，按日志<strong>逆序</strong>，对数据进行恢复（获取oldValue写入）。</p>\n<h3 id=\"redo日志\">Redo日志<a href=\"#redo日志\" title=\"Redo日志\"></a></h3><h4 id=\"记录顺序-1\">记录顺序<a href=\"#记录顺序-1\" title=\"记录顺序\"></a></h4><p>先提交事务再刷盘。</p>\n<ol><li>&lt;T, x, newValue&gt;</li>\n<li>&lt;Commit T&gt; / &lt;Abort T&gt; </li>\n<li>Output(x)刷盘</li>\n</ol><h4 id=\"恢复-1\">恢复<a href=\"#恢复-1\" title=\"恢复\"></a></h4><p>对已经提交的事务，按日志<strong>顺序</strong>，重做已提交的所有修改（获取newValue写入）。</p>\n<h3 id=\"undoredo日志\">Undo/Redo日志<a href=\"#undoredo日志\" title=\"Undo/Redo日志\"></a></h3><h4 id=\"记录顺序-2\">记录顺序<a href=\"#记录顺序-2\" title=\"记录顺序\"></a></h4><p>先提交事务再刷盘。</p>\n<ol><li>&lt;T, x, oldValue, newValue&gt;</li>\n<li><Commit T> / <Abort T> 和Output(x)顺序无所谓</li>\n</ol><h4 id=\"恢复-2\">恢复<a href=\"#恢复-2\" title=\"恢复\"></a></h4><ul><li>自前向后重做所有已提交的事务</li>\n<li>自后向前撤销所有未提交的事务</li>\n</ul>","prev":{"title":"MySQL事务","link":"post/数据库/MySQL/MySQL事务"},"next":{"title":"数据库并发控制","link":"post/数据库/数据库原理/数据库并发控制"},"plink":"https://beginc.github.io/post/数据库/数据库原理/数据库故障恢复/","toc":[{"id":"故障恢复","title":"故障恢复","index":"1","children":[{"id":"恢复手段","title":"恢复手段","index":"1.1","children":[{"id":"重做事务redo","title":"重做事务Redo","index":"1.1.1"},{"id":"撤销事务undo","title":"撤销事务Undo","index":"1.1.2"}]},{"id":"运行日志","title":"运行日志","index":"1.2"},{"id":"检查点","title":"检查点","index":"1.3"},{"id":"刷盘策略","title":"刷盘策略","index":"1.4"},{"id":"日志类型","title":"日志类型","index":"1.5","children":[{"id":"undo日志","title":"Undo日志","index":"1.5.1"},{"id":"redo日志","title":"Redo日志","index":"1.5.2"},{"id":"undoredo日志","title":"Undo&#x2F;Redo日志","index":"1.5.3"}]}]}]}