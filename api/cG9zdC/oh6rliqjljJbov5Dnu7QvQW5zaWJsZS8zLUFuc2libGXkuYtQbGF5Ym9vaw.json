{"title":"3-Ansible之Playbook","date":"2020-02-06T10:30:24.000Z","date_formatted":{"ll":"Feb 6, 2020","L":"02/06/2020","MM-DD":"02-06"},"thumbnail":"post/自动化运维/Ansible/3-Ansible之Playbook/cover.png","link":"post/自动化运维/Ansible/3-Ansible之Playbook","categories":["Ansible","自动化运维"],"updated":"2020-02-08T02:53:49.407Z","content":"<h1 id=\"playbook简介\">Playbook简介<a href=\"#playbook简介\" title=\"Playbook简介\"></a></h1><p><code>Playbook</code>通过<code>YAML</code>配置的方式，组织多个命令的执行，完成一系列复杂的任务。</p>\n<h1 id=\"playbook核心元素\">Playbook核心元素<a href=\"#playbook核心元素\" title=\"Playbook核心元素\"></a></h1><h2 id=\"常用通用信息\">常用通用信息<a href=\"#常用通用信息\" title=\"常用通用信息\"></a></h2><h3 id=\"hosts\">hosts<a href=\"#hosts\" title=\"hosts\"></a></h3><p>指定主机列表。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># 指定主机列表为mq组内所有主机</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">hosts:</span> <span class=\"string\">mq</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"remote_user\">remote_user<a href=\"#remote_user\" title=\"remote_user\"></a></h3><p>指定远程执行命令的用户。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># 指定主机列表为mq组内所有主机</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">hosts:</span> <span class=\"string\">mq</span></span><br><span class=\"line\">  <span class=\"comment\"># 远程以root用户运行</span></span><br><span class=\"line\">  <span class=\"attr\">remote_user:</span> <span class=\"string\">root</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"gather_facts\">gather_facts<a href=\"#gather_facts\" title=\"gather_facts\"></a></h3><p>指定是否收集主机信息。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># 指定主机列表为mq组内所有主机</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">hosts:</span> <span class=\"string\">mq</span></span><br><span class=\"line\">  <span class=\"comment\"># 远程以root用户运行</span></span><br><span class=\"line\">  <span class=\"attr\">remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\">  <span class=\"attr\">vars_files:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">vars.yml</span></span><br><span class=\"line\">  <span class=\"attr\">gather_facts:</span> <span class=\"literal\">no</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"任务\">任务<a href=\"#任务\" title=\"任务\"></a></h2><p>指定一系列任务。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># 指定主机列表为mq组内所有主机</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">hosts:</span> <span class=\"string\">mq</span></span><br><span class=\"line\">  <span class=\"comment\"># 远程以root用户运行</span></span><br><span class=\"line\">  <span class=\"attr\">remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">task:</span></span><br><span class=\"line\">      <span class=\"comment\"># name指定任务名称</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Create</span> <span class=\"string\">a</span> <span class=\"string\">file</span></span><br><span class=\"line\">      <span class=\"comment\"># 模块名：参数</span></span><br><span class=\"line\">      <span class=\"attr\">file:</span> <span class=\"string\">path=~/hello.txt</span> <span class=\"string\">state=touch</span></span><br><span class=\"line\">      <span class=\"comment\"># 指定sudo用户</span></span><br><span class=\"line\">      <span class=\"attr\">sudo_user:</span> <span class=\"string\">test</span></span><br><span class=\"line\">      <span class=\"comment\"># 使用sudo执行</span></span><br><span class=\"line\">      <span class=\"attr\">sudo:</span> <span class=\"literal\">yes</span></span><br><span class=\"line\">      <span class=\"comment\"># 若执行错误，是否忽略，继续往下执行</span></span><br><span class=\"line\">      <span class=\"attr\">ignore_errors:</span> <span class=\"literal\">True</span></span><br><span class=\"line\">      <span class=\"comment\"># 指定标签</span></span><br><span class=\"line\">      <span class=\"attr\">tags:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">tag1</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">tag2</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"变量\">变量<a href=\"#变量\" title=\"变量\"></a></h2><h3 id=\"playbook变量来源\">Playbook变量来源<a href=\"#playbook变量来源\" title=\"Playbook变量来源\"></a></h3><h4 id=\"命令行中定义变量\">命令行中定义变量<a href=\"#命令行中定义变量\" title=\"命令行中定义变量\"></a></h4><p>使用<code>-e</code>定义变量。此种方式定义的变量优先级最高。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ansible-playbook -e <span class=\"string\">'filename=hello.txt'</span> playbook.yml</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"hosts文件中定义变量\">hosts文件中定义变量<a href=\"#hosts文件中定义变量\" title=\"hosts文件中定义变量\"></a></h4><p><strong>组变量</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[mq]</span></span><br><span class=\"line\">192.168.31.101</span><br><span class=\"line\">192.168.31.102</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[mq:vars]</span></span><br><span class=\"line\"><span class=\"attr\">filename</span>=hello.txt</span><br></pre></td></tr></table></figure>\n\n<p><strong>主机变量</strong>\n优先级高于组变量。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[mq]</span></span><br><span class=\"line\">192.168.31.101 filename=another.txt</span><br><span class=\"line\">192.168.31.102</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[mq:vars]</span></span><br><span class=\"line\"><span class=\"attr\">filename</span>=hello.txt</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"独立的变量yaml文件中定义变量\">独立的变量YAML文件中定义变量<a href=\"#独立的变量yaml文件中定义变量\" title=\"独立的变量YAML文件中定义变量\"></a></h4><p>标准的变量定义文件应该放在<code>vars</code>目录下，则可以直接引用。</p>\n<p><strong>vars/vars.yml</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">filename:</span> <span class=\"string\">hello.txt</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>playbook.yml</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># 指定主机列表为mq组内所有主机</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">hosts:</span> <span class=\"string\">mq</span></span><br><span class=\"line\">  <span class=\"comment\"># 远程以root用户运行</span></span><br><span class=\"line\">  <span class=\"attr\">remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\">  <span class=\"attr\">vars_files:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">vars.yaml</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">task:</span></span><br><span class=\"line\">      <span class=\"comment\"># name指定任务名称</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Create</span> <span class=\"string\">a</span> <span class=\"string\">file</span></span><br><span class=\"line\">      <span class=\"comment\"># 模块名：参数</span></span><br><span class=\"line\">      <span class=\"attr\">file:</span> <span class=\"string\">path=~/&#123;&#123;</span> <span class=\"string\">filename</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">state=touch</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"playbook中定义变量\">Playbook中定义变量<a href=\"#playbook中定义变量\" title=\"Playbook中定义变量\"></a></h4><p>使用<code>vars</code>定义变量。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># 指定主机列表为mq组内所有主机</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">hosts:</span> <span class=\"string\">mq</span></span><br><span class=\"line\">  <span class=\"comment\"># 远程以root用户运行</span></span><br><span class=\"line\">  <span class=\"attr\">remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\">  <span class=\"attr\">vars:</span></span><br><span class=\"line\">    <span class=\"attr\">filename:</span> <span class=\"string\">hello.txt</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">task:</span></span><br><span class=\"line\">      <span class=\"comment\"># name指定任务名称</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Create</span> <span class=\"string\">a</span> <span class=\"string\">file</span></span><br><span class=\"line\">      <span class=\"comment\"># 模块名：参数</span></span><br><span class=\"line\">      <span class=\"attr\">file:</span> <span class=\"string\">path=~/&#123;&#123;</span> <span class=\"string\">filename</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">state=touch</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"调用setup模块的变量\">调用setup模块的变量<a href=\"#调用setup模块的变量\" title=\"调用setup模块的变量\"></a></h4><p><code>setup</code>模块用于收集远程机器信息，可直接使用其变量，这种变量称为<code>facts</code>。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># 指定主机列表为mq组内所有主机</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">hosts:</span> <span class=\"string\">mq</span></span><br><span class=\"line\">  <span class=\"comment\"># 远程以root用户运行</span></span><br><span class=\"line\">  <span class=\"attr\">remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">task:</span></span><br><span class=\"line\">      <span class=\"comment\"># name指定任务名称</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Create</span> <span class=\"string\">a</span> <span class=\"string\">file</span></span><br><span class=\"line\">      <span class=\"comment\"># 模块名：参数</span></span><br><span class=\"line\">      <span class=\"attr\">file:</span> <span class=\"string\">path=~/&#123;&#123;</span> <span class=\"string\">ansible_fqdn</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">state=touch</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"处理器\">处理器<a href=\"#处理器\" title=\"处理器\"></a></h2><p>有些时候我们希望一些命令执行后才通知其他一些命令执行，如配置文件发生改变，重新进行了分发时，我们希望重启服务。此时我们需要使用<code>handlers</code>和<code>notify</code></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 指定主机列表为mq组内所有主机</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">hosts:</span> <span class=\"string\">mq</span></span><br><span class=\"line\">  <span class=\"comment\"># 远程以root用户运行</span></span><br><span class=\"line\">  <span class=\"attr\">remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\">  <span class=\"attr\">vars:</span></span><br><span class=\"line\">    <span class=\"attr\">filename:</span> <span class=\"string\">hello.txt</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">task:</span></span><br><span class=\"line\">      <span class=\"comment\"># name指定任务名称</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Create</span> <span class=\"string\">a</span> <span class=\"string\">file</span></span><br><span class=\"line\">      <span class=\"comment\"># 模块名：参数</span></span><br><span class=\"line\">      <span class=\"attr\">file:</span> <span class=\"string\">path=~/&#123;&#123;</span> <span class=\"string\">filename</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">state=touch</span></span><br><span class=\"line\">      <span class=\"attr\">notify:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">Create</span> <span class=\"string\">another</span> <span class=\"string\">file</span></span><br><span class=\"line\">  <span class=\"attr\">handlers:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">create</span> <span class=\"string\">another</span> <span class=\"string\">file</span></span><br><span class=\"line\">      <span class=\"attr\">file:</span> <span class=\"string\">path=~/another_&#123;&#123;</span> <span class=\"string\">filename</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">state=touch</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"模板\">模板<a href=\"#模板\" title=\"模板\"></a></h2><p>有时候我们希望根据主机的一些信息动态进行配置文件编写，此时我们需要使用模板技术，<code>Ansible</code>使用<code>Jinja2</code>语言提供模板技术。</p>\n<h3 id=\"模板文件\">模板文件<a href=\"#模板文件\" title=\"模板文件\"></a></h3><ul><li><code>template</code>命令来分发配置文件<ul><li><code>src</code>模板文件路径</li>\n<li><code>dest</code>目标路径</li>\n<li><code>backup</code>是否备份</li>\n<li><code>group</code></li>\n<li><code>owner</code></li>\n<li><code>mode</code></li>\n</ul></li>\n<li>模板文件应以<code>.j2</code>结尾</li>\n</ul><p><strong>playbook.yml</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># 指定主机列表为mq组内所有主机</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">hosts:</span> <span class=\"string\">mq</span></span><br><span class=\"line\">  <span class=\"comment\"># 远程以root用户运行</span></span><br><span class=\"line\">  <span class=\"attr\">remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\">  <span class=\"attr\">vars:</span></span><br><span class=\"line\">    <span class=\"attr\">items:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">C</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">Java</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">Python</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">task:</span></span><br><span class=\"line\">      <span class=\"comment\"># name指定任务名称</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Distribute</span> <span class=\"string\">conf</span> <span class=\"string\">file</span></span><br><span class=\"line\">      <span class=\"attr\">template:</span> <span class=\"string\">src=conf.j2</span> <span class=\"string\">dest=~/conf</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>模板文件templates/conf.j2</strong>\n模板文件放在标准目录<code>templates</code>下，可直接引用。</p>\n<ul><li><code>for</code>进行循环</li>\n<li><code>if</code>进行判断</li>\n</ul><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 若定义了该变量则执行</span></span><br><span class=\"line\">&#123;% <span class=\"keyword\">if</span> items <span class=\"keyword\">is</span> defined %&#125;</span><br><span class=\"line\">  <span class=\"comment\"># 循环写入</span></span><br><span class=\"line\">  &#123;% <span class=\"keyword\">for</span> item <span class=\"keyword\">in</span> items %&#125;</span><br><span class=\"line\">    &#123;&#123; item &#125;&#125;</span><br><span class=\"line\">  &#123;% endfor%&#125;</span><br><span class=\"line\">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"when\">when<a href=\"#when\" title=\"when\"></a></h3><p>条件测试，当为真时才执行命令。</p>\n<ul><li>在任务中指定<code>when</code>, <code>when</code>支持<code>Jinja2</code>语法</li>\n</ul><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># 指定主机列表为mq组内所有主机</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">hosts:</span> <span class=\"string\">mq</span></span><br><span class=\"line\">  <span class=\"comment\"># 远程以root用户运行</span></span><br><span class=\"line\">  <span class=\"attr\">remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">task:</span></span><br><span class=\"line\">      <span class=\"comment\"># name指定任务名称</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Create</span> <span class=\"string\">a</span> <span class=\"string\">file</span></span><br><span class=\"line\">      <span class=\"attr\">file:</span> <span class=\"string\">path=~/hello.txt</span> <span class=\"string\">state=touch</span></span><br><span class=\"line\">      <span class=\"comment\"># 当主机ip为192.168.31.101时，才创建文件</span></span><br><span class=\"line\">      <span class=\"attr\">when:</span> <span class=\"string\">ansible_all_ipv4_addresses</span> <span class=\"string\">==</span> <span class=\"string\">\"192.168.31.101\"</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"ansible-playbook命令使用\">ansible-playbook命令使用<a href=\"#ansible-playbook命令使用\" title=\"ansible-playbook命令使用\"></a></h1><ol><li>直接运行一个Playbook</li>\n</ol><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ansible-playbook playbook.yml</span><br></pre></td></tr></table></figure>\n\n<ol><li>检查运行一个Playbook\n只检测可能会发生的改变，但不真正执行操作。</li>\n</ol><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ansible-playbook -C playbook.yml</span><br></pre></td></tr></table></figure>\n\n<ol><li>指定其他参数</li>\n</ol><ul><li><code>--list-hosts</code>列出运行任务的主机</li>\n<li><code>--list-tags</code>列出playbook文件中定义所有的tags</li>\n<li><code>--list-tasks</code>列出playbook文件中定义的所有task</li>\n<li><code>--limit</code>只针对主机列表中的某个主机或者某个组执行</li>\n<li><code>-f</code>指定并发数，默认为5个</li>\n<li><code>-t</code>指定tags运行，运行某一个或者多个tags的任务</li>\n<li><code>-v</code>显示过程<code>-vv</code>, <code>-vvv</code>更详细</li>\n</ul><h1 id=\"playbook示例\">Playbook示例<a href=\"#playbook示例\" title=\"Playbook示例\"></a></h1><p><strong>运行RocketMQ NameServer集群</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">hosts:</span> <span class=\"string\">mq</span></span><br><span class=\"line\">  <span class=\"attr\">remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\">  <span class=\"attr\">vars:</span></span><br><span class=\"line\">    <span class=\"attr\">archive_filename:</span> <span class=\"string\">rocketmq-all-4.6.0-bin-release.zip</span></span><br><span class=\"line\">    <span class=\"attr\">unarchive_filename:</span> <span class=\"string\">rocketmq-all-4.6.0-bin-release</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"attr\">tasks:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">copy</span></span><br><span class=\"line\">      <span class=\"attr\">copy:</span> <span class=\"string\">src=&#123;&#123;</span> <span class=\"string\">archive_filename</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">dest=/opt</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">unzip</span></span><br><span class=\"line\">      <span class=\"attr\">unarchive:</span></span><br><span class=\"line\">        <span class=\"attr\">src:</span> <span class=\"string\">/opt/&#123;&#123;</span> <span class=\"string\">archive_filename</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">        <span class=\"attr\">dest:</span> <span class=\"string\">/usr/local</span></span><br><span class=\"line\">        <span class=\"attr\">creates:</span> <span class=\"string\">/usr/local/&#123;&#123;</span> <span class=\"string\">unarchive_filename</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">        <span class=\"attr\">remote_src:</span> <span class=\"literal\">yes</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">rename</span></span><br><span class=\"line\">      <span class=\"attr\">shell:</span></span><br><span class=\"line\">        <span class=\"attr\">cmd:</span> <span class=\"string\">mv</span> <span class=\"string\">/usr/local/&#123;&#123;</span> <span class=\"string\">unarchive_filename</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">/usr/local/rocketmq</span></span><br><span class=\"line\">        <span class=\"attr\">creates:</span> <span class=\"string\">/usr/local/rocketmq</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">check</span> <span class=\"string\">env</span></span><br><span class=\"line\">      <span class=\"attr\">shell:</span> <span class=\"string\">ls</span> <span class=\"string\">/etc/bashrc</span></span><br><span class=\"line\">      <span class=\"attr\">register:</span> <span class=\"string\">bashrc</span></span><br><span class=\"line\">      <span class=\"attr\">changed_when:</span> <span class=\"literal\">True</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">set</span> <span class=\"string\">env</span></span><br><span class=\"line\">      <span class=\"attr\">shell:</span> <span class=\"string\">echo</span> <span class=\"string\">PATH='$PATH':/usr/local/rocketmq/bin</span> <span class=\"string\">&gt;&gt;</span> <span class=\"string\">/etc/bashrc</span></span><br><span class=\"line\">      <span class=\"attr\">when:</span> <span class=\"string\">not</span> <span class=\"string\">bashrc.stdout</span> <span class=\"string\">is</span> <span class=\"string\">search('PATH=$PATH:/usr/local/rocketmq/bin')</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">start</span> <span class=\"string\">name</span> <span class=\"string\">server</span></span><br><span class=\"line\">      <span class=\"attr\">shell:</span> <span class=\"string\">nohup</span> <span class=\"string\">mqnamesrv</span> <span class=\"string\">&gt;</span> <span class=\"string\">/dev/null</span> <span class=\"number\">2</span><span class=\"string\">&gt;&amp;1</span> <span class=\"string\">&amp;</span></span><br></pre></td></tr></table></figure>\n\n","prev":{"title":"3-Ansible之Roles","link":"post/自动化运维/Ansible/4-Ansible之Roles"},"next":{"title":"2-Ansible模块","link":"post/自动化运维/Ansible/2-Ansible模块"},"plink":"https://beginc.github.io/post/自动化运维/Ansible/3-Ansible之Playbook/","toc":[{"id":"playbook简介","title":"Playbook简介","index":"1"},{"id":"playbook核心元素","title":"Playbook核心元素","index":"2","children":[{"id":"常用通用信息","title":"常用通用信息","index":"2.1","children":[{"id":"hosts","title":"hosts","index":"2.1.1"},{"id":"remote_user","title":"remote_user","index":"2.1.2"},{"id":"gather_facts","title":"gather_facts","index":"2.1.3"}]},{"id":"任务","title":"任务","index":"2.2"},{"id":"变量","title":"变量","index":"2.3","children":[{"id":"playbook变量来源","title":"Playbook变量来源","index":"2.3.1"}]},{"id":"处理器","title":"处理器","index":"2.4"},{"id":"模板","title":"模板","index":"2.5","children":[{"id":"模板文件","title":"模板文件","index":"2.5.1"},{"id":"when","title":"when","index":"2.5.2"}]}]},{"id":"ansible-playbook命令使用","title":"ansible-playbook命令使用","index":"3"},{"id":"playbook示例","title":"Playbook示例","index":"4"}]}