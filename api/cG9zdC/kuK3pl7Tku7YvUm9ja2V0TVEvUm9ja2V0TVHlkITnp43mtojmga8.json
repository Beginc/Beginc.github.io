{"title":"RocketMQ各种消息","date":"2020-02-26T02:30:29.000Z","date_formatted":{"ll":"Feb 26, 2020","L":"02/26/2020","MM-DD":"02-26"},"thumbnail":"post/中间件/RocketMQ/RocketMQ各种消息/cover.png","link":"post/中间件/RocketMQ/RocketMQ各种消息","categories":["RocketMQ","中间件"],"updated":"2020-02-29T16:17:08.392Z","content":"<h1 id=\"环境搭建\">环境搭建<a href=\"#环境搭建\" title=\"环境搭建\"></a></h1><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">project</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">\"http://maven.apache.org/POM/4.0.0\"</span></span></span><br><span class=\"line\"><span class=\"tag\">         <span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">\"http://www.w3.org/2001/XMLSchema-instance\"</span></span></span><br><span class=\"line\"><span class=\"tag\">         <span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">modelVersion</span>&gt;</span>4.0.0<span class=\"tag\">&lt;/<span class=\"name\">modelVersion</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.example<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>rocketmq01<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.0-SNAPSHOT<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">properties</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">project.sourceEncoding</span>&gt;</span>UTF-8<span class=\"tag\">&lt;/<span class=\"name\">project.sourceEncoding</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">maven.compiler.source</span>&gt;</span>11<span class=\"tag\">&lt;/<span class=\"name\">maven.compiler.source</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">maven.compiler.target</span>&gt;</span>11<span class=\"tag\">&lt;/<span class=\"name\">maven.compiler.target</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">properties</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.rocketmq<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>rocketmq-client<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>4.6.0<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">project</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"基本生产与消费\">基本生产与消费<a href=\"#基本生产与消费\" title=\"基本生产与消费\"></a></h1><h2 id=\"生产\">生产<a href=\"#生产\" title=\"生产\"></a></h2><ol><li>创建Producer对象</li>\n<li>设置NameServer地址</li>\n<li>启动</li>\n<li>发送消息</li>\n</ol><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Producer</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String NAMESRV_ADDR = <span class=\"string\">\"192.168.31.101:9876;192.168.31.102:9876\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String PRODUCER_GROUP_NAME = <span class=\"string\">\"basic_producer_group\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TOPIC = <span class=\"string\">\"basic_topic\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TAG = <span class=\"string\">\"basic_tag\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> MQClientException, RemotingException, InterruptedException, MQBrokerException </span>&#123;</span><br><span class=\"line\">        DefaultMQProducer producer = <span class=\"keyword\">new</span> DefaultMQProducer(PRODUCER_GROUP_NAME);</span><br><span class=\"line\">        producer.setNamesrvAddr(NAMESRV_ADDR);</span><br><span class=\"line\">        producer.start();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">10</span>; i++) &#123;</span><br><span class=\"line\">            Message message = <span class=\"keyword\">new</span> Message(TOPIC, TAG, (<span class=\"string\">\"你好\"</span> + i).getBytes());</span><br><span class=\"line\">            SendResult result = producer.send(message);</span><br><span class=\"line\">            System.out.println(result);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        producer.shutdown();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"消费\">消费<a href=\"#消费\" title=\"消费\"></a></h2><ol><li>创建Consumer对象</li>\n<li>设置NameServer地址</li>\n<li>注册消息监听器</li>\n<li>启动</li>\n</ol><h3 id=\"负载均衡模式\">负载均衡模式<a href=\"#负载均衡模式\" title=\"负载均衡模式\"></a></h3><p>每个Topic会创建多个消息队列，负载均衡模式下，会将消息队列均匀分配给每一个消费者进行消费（不会重复）。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Consumer</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String NAMESRV_ADDR = <span class=\"string\">\"192.168.31.101:9876;192.168.31.102:9876\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String CONSUMER_GROUP_NAME = <span class=\"string\">\"basic_consumer_group\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TOPIC = <span class=\"string\">\"basic_topic\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> MQClientException </span>&#123;</span><br><span class=\"line\">        DefaultMQPushConsumer consumer = <span class=\"keyword\">new</span> DefaultMQPushConsumer(CONSUMER_GROUP_NAME);</span><br><span class=\"line\">        consumer.setNamesrvAddr(NAMESRV_ADDR);</span><br><span class=\"line\">        consumer.subscribe(TOPIC, <span class=\"string\">\"*\"</span>);</span><br><span class=\"line\">        <span class=\"comment\">// **********************************************</span></span><br><span class=\"line\">        consumer.setMessageModel(MessageModel.CLUSTERING);</span><br><span class=\"line\">        <span class=\"comment\">// **********************************************</span></span><br><span class=\"line\">        consumer.registerMessageListener(<span class=\"keyword\">new</span> MessageListenerConcurrently() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> ConsumeConcurrentlyStatus <span class=\"title\">consumeMessage</span><span class=\"params\">(List&lt;MessageExt&gt; msgs, ConsumeConcurrentlyContext context)</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(msgs);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        consumer.start();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"广播模式\">广播模式<a href=\"#广播模式\" title=\"广播模式\"></a></h3><p>每个消费者都可收到订阅的Topic的所有消息。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Consumer</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String NAMESRV_ADDR = <span class=\"string\">\"192.168.31.101:9876;192.168.31.102:9876\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String CONSUMER_GROUP_NAME = <span class=\"string\">\"basic_consumer_group\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TOPIC = <span class=\"string\">\"basic_topic\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> MQClientException </span>&#123;</span><br><span class=\"line\">        DefaultMQPushConsumer consumer = <span class=\"keyword\">new</span> DefaultMQPushConsumer(CONSUMER_GROUP_NAME);</span><br><span class=\"line\">        consumer.setNamesrvAddr(NAMESRV_ADDR);</span><br><span class=\"line\">        consumer.subscribe(TOPIC, <span class=\"string\">\"*\"</span>);</span><br><span class=\"line\">        <span class=\"comment\">// **********************************************</span></span><br><span class=\"line\">        consumer.setMessageModel(MessageModel.BROADCASTING);</span><br><span class=\"line\">        <span class=\"comment\">// **********************************************</span></span><br><span class=\"line\">        consumer.registerMessageListener(<span class=\"keyword\">new</span> MessageListenerConcurrently() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> ConsumeConcurrentlyStatus <span class=\"title\">consumeMessage</span><span class=\"params\">(List&lt;MessageExt&gt; msgs, ConsumeConcurrentlyContext context)</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(msgs);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        consumer.start();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"同步消息\">同步消息<a href=\"#同步消息\" title=\"同步消息\"></a></h1><p>生产者发送完消息后，需要等到Broker存储完消息，收到Broker的ACK后才会返回。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Producer</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String NAMESRV_ADDR = <span class=\"string\">\"192.168.31.101:9876;192.168.31.102:9876\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String PRODUCER_GROUP_NAME = <span class=\"string\">\"sync_producer_group\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TOPIC = <span class=\"string\">\"sync_topic\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TAG = <span class=\"string\">\"sync_tag\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> MQClientException, RemotingException, InterruptedException, MQBrokerException </span>&#123;</span><br><span class=\"line\">        DefaultMQProducer producer = <span class=\"keyword\">new</span> DefaultMQProducer(PRODUCER_GROUP_NAME);</span><br><span class=\"line\">        producer.setNamesrvAddr(NAMESRV_ADDR);</span><br><span class=\"line\">        producer.start();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">10</span>; i++) &#123;</span><br><span class=\"line\">            Message message = <span class=\"keyword\">new</span> Message(TOPIC, TAG, (<span class=\"string\">\"你好\"</span> + i).getBytes());</span><br><span class=\"line\">            <span class=\"comment\">// 阻塞，发送完收到ACK才返回</span></span><br><span class=\"line\">            SendResult result = producer.send(message);</span><br><span class=\"line\">            System.out.println(result);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        producer.shutdown();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"异步消息\">异步消息<a href=\"#异步消息\" title=\"异步消息\"></a></h1><p>生产者发送完消息后，马上返回，注册回调函数来接收发送的结果。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Producer</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String NAMESRV_ADDR = <span class=\"string\">\"192.168.31.101:9876;192.168.31.102:9876\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String PRODUCER_GROUP_NAME = <span class=\"string\">\"async_producer_group\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TOPIC = <span class=\"string\">\"async_topic\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TAG = <span class=\"string\">\"async_tag\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> MQClientException, RemotingException, InterruptedException, MQBrokerException </span>&#123;</span><br><span class=\"line\">        DefaultMQProducer producer = <span class=\"keyword\">new</span> DefaultMQProducer(PRODUCER_GROUP_NAME);</span><br><span class=\"line\">        producer.setNamesrvAddr(NAMESRV_ADDR);</span><br><span class=\"line\">        producer.start();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">10</span>; i++) &#123;</span><br><span class=\"line\">            Message message = <span class=\"keyword\">new</span> Message(TOPIC, TAG, (<span class=\"string\">\"你好\"</span> + i).getBytes());</span><br><span class=\"line\">            <span class=\"comment\">// ****************Callback****************</span></span><br><span class=\"line\">            producer.send(message, <span class=\"keyword\">new</span> SendCallback() &#123;</span><br><span class=\"line\">                <span class=\"meta\">@Override</span></span><br><span class=\"line\">                <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onSuccess</span><span class=\"params\">(SendResult sendResult)</span> </span>&#123;</span><br><span class=\"line\">                    System.out.println(<span class=\"string\">\"发送成功!\"</span>);</span><br><span class=\"line\">                    System.out.println(sendResult);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"meta\">@Override</span></span><br><span class=\"line\">                <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onException</span><span class=\"params\">(Throwable e)</span> </span>&#123;</span><br><span class=\"line\">                    System.out.println(<span class=\"string\">\"发送失败!\"</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">            <span class=\"comment\">// ****************Callback****************</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        producer.shutdown();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"单向消息\">单向消息<a href=\"#单向消息\" title=\"单向消息\"></a></h1><p>生产者只管发送，不关心发送是否成功。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Producer</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String NAMESRV_ADDR = <span class=\"string\">\"192.168.31.101:9876;192.168.31.102:9876\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String PRODUCER_GROUP_NAME = <span class=\"string\">\"oneway_producer_group\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TOPIC = <span class=\"string\">\"oneway_topic\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> MQClientException, RemotingException, InterruptedException, MQBrokerException </span>&#123;</span><br><span class=\"line\">        DefaultMQProducer producer = <span class=\"keyword\">new</span> DefaultMQProducer(PRODUCER_GROUP_NAME);</span><br><span class=\"line\">        producer.setNamesrvAddr(NAMESRV_ADDR);</span><br><span class=\"line\">        producer.start();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">10</span>; i++) &#123;</span><br><span class=\"line\">            Message message = <span class=\"keyword\">new</span> Message(TOPIC, TAG, (<span class=\"string\">\"你好\"</span> + i).getBytes());</span><br><span class=\"line\">            <span class=\"comment\">// **************************</span></span><br><span class=\"line\">            producer.sendOneway(message);</span><br><span class=\"line\">            <span class=\"comment\">// **************************</span></span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"发送成功!\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        producer.shutdown();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"顺序消息\">顺序消息<a href=\"#顺序消息\" title=\"顺序消息\"></a></h1><p>有时候我们需要一组消息按顺序被消费，此时可使用顺序消息。</p>\n<h2 id=\"全局顺序\">全局顺序<a href=\"#全局顺序\" title=\"全局顺序\"></a></h2><p>即发送的所有消息都需要保证按顺序消费，RocketMQ不支持，但可以设置Topic的队列数目为1来实现（开销大）。</p>\n<h2 id=\"局部顺序\">局部顺序<a href=\"#局部顺序\" title=\"局部顺序\"></a></h2><p>只保证一组消息按顺序被消费。</p>\n<h2 id=\"实现\">实现<a href=\"#实现\" title=\"实现\"></a></h2><p><strong>生产者</strong></p>\n<p>将需要顺序进行消费的消息放入同一个队列里，这样就可以达到先进先出的效果，保证消息被顺序消费。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Producer</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String NAMESRV_ADDR = <span class=\"string\">\"192.168.31.101:9876;192.168.31.102:9876\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String PRODUCER_GROUP_NAME = <span class=\"string\">\"order_producer_group\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TOPIC = <span class=\"string\">\"order_topic\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TAG = <span class=\"string\">\"order_tag\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> MQClientException, RemotingException, InterruptedException, MQBrokerException </span>&#123;</span><br><span class=\"line\">        DefaultMQProducer producer = <span class=\"keyword\">new</span> DefaultMQProducer(PRODUCER_GROUP_NAME);</span><br><span class=\"line\">        producer.setNamesrvAddr(NAMESRV_ADDR);</span><br><span class=\"line\">        producer.start();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">10</span>; i++) &#123;</span><br><span class=\"line\">            Message message = <span class=\"keyword\">new</span> Message(TOPIC, TAG, (<span class=\"string\">\"你好\"</span> + i).getBytes());</span><br><span class=\"line\">            <span class=\"comment\">// ***********业务表示*************</span></span><br><span class=\"line\">            <span class=\"keyword\">int</span> id = i;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// ***********队列选择器***********</span></span><br><span class=\"line\">            SendResult sendResult = producer.send(message, <span class=\"keyword\">new</span> MessageQueueSelector() &#123;</span><br><span class=\"line\">                <span class=\"meta\">@Override</span></span><br><span class=\"line\">                <span class=\"function\"><span class=\"keyword\">public</span> MessageQueue <span class=\"title\">select</span><span class=\"params\">(List&lt;MessageQueue&gt; mqs, Message msg, Object arg)</span> </span>&#123;</span><br><span class=\"line\">                    <span class=\"keyword\">int</span> size = mqs.size();</span><br><span class=\"line\">                    <span class=\"keyword\">int</span> id = (<span class=\"keyword\">int</span>) arg;</span><br><span class=\"line\">                    <span class=\"comment\">// ***根据业务id来选择队列**</span></span><br><span class=\"line\">                    <span class=\"keyword\">return</span> mqs.get(id % <span class=\"number\">2</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;, id);</span><br><span class=\"line\">            System.out.println(sendResult);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        producer.shutdown();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p><strong>消费者</strong></p>\n<p>注册串行消息监听器，保证只有一个线程对消息进行消费。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Consumer</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String NAMESRV_ADDR = <span class=\"string\">\"192.168.31.101:9876;192.168.31.102:9876\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String CONSUMER_GROUP_NAME = <span class=\"string\">\"order_consumer_group\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TOPIC = <span class=\"string\">\"order_topic\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TAG = <span class=\"string\">\"order_tag\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> MQClientException </span>&#123;</span><br><span class=\"line\">        DefaultMQPushConsumer consumer = <span class=\"keyword\">new</span> DefaultMQPushConsumer(CONSUMER_GROUP_NAME);</span><br><span class=\"line\">        consumer.setNamesrvAddr(NAMESRV_ADDR);</span><br><span class=\"line\">        consumer.setMessageModel(MessageModel.CLUSTERING);</span><br><span class=\"line\">        consumer.registerMessageListener(<span class=\"keyword\">new</span> MessageListenerOrderly() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> ConsumeOrderlyStatus <span class=\"title\">consumeMessage</span><span class=\"params\">(List&lt;MessageExt&gt; msgs, ConsumeOrderlyContext context)</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(msgs);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> ConsumeOrderlyStatus.SUCCESS;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        consumer.start();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"延时消息\">延时消息<a href=\"#延时消息\" title=\"延时消息\"></a></h1><h2 id=\"延时等级\">延时等级<a href=\"#延时等级\" title=\"延时等级\"></a></h2><p>RocketMQ不支持任意时间的延时，目前可设置的延迟等级有18个，分别为</p>\n<ul><li>1s</li>\n<li>5s</li>\n<li>10s</li>\n<li>30s</li>\n<li>1m</li>\n<li>2m</li>\n<li>3m</li>\n<li>4m</li>\n<li>5m</li>\n<li>6m</li>\n<li>7m</li>\n<li>8m</li>\n<li>9m</li>\n<li>10m</li>\n<li>20m</li>\n<li>30m</li>\n<li>1h</li>\n<li>2h</li>\n</ul><h2 id=\"延时消息原理\">延时消息原理<a href=\"#延时消息原理\" title=\"延时消息原理\"></a></h2><ul><li>Broker对延时消息会将其放入SCHEDULE_TOPIC_XXXX的Topic中，而不是消息对应的Topic中，保证消费者无法消费。</li>\n<li>通过使用定时任务来恢复到达延时的消息，将其放入其对应的队列中</li>\n</ul><h2 id=\"实现-1\">实现<a href=\"#实现-1\" title=\"实现\"></a></h2><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Producer</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String NAMESRV_ADDR = <span class=\"string\">\"192.168.31.101:9876;192.168.31.102:9876\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String PRODUCER_GROUP_NAME = <span class=\"string\">\"delay_producer_group\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TOPIC = <span class=\"string\">\"delay_topic\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TAG = <span class=\"string\">\"delay_tag\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> MQClientException, RemotingException, InterruptedException, MQBrokerException </span>&#123;</span><br><span class=\"line\">        DefaultMQProducer producer = <span class=\"keyword\">new</span> DefaultMQProducer(PRODUCER_GROUP_NAME);</span><br><span class=\"line\">        producer.setNamesrvAddr(NAMESRV_ADDR);</span><br><span class=\"line\">        producer.start();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">10</span>; i++) &#123;</span><br><span class=\"line\">            Message message = <span class=\"keyword\">new</span> Message(TOPIC, TAG, (<span class=\"string\">\"你好\"</span> + i).getBytes());</span><br><span class=\"line\">            <span class=\"comment\">// *********设置延时等级*********************</span></span><br><span class=\"line\">            message.setDelayTimeLevel(<span class=\"number\">2</span>);</span><br><span class=\"line\">            <span class=\"comment\">// ****************************************</span></span><br><span class=\"line\">            SendResult result = producer.send(message);            </span><br><span class=\"line\">            System.out.println(result);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        producer.shutdown();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"批量消息\">批量消息<a href=\"#批量消息\" title=\"批量消息\"></a></h1><p>批量发送消息可减少网络开销，提高性能。</p>\n<p><strong>限制</strong></p>\n<ul><li>相同的Topic</li>\n<li>相同的waitStoreMsgOK</li>\n<li>不能为延时消息</li>\n<li>总大小不超过4MB</li>\n</ul><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Producer</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String NAMESRV_ADDR = <span class=\"string\">\"192.168.31.101:9876;192.168.31.102:9876\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String PRODUCER_GROUP_NAME = <span class=\"string\">\"batch_producer_group\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TOPIC = <span class=\"string\">\"batch_topic\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TAG = <span class=\"string\">\"batch_tag\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> MQClientException, RemotingException, InterruptedException, MQBrokerException </span>&#123;</span><br><span class=\"line\">        DefaultMQProducer producer = <span class=\"keyword\">new</span> DefaultMQProducer(PRODUCER_GROUP_NAME);</span><br><span class=\"line\">        producer.setNamesrvAddr(NAMESRV_ADDR);</span><br><span class=\"line\">        producer.start();</span><br><span class=\"line\"></span><br><span class=\"line\">        List&lt;Message&gt; messages = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">10</span>; i++) &#123;</span><br><span class=\"line\">            Message message = <span class=\"keyword\">new</span> Message(TOPIC, TAG, (<span class=\"string\">\"你好\"</span> + i).getBytes());</span><br><span class=\"line\">            messages.add(message);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        SendResult result = producer.send(messages);</span><br><span class=\"line\">        System.out.println(result);</span><br><span class=\"line\">        producer.shutdown();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"事务消息\">事务消息<a href=\"#事务消息\" title=\"事务消息\"></a></h1><h2 id=\"分布式事务\">分布式事务<a href=\"#分布式事务\" title=\"分布式事务\"></a></h2><p>通常如转账等业务需要用事务来保证数据的一致性。在单机环境下，我们可以很方便的实现事务管理，但是在分布式环境下，我们需要使用两阶段提交，三阶段提交等分布式事务协议来进行处理。但这些方案开销较大，影响性能。此时我们可以使用消息队列来使用最终一致性代替强一致性，提高性能。</p>\n<h2 id=\"生动说明\">生动说明<a href=\"#生动说明\" title=\"生动说明\"></a></h2><p>去面馆吃面，点完单后会给你一张小票，之后你拿着小票就可以去领到自己的面，虽然可能后厨现在特别的忙，或者暂时出去接电话不在，但是只要你有小票，最终就一定能拿到面。</p>\n<ul><li>小票---&gt;消息</li>\n<li>最终拿到面---&gt;最终一致性</li>\n</ul><h2 id=\"事务消息流程\">事务消息流程<a href=\"#事务消息流程\" title=\"事务消息流程\"></a></h2><img src=\"/post/%E4%B8%AD%E9%97%B4%E4%BB%B6/RocketMQ/RocketMQ%E5%90%84%E7%A7%8D%E6%B6%88%E6%81%AF/image-20200227191615193.png\" class=\"\">\n\n<h3 id=\"正常流程\">正常流程<a href=\"#正常流程\" title=\"正常流程\"></a></h3><ol><li>发送事务消息</li>\n<li>Broker持久化消息</li>\n<li>Broker发送ACK</li>\n<li>执行本地事务</li>\n<li>根据本地事务执行结果Commit/Rollback</li>\n</ol><img src=\"/post/%E4%B8%AD%E9%97%B4%E4%BB%B6/RocketMQ/RocketMQ%E5%90%84%E7%A7%8D%E6%B6%88%E6%81%AF/image-20200227191741046.png\" class=\"\">\n\n<h3 id=\"事务补偿流程\">事务补偿流程<a href=\"#事务补偿流程\" title=\"事务补偿流程\"></a></h3><ol><li>发送事务消息</li>\n<li>Broker持久化消息</li>\n<li>Broker发送ACK</li>\n<li>执行本地事务</li>\n<li>回复UNKNOWN或者不回复</li>\n<li>Broker未收到回复或者受到UNKNOWN对Producer进行事务回查</li>\n<li>返回Commit/Rollback</li>\n</ol><img src=\"/post/%E4%B8%AD%E9%97%B4%E4%BB%B6/RocketMQ/RocketMQ%E5%90%84%E7%A7%8D%E6%B6%88%E6%81%AF/image-20200227192336259.png\" class=\"\">\n\n\n\n<h2 id=\"实现-2\">实现<a href=\"#实现-2\" title=\"实现\"></a></h2><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Producer</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String NAMESRV_ADDR = <span class=\"string\">\"192.168.31.101:9876;192.168.31.102:9876\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String PRODUCER_GROUP_NAME = <span class=\"string\">\"trans_producer_group\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TOPIC = <span class=\"string\">\"trans_topic\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TAG = <span class=\"string\">\"trans_tag\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> MQClientException, RemotingException, InterruptedException, MQBrokerException </span>&#123;</span><br><span class=\"line\">        TransactionMQProducer producer = <span class=\"keyword\">new</span> TransactionMQProducer(PRODUCER_GROUP_NAME);</span><br><span class=\"line\">        producer.setNamesrvAddr(NAMESRV_ADDR);</span><br><span class=\"line\">        producer.setTransactionListener(<span class=\"keyword\">new</span> TransactionListener() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> LocalTransactionState <span class=\"title\">executeLocalTransaction</span><span class=\"params\">(Message msg, Object arg)</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">\"check status\"</span>);</span><br><span class=\"line\">                System.out.println(<span class=\"string\">\"execute local transaction\"</span>);</span><br><span class=\"line\">                System.out.println(msg);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> LocalTransactionState.UNKNOW;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> LocalTransactionState <span class=\"title\">checkLocalTransaction</span><span class=\"params\">(MessageExt msg)</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">\"check back\"</span>);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> LocalTransactionState.ROLLBACK_MESSAGE;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        producer.start();</span><br><span class=\"line\"></span><br><span class=\"line\">        Message message = <span class=\"keyword\">new</span> Message(TOPIC, TAG, <span class=\"string\">\"你好\"</span>.getBytes());</span><br><span class=\"line\">        SendResult result = producer.sendMessageInTransaction(message, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">        System.out.println(result);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"过滤消息\">过滤消息<a href=\"#过滤消息\" title=\"过滤消息\"></a></h1>","prev":{"title":"RocketMQ之NameServer","link":"post/中间件/RocketMQ/RocketMQ之NameServer"},"next":{"title":"RocketMQ集群搭建","link":"post/中间件/RocketMQ/RocketMQ集群搭建"},"plink":"https://beginc.github.io/post/中间件/RocketMQ/RocketMQ各种消息/","toc":[{"id":"环境搭建","title":"环境搭建","index":"1"},{"id":"基本生产与消费","title":"基本生产与消费","index":"2","children":[{"id":"生产","title":"生产","index":"2.1"},{"id":"消费","title":"消费","index":"2.2","children":[{"id":"负载均衡模式","title":"负载均衡模式","index":"2.2.1"},{"id":"广播模式","title":"广播模式","index":"2.2.2"}]}]},{"id":"同步消息","title":"同步消息","index":"3"},{"id":"异步消息","title":"异步消息","index":"4"},{"id":"单向消息","title":"单向消息","index":"5"},{"id":"顺序消息","title":"顺序消息","index":"6","children":[{"id":"全局顺序","title":"全局顺序","index":"6.1"},{"id":"局部顺序","title":"局部顺序","index":"6.2"},{"id":"实现","title":"实现","index":"6.3"}]},{"id":"延时消息","title":"延时消息","index":"7","children":[{"id":"延时等级","title":"延时等级","index":"7.1"},{"id":"延时消息原理","title":"延时消息原理","index":"7.2"},{"id":"实现-1","title":"实现","index":"7.3"}]},{"id":"批量消息","title":"批量消息","index":"8"},{"id":"事务消息","title":"事务消息","index":"9","children":[{"id":"分布式事务","title":"分布式事务","index":"9.1"},{"id":"生动说明","title":"生动说明","index":"9.2"},{"id":"事务消息流程","title":"事务消息流程","index":"9.3","children":[{"id":"正常流程","title":"正常流程","index":"9.3.1"},{"id":"事务补偿流程","title":"事务补偿流程","index":"9.3.2"}]},{"id":"实现-2","title":"实现","index":"9.4"}]},{"id":"过滤消息","title":"过滤消息","index":"10"}]}