{"title":"6-Ansible常用Playbook关键字","date":"2020-02-07T12:59:22.000Z","date_formatted":{"ll":"Feb 7, 2020","L":"02/07/2020","MM-DD":"02-07"},"thumbnail":"post/自动化运维/Ansible/7-Ansible常用Playbook关键字/cover.png","link":"post/自动化运维/Ansible/7-Ansible常用Playbook关键字","categories":["Ansible","自动化运维"],"updated":"2020-02-08T02:54:00.912Z","content":"<h1 id=\"用于play\">用于Play<a href=\"#用于play\" title=\"用于Play\"></a></h1><h2 id=\"hosts\">hosts<a href=\"#hosts\" title=\"hosts\"></a></h2><p>指定主机列表。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># 指定主机列表为mq组内所有主机</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">hosts:</span> <span class=\"string\">mq</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"remote_user\">remote_user<a href=\"#remote_user\" title=\"remote_user\"></a></h2><p>指定远程执行命令的用户。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># 指定主机列表为mq组内所有主机</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">hosts:</span> <span class=\"string\">mq</span></span><br><span class=\"line\">  <span class=\"comment\"># 远程以root用户运行</span></span><br><span class=\"line\">  <span class=\"attr\">remote_user:</span> <span class=\"string\">root</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"gather_facts\">gather_facts<a href=\"#gather_facts\" title=\"gather_facts\"></a></h2><p>指定是否收集主机信息。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># 指定主机列表为mq组内所有主机</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">hosts:</span> <span class=\"string\">mq</span></span><br><span class=\"line\">  <span class=\"comment\"># 远程以root用户运行</span></span><br><span class=\"line\">  <span class=\"attr\">remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\">  <span class=\"attr\">vars_files:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">vars.yml</span></span><br><span class=\"line\">  <span class=\"attr\">gather_facts:</span> <span class=\"literal\">no</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"pre_tasks\">pre_tasks<a href=\"#pre_tasks\" title=\"pre_tasks\"></a></h2><p>在<code>tasks</code>之前执行的<code>task</code>。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\">  <span class=\"attr\">gather_facts:</span> <span class=\"literal\">no</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">pre_tasks:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">debug:</span> <span class=\"string\">msg=pre</span></span><br><span class=\"line\">  <span class=\"attr\">tasks:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">debug:</span> <span class=\"string\">msg=task</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"post_tasks\">post_tasks<a href=\"#post_tasks\" title=\"post_tasks\"></a></h2><p>在<code>tasks</code>之后执行的<code>task</code>。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\">  <span class=\"attr\">gather_facts:</span> <span class=\"literal\">no</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">pre_tasks:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">debug:</span> <span class=\"string\">msg=pre</span></span><br><span class=\"line\">  <span class=\"attr\">tasks:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">debug:</span> <span class=\"string\">msg=task</span></span><br><span class=\"line\">  <span class=\"attr\">post_tasks:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">debug:</span> <span class=\"string\">msg=post</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"用于task\">用于Task<a href=\"#用于task\" title=\"用于Task\"></a></h1><h2 id=\"changed_when\">changed_when<a href=\"#changed_when\" title=\"changed_when\"></a></h2><p>用于设置何时任务“发生了改变”，需要重新执行。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\">  <span class=\"attr\">gather_facts:</span> <span class=\"literal\">no</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"attr\">tasks:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">debug:</span> <span class=\"string\">msg=task</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">check</span> <span class=\"string\">if</span> <span class=\"string\">$ROCKET_HOME</span> <span class=\"string\">exists</span></span><br><span class=\"line\">      <span class=\"attr\">shell:</span> <span class=\"string\">cat</span> <span class=\"string\">/etc/bashrc</span></span><br><span class=\"line\">      <span class=\"attr\">register:</span> <span class=\"string\">bashrc</span></span><br><span class=\"line\">      <span class=\"comment\"># 指定该任务总是需要执行</span></span><br><span class=\"line\">      <span class=\"attr\">changed_when:</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"check_mode\">check_mode<a href=\"#check_mode\" title=\"check_mode\"></a></h1><p>设置了该模式的命令只会预测在主机上执行结果，而不会真正的执行。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\">  <span class=\"attr\">gather_facts:</span> <span class=\"literal\">no</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"attr\">tasks:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">shell:</span> <span class=\"string\">echo</span> <span class=\"string\">hello</span></span><br><span class=\"line\">      <span class=\"attr\">check_mode:</span> <span class=\"literal\">yes</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"environment\">environment<a href=\"#environment\" title=\"environment\"></a></h2><p>可用来设置环境变量。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">hosts:</span> <span class=\"string\">all</span></span><br><span class=\"line\">  <span class=\"attr\">gather_facts:</span> <span class=\"literal\">no</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"attr\">tasks:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">shell:</span> <span class=\"string\">echo</span> <span class=\"string\">$var</span> <span class=\"string\">&gt;</span> <span class=\"string\">~/test.txt</span></span><br><span class=\"line\">      <span class=\"attr\">environment:</span></span><br><span class=\"line\">        <span class=\"attr\">var:</span> <span class=\"number\">123</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ignore_errors\">ignore_errors<a href=\"#ignore_errors\" title=\"ignore_errors\"></a></h2><p>指定是否忽略命令出错，继续向下执行。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">this</span> <span class=\"string\">will</span> <span class=\"string\">not</span> <span class=\"string\">be</span> <span class=\"string\">counted</span> <span class=\"string\">as</span> <span class=\"string\">a</span> <span class=\"string\">failure</span></span><br><span class=\"line\">  <span class=\"attr\">command:</span> <span class=\"string\">/bin/false</span></span><br><span class=\"line\">  <span class=\"attr\">ignore_errors:</span> <span class=\"literal\">yes</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"failed_when\">failed_when<a href=\"#failed_when\" title=\"failed_when\"></a></h2><p>指定命令什么情况下算执行失败。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Fail</span> <span class=\"string\">task</span> <span class=\"string\">when</span> <span class=\"string\">the</span> <span class=\"string\">command</span> <span class=\"string\">error</span> <span class=\"string\">output</span> <span class=\"string\">prints</span> <span class=\"string\">FAILED</span></span><br><span class=\"line\">  <span class=\"attr\">command:</span> <span class=\"string\">/usr/bin/example-command</span> <span class=\"string\">-x</span> <span class=\"string\">-y</span> <span class=\"string\">-z</span></span><br><span class=\"line\">  <span class=\"attr\">register:</span> <span class=\"string\">command_result</span></span><br><span class=\"line\">  <span class=\"attr\">failed_when:</span> <span class=\"string\">\"'FAILED' in command_result.stderr\"</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"register\">register<a href=\"#register\" title=\"register\"></a></h2><p>将命令执行的返回值注册成一个变量。可在后续使用。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">check</span> <span class=\"string\">if</span> <span class=\"string\">$ROCKET_HOME</span> <span class=\"string\">exists</span></span><br><span class=\"line\">  <span class=\"attr\">shell:</span> <span class=\"string\">cat</span> <span class=\"string\">/etc/bashrc</span></span><br><span class=\"line\">  <span class=\"attr\">register:</span> <span class=\"string\">bashrc</span></span><br><span class=\"line\">  <span class=\"attr\">changed_when:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">append</span> <span class=\"string\">$ROCKET_HOME</span></span><br><span class=\"line\">  <span class=\"attr\">shell:</span> <span class=\"string\">echo</span> <span class=\"string\">ROCKET_HOME=/usr/local/&#123;&#123;</span> <span class=\"string\">unarchive_filename</span> <span class=\"string\">&#125;&#125;</span> <span class=\"string\">&gt;&gt;</span> <span class=\"string\">/etc/bashrc;</span> <span class=\"string\">echo</span> <span class=\"string\">PATH='$PATH:$ROCKET_HOME'/bin</span> <span class=\"string\">&gt;&gt;</span> <span class=\"string\">/etc/bashrc</span></span><br><span class=\"line\">  <span class=\"attr\">when:</span> <span class=\"string\">not</span> <span class=\"string\">bashrc.stdout</span> <span class=\"string\">is</span> <span class=\"string\">search(\"ROCKET_HOME\")</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"loop\">loop<a href=\"#loop\" title=\"loop\"></a></h2><p>用于执行循环。和<code>with_*</code>不同，该循环不依赖插件。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">add</span> <span class=\"string\">several</span> <span class=\"string\">users</span></span><br><span class=\"line\">  <span class=\"attr\">user:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123; item &#125;&#125;</span>\"</span></span><br><span class=\"line\">    <span class=\"attr\">state:</span> <span class=\"string\">present</span></span><br><span class=\"line\">    <span class=\"attr\">groups:</span> <span class=\"string\">\"wheel\"</span></span><br><span class=\"line\">  <span class=\"attr\">loop:</span></span><br><span class=\"line\">     <span class=\"bullet\">-</span> <span class=\"string\">testuser1</span></span><br><span class=\"line\">     <span class=\"bullet\">-</span> <span class=\"string\">testuser2</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"with_items\">with_items<a href=\"#with_items\" title=\"with_items\"></a></h2><p>用于执行循环。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">with_items</span></span><br><span class=\"line\">  <span class=\"attr\">debug:</span></span><br><span class=\"line\">    <span class=\"attr\">msg:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123; item &#125;&#125;</span>\"</span></span><br><span class=\"line\">  <span class=\"attr\">with_items:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123; items &#125;&#125;</span>\"</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"with_indexed_items\">with_indexed_items<a href=\"#with_indexed_items\" title=\"with_indexed_items\"></a></h2><p>带索引的循环。<code>item.0</code>为索引，<code>item.1</code>为值。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">with_indexed_items</span></span><br><span class=\"line\">  <span class=\"attr\">debug:</span></span><br><span class=\"line\">    <span class=\"attr\">msg:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123; item.0 &#125;&#125;</span> - <span class=\"template-variable\">&#123;&#123; item.1 &#125;&#125;</span>\"</span></span><br><span class=\"line\">  <span class=\"attr\">with_indexed_items:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123; items &#125;&#125;</span>\"</span></span><br></pre></td></tr></table></figure>","prev":{"title":"7-Ansible执行速度优化","link":"post/自动化运维/Ansible/8-Ansible执行速度优化"},"next":{"title":"5-Ansible之Jinja2语法","link":"post/自动化运维/Ansible/6-Ansible之Jinja2语法"},"plink":"https://beginc.github.io/post/自动化运维/Ansible/7-Ansible常用Playbook关键字/","toc":[{"id":"用于play","title":"用于Play","index":"1","children":[{"id":"hosts","title":"hosts","index":"1.1"},{"id":"remote_user","title":"remote_user","index":"1.2"},{"id":"gather_facts","title":"gather_facts","index":"1.3"},{"id":"pre_tasks","title":"pre_tasks","index":"1.4"},{"id":"post_tasks","title":"post_tasks","index":"1.5"}]},{"id":"用于task","title":"用于Task","index":"2","children":[{"id":"changed_when","title":"changed_when","index":"2.1"}]},{"id":"check_mode","title":"check_mode","index":"3","children":[{"id":"environment","title":"environment","index":"3.1"},{"id":"ignore_errors","title":"ignore_errors","index":"3.2"},{"id":"failed_when","title":"failed_when","index":"3.3"},{"id":"register","title":"register","index":"3.4"},{"id":"loop","title":"loop","index":"3.5"},{"id":"with_items","title":"with_items","index":"3.6"},{"id":"with_indexed_items","title":"with_indexed_items","index":"3.7"}]}]}