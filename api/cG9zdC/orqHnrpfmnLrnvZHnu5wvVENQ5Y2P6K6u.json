{"title":"TCP协议","date":"2020-03-13T14:49:12.000Z","date_formatted":{"ll":"Mar 13, 2020","L":"03/13/2020","MM-DD":"03-13"},"thumbnail":"post/计算机网络/TCP协议/cover.jpg","link":"post/计算机网络/TCP协议","categories":["计算机网络"],"updated":"2020-03-13T14:53:15.299Z","content":"<h1 id=\"tcp协议服务\">TCP协议服务<a href=\"#tcp协议服务\" title=\"TCP协议服务\"></a></h1><ul><li>面向连接的可靠传输</li>\n<li>面向字节流</li>\n<li>流量控制</li>\n<li>拥塞控制</li>\n<li>差错控制</li>\n</ul><h2 id=\"tcp协议格式\">TCP协议格式<a href=\"#tcp协议格式\" title=\"TCP协议格式\"></a></h2><img src=\"/post/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%E5%8D%8F%E8%AE%AE/image-20200313203217253.png\" class=\"\">\n\n<h2 id=\"序号\">序号<a href=\"#序号\" title=\"序号\"></a></h2><p>发送方数据区第一个字节的编号。</p>\n<h2 id=\"确认号\">确认号<a href=\"#确认号\" title=\"确认号\"></a></h2><p>发送方期望收到的下一个字节的编号。也是对之前的数据的<strong>累积确认</strong>。</p>\n<ul><li>ack 201<ul><li>接下来希望收到第201号字节</li>\n<li>序号200以及之前的字节都收到了</li>\n</ul></li>\n</ul><h2 id=\"hlen\">HLEN<a href=\"#hlen\" title=\"HLEN\"></a></h2><p>首部长度，以4字节为单位。</p>\n<h2 id=\"flag\">Flag<a href=\"#flag\" title=\"Flag\"></a></h2><ul><li>URG<ul><li>紧急数据，不用在TCP缓冲区排队，马上发送</li>\n<li>此时紧急指针 + 序号即为紧急数据结束的字节的编号</li>\n</ul></li>\n<li>ACK<ul><li>确认号有效</li>\n</ul></li>\n<li>PSH<ul><li>要求接收方立即交付缓冲区的数据</li>\n</ul></li>\n<li>RST<ul><li>异常，重新建立连接</li>\n</ul></li>\n<li>SYN<ul><li>用于建立连接时序号同步</li>\n</ul></li>\n<li>FIN<ul><li>用于拆除连接</li>\n</ul></li>\n</ul><h2 id=\"校验和\">校验和<a href=\"#校验和\" title=\"校验和\"></a></h2><p>端到端校验，校验的数据包括</p>\n<ul><li>TCP所有信息</li>\n<li>IP首部的伪首部</li>\n</ul><img src=\"/post/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%E5%8D%8F%E8%AE%AE/image-20200313203938518.png\" class=\"\">\n\n<h2 id=\"tcp选项\">TCP选项<a href=\"#tcp选项\" title=\"TCP选项\"></a></h2><ul><li>选项结束：作为TCP选项的结束标记</li>\n<li>无操作：用于填充，达到TCP选项长度为4的整数倍</li>\n<li>最大段大小（MSS）：告诉接收方本机能接受的最大TCP数据区字节数</li>\n<li>窗口规模因子：$W_n = W_o \\times 2^f$<ul><li>$W_o$为窗口字段的值</li>\n<li>$f$为规模银子</li>\n</ul></li>\n</ul><img src=\"/post/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%E5%8D%8F%E8%AE%AE/image-20200313204013552.png\" class=\"\">\n\n<h1 id=\"tcp连接的建立与拆除\">TCP连接的建立与拆除<a href=\"#tcp连接的建立与拆除\" title=\"TCP连接的建立与拆除\"></a></h1><p>见</p>\n<h1 id=\"tcp可靠传输\">TCP可靠传输<a href=\"#tcp可靠传输\" title=\"TCP可靠传输\"></a></h1><h2 id=\"实现机制\">实现机制<a href=\"#实现机制\" title=\"实现机制\"></a></h2><ul><li>序号</li>\n<li>确认号</li>\n<li>重传</li>\n<li>检验</li>\n</ul><h2 id=\"序号-1\">序号<a href=\"#序号-1\" title=\"序号\"></a></h2><p>用序号可以保证数据是有序交付的。</p>\n<h2 id=\"确认号-1\">确认号<a href=\"#确认号-1\" title=\"确认号\"></a></h2><p>使用确认号可让发送方知道自己的报文是否正确送达。</p>\n<ul><li>累积确认：ack 200说明200以前的字节都收到了</li>\n<li>捎带确认：可以发送数据的同时发送ACK</li>\n</ul><h2 id=\"重传\">重传<a href=\"#重传\" title=\"重传\"></a></h2><p>如果在规定的时间内未收到已发送数据的确认号，则会超时重传。</p>\n<h3 id=\"快速重传\">快速重传<a href=\"#快速重传\" title=\"快速重传\"></a></h3><p>为了避免超时重传带来的时延，TCP引入了</p>\n<ul><li>冗余确认</li>\n<li>快速重传</li>\n</ul><p><strong>冗余确认</strong></p>\n<p>当接收方收到乱序到达的数据时会发送一个冗余确认，确认号为自己当前希望收到的数据的序号。</p>\n<p><strong>快速重传</strong></p>\n<p>当发送方收到三次冗余确认（假设是ack x）后，就会马上重传未确认的报文段（发送x + 1），而不是等超时重传。</p>\n<h1 id=\"tcp流量控制\">TCP流量控制<a href=\"#tcp流量控制\" title=\"TCP流量控制\"></a></h1><p>流量控制指的是接收方限制发送方的发送速率。</p>\n<h2 id=\"实现机制-1\">实现机制<a href=\"#实现机制-1\" title=\"实现机制\"></a></h2><h3 id=\"滑动窗口\">滑动窗口<a href=\"#滑动窗口\" title=\"滑动窗口\"></a></h3><p>发送方和接收方都有发送缓存和接收缓存。</p>\n<ul><li>发送方的发送窗口大小不能超过对方的接收窗口大小</li>\n</ul><img src=\"/post/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%E5%8D%8F%E8%AE%AE/image-20200313205433158.png\" class=\"\">\n\n<h3 id=\"窗口控制\">窗口控制<a href=\"#窗口控制\" title=\"窗口控制\"></a></h3><p><strong>接收方</strong></p>\n<p>发送数据时在首部的窗口大小处填上自己的接收窗口大小。</p>\n<p><strong>发送方</strong></p>\n<p>发送方的发送窗口大小为接收方接收窗口大小和当前拥塞窗口大小的最小值。</p>\n<ul><li>$W_{send} = min{W_{recv}, W_{conges}}$</li>\n</ul><h1 id=\"tcp拥塞控制\">TCP拥塞控制<a href=\"#tcp拥塞控制\" title=\"TCP拥塞控制\"></a></h1><p>拥塞控制指的是发送方限制自己的发送速率来缓解网络拥塞。</p>\n<h2 id=\"实现机制-2\">实现机制<a href=\"#实现机制-2\" title=\"实现机制\"></a></h2><ul><li>慢开始</li>\n<li>拥塞避免</li>\n<li>快重传</li>\n<li>快恢复</li>\n</ul><h2 id=\"过程\">过程<a href=\"#过程\" title=\"过程\"></a></h2><h3 id=\"慢开始\">慢开始<a href=\"#慢开始\" title=\"慢开始\"></a></h3><ul><li>建立TCP连接时发送方将拥塞窗口设置为接收方的一个MSS</li>\n<li>每次收到一个确认段都将MSS增加一个<ul><li>发一个 ---&gt;  一个确认 ---&gt; 2个MSS</li>\n<li>发两个 ---&gt;  两个确认 ---&gt; 4个MSS</li>\n<li>发四个 ---&gt;  四个确认 ---&gt; 8个MSS</li>\n<li>...</li>\n</ul></li>\n</ul><img src=\"/post/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%E5%8D%8F%E8%AE%AE/image-20200313205900076.png\" class=\"\">\n\n<h3 id=\"拥塞避免\">拥塞避免<a href=\"#拥塞避免\" title=\"拥塞避免\"></a></h3><ul><li>当拥塞窗口大小达到门限值时，即使收到多个确认，也只增加一个MSS</li>\n</ul><h3 id=\"快重传\">快重传<a href=\"#快重传\" title=\"快重传\"></a></h3><ul><li>当收到三个冗余确认时，发送方进行快速重传</li>\n<li>将门限值减为当前拥塞窗口大小的一半</li>\n<li>拥塞窗口减为新的门限值</li>\n</ul><h3 id=\"快恢复\">快恢复<a href=\"#快恢复\" title=\"快恢复\"></a></h3><ul><li>窗口每次增加一个MSS</li>\n</ul>","prev":{"title":"UDP协议","link":"post/计算机网络/UDP协议"},"next":{"title":"IP协议","link":"post/计算机网络/IP协议"},"plink":"https://beginc.github.io/post/计算机网络/TCP协议/","toc":[{"id":"tcp协议服务","title":"TCP协议服务","index":"1","children":[{"id":"tcp协议格式","title":"TCP协议格式","index":"1.1"},{"id":"序号","title":"序号","index":"1.2"},{"id":"确认号","title":"确认号","index":"1.3"},{"id":"hlen","title":"HLEN","index":"1.4"},{"id":"flag","title":"Flag","index":"1.5"},{"id":"校验和","title":"校验和","index":"1.6"},{"id":"tcp选项","title":"TCP选项","index":"1.7"}]},{"id":"tcp连接的建立与拆除","title":"TCP连接的建立与拆除","index":"2"},{"id":"tcp可靠传输","title":"TCP可靠传输","index":"3","children":[{"id":"实现机制","title":"实现机制","index":"3.1"},{"id":"序号-1","title":"序号","index":"3.2"},{"id":"确认号-1","title":"确认号","index":"3.3"},{"id":"重传","title":"重传","index":"3.4","children":[{"id":"快速重传","title":"快速重传","index":"3.4.1"}]}]},{"id":"tcp流量控制","title":"TCP流量控制","index":"4","children":[{"id":"实现机制-1","title":"实现机制","index":"4.1","children":[{"id":"滑动窗口","title":"滑动窗口","index":"4.1.1"},{"id":"窗口控制","title":"窗口控制","index":"4.1.2"}]}]},{"id":"tcp拥塞控制","title":"TCP拥塞控制","index":"5","children":[{"id":"实现机制-2","title":"实现机制","index":"5.1"},{"id":"过程","title":"过程","index":"5.2","children":[{"id":"慢开始","title":"慢开始","index":"5.2.1"},{"id":"拥塞避免","title":"拥塞避免","index":"5.2.2"},{"id":"快重传","title":"快重传","index":"5.2.3"},{"id":"快恢复","title":"快恢复","index":"5.2.4"}]}]}]}