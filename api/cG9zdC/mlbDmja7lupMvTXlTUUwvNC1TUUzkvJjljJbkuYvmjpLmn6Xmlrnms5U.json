{"title":"4-SQL优化之排查方法","date":"2020-02-12T08:30:19.000Z","date_formatted":{"ll":"Feb 12, 2020","L":"02/12/2020","MM-DD":"02-12"},"thumbnail":"post/数据库/MySQL/4-SQL优化之排查方法/cover.png","link":"post/数据库/MySQL/4-SQL优化之排查方法","categories":["MySQL","数据库"],"updated":"2020-03-05T10:08:06.045Z","content":"<h1 id=\"慢查询日志\">慢查询日志<a href=\"#慢查询日志\" title=\"慢查询日志\"></a></h1><p>MySQL提供了慢查询日志来记录响应时间超过阈值的SQL语句，默认是关闭的。</p>\n<p><strong>查询是否打开</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">show</span> <span class=\"keyword\">variables</span> <span class=\"keyword\">like</span> <span class=\"string\">'%slow_query_log%'</span>;</span><br></pre></td></tr></table></figure>\n\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/4-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E6%8E%92%E6%9F%A5%E6%96%B9%E6%B3%95/1.png\" class=\"\">\n\n<p><strong>查询阈值</strong></p>\n<p>默认为10秒。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">show</span> <span class=\"keyword\">variables</span> <span class=\"keyword\">like</span> <span class=\"string\">'%long_query_time%'</span>;</span><br></pre></td></tr></table></figure>\n\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/4-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E6%8E%92%E6%9F%A5%E6%96%B9%E6%B3%95/3.png\" class=\"\">\n\n<h2 id=\"临时开启\">临时开启<a href=\"#临时开启\" title=\"临时开启\"></a></h2><p><strong>开启</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">set</span> <span class=\"keyword\">global</span> slow_query_log = <span class=\"number\">1</span>;</span><br></pre></td></tr></table></figure>\n\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/4-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E6%8E%92%E6%9F%A5%E6%96%B9%E6%B3%95/2.png\" class=\"\">\n\n<p><strong>设置阈值</strong></p>\n<p>需要重新登录后生效。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">set</span> <span class=\"keyword\">global</span> long_query_time = <span class=\"number\">3</span>;</span><br></pre></td></tr></table></figure>\n\n<p><strong>测试</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> <span class=\"keyword\">sleep</span>(<span class=\"number\">4</span>);</span><br></pre></td></tr></table></figure>\n\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/4-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E6%8E%92%E6%9F%A5%E6%96%B9%E6%B3%95/4.png\" class=\"\">\n\n<h2 id=\"永久开启\">永久开启<a href=\"#永久开启\" title=\"永久开启\"></a></h2><p>永久开启需要改写配置文件/etc/my.cnf，重启服务。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[mysqld]</span></span><br><span class=\"line\"><span class=\"attr\">slow_query_log</span> = <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">slow_query_log_file</span> = /var/lib/mysql/localhost-slow.log</span><br><span class=\"line\"><span class=\"attr\">long_query_time</span> = <span class=\"number\">3</span></span><br></pre></td></tr></table></figure>\n\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/4-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E6%8E%92%E6%9F%A5%E6%96%B9%E6%B3%95/5.png\" class=\"\">\n\n<h1 id=\"profile\">Profile<a href=\"#profile\" title=\"Profile\"></a></h1><p>使用MySQL的profile可以记录所有SQL语句的记录，并进行消耗时间的查看，默认是关闭的。</p>\n<p><strong>查询是否打开</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">show</span> <span class=\"keyword\">variables</span> <span class=\"keyword\">like</span> <span class=\"string\">'%profiling%'</span>;</span><br></pre></td></tr></table></figure>\n\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/4-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E6%8E%92%E6%9F%A5%E6%96%B9%E6%B3%95/6.png\" class=\"\">\n\n<p><strong>打开</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">set</span> <span class=\"keyword\">global</span> profiling = <span class=\"number\">1</span>;</span><br></pre></td></tr></table></figure>\n\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/4-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E6%8E%92%E6%9F%A5%E6%96%B9%E6%B3%95/7.png\" class=\"\">\n\n<p><strong>查看</strong></p>\n<ul><li>Query_ID</li>\n<li>Duration</li>\n<li>Query</li>\n</ul><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">show</span> <span class=\"keyword\">profiles</span>;</span><br></pre></td></tr></table></figure>\n\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/4-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E6%8E%92%E6%9F%A5%E6%96%B9%E6%B3%95/8.png\" class=\"\">\n\n<p><strong>精确分析</strong></p>\n<p>精确分析每一条语句耗时的详情。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">show</span> profile <span class=\"keyword\">all</span> <span class=\"keyword\">for</span> <span class=\"keyword\">query</span> 查询的<span class=\"keyword\">ID</span>（Query_ID）;</span><br></pre></td></tr></table></figure>\n\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/4-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E6%8E%92%E6%9F%A5%E6%96%B9%E6%B3%95/9.png\" class=\"\">\n\n<h1 id=\"全局查询日志\">全局查询日志<a href=\"#全局查询日志\" title=\"全局查询日志\"></a></h1><p>记录开启之后的全部SQL语句，默认关闭。</p>\n<p><strong>查看是否开启</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">show</span> <span class=\"keyword\">variables</span> <span class=\"keyword\">like</span> <span class=\"string\">'%general_log%'</span>;</span><br></pre></td></tr></table></figure>\n\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/4-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E6%8E%92%E6%9F%A5%E6%96%B9%E6%B3%95/10.png\" class=\"\">\n\n<p><strong>打开</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">set</span> <span class=\"keyword\">global</span> general_log = <span class=\"number\">1</span>;</span><br></pre></td></tr></table></figure>\n\n<p><strong>设置记录在表中</strong></p>\n<p>查询记录会记录在mysql.general_log表中</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">set</span> <span class=\"keyword\">global</span> log_output = <span class=\"string\">'table'</span>;</span><br></pre></td></tr></table></figure>\n\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/4-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E6%8E%92%E6%9F%A5%E6%96%B9%E6%B3%95/11.png\" class=\"\">\n\n<p><strong>设置记录在文件中</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">set</span> <span class=\"keyword\">global</span> log_output = <span class=\"string\">'file'</span>;</span><br><span class=\"line\"><span class=\"keyword\">set</span> <span class=\"keyword\">global</span> general_log_file = <span class=\"string\">'/tmp/general.log'</span>;</span><br></pre></td></tr></table></figure>\n\n<img src=\"/post/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/4-SQL%E4%BC%98%E5%8C%96%E4%B9%8B%E6%8E%92%E6%9F%A5%E6%96%B9%E6%B3%95/12.png\" class=\"\">","prev":{"title":"5-SQL优化之索引优化","link":"post/数据库/MySQL/5-SQL优化之索引优化"},"next":{"title":"Flexbox布局","link":"post/Web/CSS/Flexbox布局"},"plink":"https://beginc.github.io/post/数据库/MySQL/4-SQL优化之排查方法/","toc":[{"id":"慢查询日志","title":"慢查询日志","index":"1","children":[{"id":"临时开启","title":"临时开启","index":"1.1"},{"id":"永久开启","title":"永久开启","index":"1.2"}]},{"id":"profile","title":"Profile","index":"2"},{"id":"全局查询日志","title":"全局查询日志","index":"3"}]}