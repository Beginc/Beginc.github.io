{"title":"Docker之Dockerfile","date":"2020-02-29T12:15:32.000Z","date_formatted":{"ll":"Feb 29, 2020","L":"02/29/2020","MM-DD":"02-29"},"thumbnail":"post/Docker/Docker之Dockerfile/cover.jpg","link":"post/Docker/Docker之Dockerfile","categories":["Docker"],"updated":"2020-02-29T16:08:47.443Z","content":"<h1 id=\"dockerfile简介\">Dockerfile简介<a href=\"#dockerfile简介\" title=\"Dockerfile简介\"></a></h1><p>Dockerfile即指定如何一步步构建一个容器，有了Dockerfile我们就可以准确无误的构建一个容器。</p>\n<h1 id=\"dockerfile命令\">Dockerfile命令<a href=\"#dockerfile命令\" title=\"Dockerfile命令\"></a></h1><h2 id=\"from\">FROM<a href=\"#from\" title=\"FROM\"></a></h2><p>说明该镜像是基于哪个镜像进行构建。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">FROM</span> rackspacedot/python37</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"maintainer\">MAINTAINER<a href=\"#maintainer\" title=\"MAINTAINER\"></a></h2><p>指定维护者</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">MAINTAINER</span> rylynn</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"run\">RUN<a href=\"#run\" title=\"RUN\"></a></h2><p>构建镜像时运行的shell命令。<strong>每条RUN命令都会让镜像多一层，所以尽量用/连接多条命令。</strong></p>\n<p><strong>exec格式</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"bash\"> [<span class=\"string\">\"yum\"</span>, <span class=\"string\">\"install\"</span>, wget]</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>shell格式</strong></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"bash\"> yum install wget</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"cmd\">CMD<a href=\"#cmd\" title=\"CMD\"></a></h2><p>设置启动时默认运行的shell命令。</p>\n<ul><li>可被启动时指定的命令所覆盖</li>\n<li>多个CMD只有最后一个生效</li>\n</ul><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"bash\"> <span class=\"built_in\">echo</span> hello</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"entrypoint\">ENTRYPOINT<a href=\"#entrypoint\" title=\"ENTRYPOINT\"></a></h2><p>设置启动时运行的shell命令</p>\n<ul><li><p>不可被启动时指定的命令所覆盖，一定会运行</p>\n</li>\n<li><p>启动时所指定的命令行参数会传给ENTRYPOINT指定的命令</p>\n</li>\n<li><p>CMD生效时也会当做参数传递给ENTRYPOINT指定的命令</p>\n</li>\n</ul><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">ENTRYPOINT</span><span class=\"bash\"> <span class=\"built_in\">echo</span> hello</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"expose\">EXPOSE<a href=\"#expose\" title=\"EXPOSE\"></a></h2><p>暴露容器内的端口。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">EXEPOSE <span class=\"number\">80</span> <span class=\"number\">443</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"env\">ENV<a href=\"#env\" title=\"ENV\"></a></h2><p>设置容器内环境变量。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">ENV</span> env1=<span class=\"number\">1</span> env2=<span class=\"number\">2</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"add\">ADD<a href=\"#add\" title=\"ADD\"></a></h2><p>拷贝文件到镜像中。</p>\n<ul><li>URL：自动下载</li>\n<li>压缩包：自动解压</li>\n</ul><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"bash\"> https://xxx.com/html.tar.gz /var/www/html</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"copy\">COPY<a href=\"#copy\" title=\"COPY\"></a></h2><p>拷贝文件到镜像中，不会自动下载和解压。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"bash\"> ./start.sh /start.sh</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"volume\">VOLUME<a href=\"#volume\" title=\"VOLUME\"></a></h2><p>挂载数据卷到容器内。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">VOLUME[<span class=\"string\">\"/usr/local/rocketmq\"</span>, <span class=\"string\">\"/data\"</span>]</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"user\">USER<a href=\"#user\" title=\"USER\"></a></h3><p>指定后续命令的用户和用户组。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">user root:root</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"healthcheck\">HEALTHCHECK<a href=\"#healthcheck\" title=\"HEALTHCHECK\"></a></h2><p>告诉Docker如何测试容器以检查它是否仍在工作，即健康检查。</p>\n<p><strong>参数</strong></p>\n<ul><li>--interval=DURATION (default: 30s)：每隔多长时间探测一次，默认30秒</li>\n<li>-- timeout= DURATION (default: 30s)：服务响应超时时长，默认30秒</li>\n<li>--start-period= DURATION (default: 0s)：服务启动多久后开始探测，默认0秒</li>\n<li>--retries=N (default: 3)：认为检测失败几次为宕机，默认3次</li>\n</ul><p><strong>返回值</strong></p>\n<ul><li>0：容器成功是健康的，随时可以使用</li>\n<li>1：不健康的容器无法正常工作</li>\n<li>2：保留不使用此退出代码</li>\n</ul><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">HEALTHCHECK</span><span class=\"bash\"> --interval=5m --timeout=3s --retries=3 \\</span></span><br><span class=\"line\"><span class=\"bash\">    CMD curl -f http:/localhost/ || <span class=\"built_in\">exit</span> 1</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"workdir\">WORKDIR<a href=\"#workdir\" title=\"WORKDIR\"></a></h2><p>指定工作目录。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"bash\"> /data</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"arg\">ARG<a href=\"#arg\" title=\"ARG\"></a></h2><p>指定构建时的参数，只在build过程中有效。</p>\n<ul><li>--build-arg &lt;参数名&gt;=&lt;值&gt;可覆盖参数</li>\n</ul><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">ARG</span> arg1=<span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"onbuild\">ONBUILD<a href=\"#onbuild\" title=\"ONBUILD\"></a></h2><p>指定当该镜像被用作FROM的目标时执行的命令。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">ONBUILD</span> <span class=\"keyword\">RUN</span><span class=\"bash\"> mkdir mydir</span></span><br></pre></td></tr></table></figure>","prev":{"title":"Docker之DockerCompose","link":"post/Docker/Docker之DockerCompose"},"next":{"title":"Docker之数据持久化","link":"post/Docker/Docker之数据持久化"},"plink":"https://beginc.github.io/post/Docker/Docker之Dockerfile/","toc":[{"id":"dockerfile简介","title":"Dockerfile简介","index":"1"},{"id":"dockerfile命令","title":"Dockerfile命令","index":"2","children":[{"id":"from","title":"FROM","index":"2.1"},{"id":"maintainer","title":"MAINTAINER","index":"2.2"},{"id":"run","title":"RUN","index":"2.3"},{"id":"cmd","title":"CMD","index":"2.4"},{"id":"entrypoint","title":"ENTRYPOINT","index":"2.5"},{"id":"expose","title":"EXPOSE","index":"2.6"},{"id":"env","title":"ENV","index":"2.7"},{"id":"add","title":"ADD","index":"2.8"},{"id":"copy","title":"COPY","index":"2.9"},{"id":"volume","title":"VOLUME","index":"2.10","children":[{"id":"user","title":"USER","index":"2.10.1"}]},{"id":"healthcheck","title":"HEALTHCHECK","index":"2.11"},{"id":"workdir","title":"WORKDIR","index":"2.12"},{"id":"arg","title":"ARG","index":"2.13"},{"id":"onbuild","title":"ONBUILD","index":"2.14"}]}]}