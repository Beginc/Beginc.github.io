{"title":"6-Spring之事务管理","date":"2020-01-26T15:43:05.000Z","date_formatted":{"ll":"Jan 26, 2020","L":"01/26/2020","MM-DD":"01-26"},"thumbnail":"post/Java/Spring/6-Spring之事务管理/cover.png","link":"post/Java/Spring/6-Spring之事务管理","categories":["Java","Spring"],"updated":"2020-02-29T08:59:28.152Z","content":"<h1 id=\"事务\">事务<a href=\"#事务\" title=\"事务\"></a></h1><p>逻辑上的一组操作，组成这组操作的各个单元要么全部成功，要么全部失败。</p>\n<h2 id=\"事务的特性\">事务的特性<a href=\"#事务的特性\" title=\"事务的特性\"></a></h2><h3 id=\"atomicity\">Atomicity<a href=\"#atomicity\" title=\"Atomicity\"></a></h3><p>原子性。事务里的一组操作要么全部成功，要么全部失败。</p>\n<pre><code>转账事务：\n    1. A账户减少100块钱\n    2. B账户增加100块钱</code></pre><p>1和2要么全部成功，要么全部失败，不能是A账户减少了100块钱，而B账户却没有增加100块钱。</p>\n<h3 id=\"consistency\">Consistency<a href=\"#consistency\" title=\"Consistency\"></a></h3><p>一致性。事务执行后，数据保持完整性，符合逻辑。</p>\n<h3 id=\"isolation\">Isolation<a href=\"#isolation\" title=\"Isolation\"></a></h3><p>隔离性。两个事务的执行应该不会互相影响。</p>\n<h3 id=\"durability\">Durability<a href=\"#durability\" title=\"Durability\"></a></h3><p>持久性。事务完成后，结果被持久化到数据库。</p>\n<h2 id=\"acid的实现\">ACID的实现<a href=\"#acid的实现\" title=\"ACID的实现\"></a></h2><h3 id=\"atomicity-1\">Atomicity<a href=\"#atomicity-1\" title=\"Atomicity\"></a></h3><ul><li>事务成功<code>commit</code></li>\n<li>事务失败<code>rollback</code></li>\n</ul><h3 id=\"consistency-1\">Consistency<a href=\"#consistency-1\" title=\"Consistency\"></a></h3><p>通过原子性 + 隔离性实现。</p>\n<h3 id=\"isolation-1\">Isolation<a href=\"#isolation-1\" title=\"Isolation\"></a></h3><p>使用事务的隔离级别来保证。</p>\n<h4 id=\"事务之间的影响\">事务之间的影响<a href=\"#事务之间的影响\" title=\"事务之间的影响\"></a></h4><p><strong>脏读</strong>\n一个事务读到了另一个事务未提交的数据。</p>\n<pre><code>转账事务：\n    1. A账户减少100块钱\n    2. B账户增加100块钱\n\n读账户事务：\n    1. 读取A账户的余额</code></pre><p>若转账事务执行到1，此时数据被读账户事务读取，但转账事务失败，发生了回滚，此时读账户事务读到的数据不再与数据库一致。</p>\n<p><strong>不可重复读</strong>\n一个事务读到了另一个事务更新的数据，导致一个事务中前后多次查询结果不一致。</p>\n<pre><code>读账户事务：\n    1. 读取A账户的余额（此时为1000）\n\n转账事务：\n    1. A账户减少100块钱（变为900）\n    2. B账户增加100块钱\n\n读账户事务：\n    2. 读取A账户的余额（此时为900）</code></pre><p><strong>幻读</strong>\n一个事务读到了另一个事务插入的数据，导致一个事务中前后多次查询结果不一致。</p>\n<pre><code>读账户事务：\n    1. 读取当前账户数量（10）\n\n添加账户事务：\n    1. 添加一个账户（11）\n\n读账户事务：\n    2. 读取当前账户数量（11）</code></pre><h4 id=\"事务的隔离级别\">事务的隔离级别<a href=\"#事务的隔离级别\" title=\"事务的隔离级别\"></a></h4><p>为了消除事务间的影响，提出了事务的隔离级别。</p>\n<p><strong>Read Uncommitted</strong>\n可读未提交的数据，不能解决任何问题。</p>\n<p><strong>Read Committed</strong>\n只能读已提交的数据。可解决脏读。</p>\n<p><strong>Repetable Read</strong>\n一个事务开始了读操作后，不允许其他事务再进行修改操作。可解决不可重复读。</p>\n<p><strong>Serialiable</strong>\n所有事务必须串行执行，可解决所有问题，但效率很低。</p>\n<h3 id=\"ddurability\">D(Durability)<a href=\"#ddurability\" title=\"D(Durability)\"></a></h3><p>通过事务日志来实现。</p>\n<h1 id=\"spring声明式事务\">Spring声明式事务<a href=\"#spring声明式事务\" title=\"Spring声明式事务\"></a></h1><h2 id=\"配置事务管理器\">配置事务管理器<a href=\"#配置事务管理器\" title=\"配置事务管理器\"></a></h2><p><code>PlatformTransactionManager</code>有两个实现类</p>\n<ul><li><code>DataSourceTransactionManager</code>使用<code>JDBC</code>管理事务</li>\n<li><code>HibernateTransactionManager</code>使用<code>Hibernate</code>管理事务</li>\n</ul><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"transactionManager\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"org.springframework.jdbc.datasource.DataSourceTransactionManager\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!--注入数据源--&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"dataSource\"</span> <span class=\"attr\">ref</span>=<span class=\"string\">\"dataSource\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置事务通知\">配置事务通知<a href=\"#配置事务通知\" title=\"配置事务通知\"></a></h2><ul><li>需要引入<code>tx</code>约束</li>\n<li>需要注入事务管理器</li>\n<li><code>tx:method</code>中<code>name</code>指定方法名</li>\n<li><code>tx:method</code>中<code>isolation</code>指定隔离级别</li>\n<li><code>tx:method</code>中<code>propagation</code>指定传播行为</li>\n<li><code>tx:method</code>中<code>read-only</code>指定是否为只读事务</li>\n<li><code>tx:method</code>中<code>timeout</code>指定事务超时时间，若超过该时间事务还未完成则事务自动回滚，单位为秒</li>\n<li><code>tx:method</code>中<code>rollback-for</code>与<code>no-rollback-for</code>控制事务回滚</li>\n</ul><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">beans</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">\"http://www.springframework.org/schema/beans\"</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">\"http://www.w3.org/2001/XMLSchema-instance\"</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xmlns:aop</span>=<span class=\"string\">\"http://www.springframework.org/schema/aop\"</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xmlns:tx</span>=<span class=\"string\">\"http://www.springframework.org/schema/tx\"</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">\"http://www.springframework.org/schema/beans</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        http://www.springframework.org/schema/aop</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        http://www.springframework.org/schema/aop/spring-aop.xsd</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        http://www.springframework.org/schema/tx</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        http://www.springframework.org/schema/tx/spring-tx.xsd\"</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"accountDao\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"dao.impl.AccountDaoImpl\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"dataSource\"</span> <span class=\"attr\">ref</span>=<span class=\"string\">\"dataSource\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"accountService\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"service.impl.AccountServiceImpl\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"accountDao\"</span> <span class=\"attr\">ref</span>=<span class=\"string\">\"accountDao\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"accountController\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"controller.AccountController\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"accountService\"</span> <span class=\"attr\">ref</span>=<span class=\"string\">\"accountService\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"dataSource\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"org.springframework.jdbc.datasource.DriverManagerDataSource\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"driverClassName\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"com.mysql.cj.jdbc.Driver\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"url\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"jdbc:mysql://localhost:3306/test1?serverTimezone=UTC<span class=\"symbol\">&amp;amp;</span>useSSL=false\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"username\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"root\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"password\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"LQ18851195070\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"transactionManager\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"org.springframework.jdbc.datasource.DataSourceTransactionManager\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"dataSource\"</span> <span class=\"attr\">ref</span>=<span class=\"string\">\"dataSource\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">tx:advice</span> <span class=\"attr\">id</span>=<span class=\"string\">\"transactionAdvice\"</span> <span class=\"attr\">transaction-manager</span>=<span class=\"string\">\"transactionManager\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">tx:attributes</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">tx:method</span> <span class=\"attr\">name</span>=<span class=\"string\">\"transfer\"</span> <span class=\"attr\">isolation</span>=<span class=\"string\">\"REPEATABLE_READ\"</span> <span class=\"attr\">propagation</span>=<span class=\"string\">\"REQUIRED\"</span> <span class=\"attr\">read-only</span>=<span class=\"string\">\"false\"</span> <span class=\"attr\">timeout</span>=<span class=\"string\">\"-1\"</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">tx:attributes</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">tx:advice</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置事务aop切面\">配置事务AOP切面<a href=\"#配置事务aop切面\" title=\"配置事务AOP切面\"></a></h2><p>将通知应用到业务层方法上。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">beans</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">\"http://www.springframework.org/schema/beans\"</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">\"http://www.w3.org/2001/XMLSchema-instance\"</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xmlns:aop</span>=<span class=\"string\">\"http://www.springframework.org/schema/aop\"</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xmlns:tx</span>=<span class=\"string\">\"http://www.springframework.org/schema/tx\"</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">\"http://www.springframework.org/schema/beans</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        http://www.springframework.org/schema/aop</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        http://www.springframework.org/schema/aop/spring-aop.xsd</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        http://www.springframework.org/schema/tx</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        http://www.springframework.org/schema/tx/spring-tx.xsd\"</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"accountDao\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"dao.impl.AccountDaoImpl\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"dataSource\"</span> <span class=\"attr\">ref</span>=<span class=\"string\">\"dataSource\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"accountService\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"service.impl.AccountServiceImpl\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"accountDao\"</span> <span class=\"attr\">ref</span>=<span class=\"string\">\"accountDao\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"accountController\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"controller.AccountController\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"accountService\"</span> <span class=\"attr\">ref</span>=<span class=\"string\">\"accountService\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"dataSource\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"org.springframework.jdbc.datasource.DriverManagerDataSource\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"driverClassName\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"com.mysql.cj.jdbc.Driver\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"url\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"jdbc:mysql://localhost:3306/test1?serverTimezone=UTC<span class=\"symbol\">&amp;amp;</span>useSSL=false\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"username\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"root\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"password\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"LQ18851195070\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">\"transactionManager\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"org.springframework.jdbc.datasource.DataSourceTransactionManager\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">\"dataSource\"</span> <span class=\"attr\">ref</span>=<span class=\"string\">\"dataSource\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">tx:advice</span> <span class=\"attr\">id</span>=<span class=\"string\">\"transactionAdvice\"</span> <span class=\"attr\">transaction-manager</span>=<span class=\"string\">\"transactionManager\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">tx:attributes</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">tx:method</span> <span class=\"attr\">name</span>=<span class=\"string\">\"transfer\"</span> <span class=\"attr\">isolation</span>=<span class=\"string\">\"REPEATABLE_READ\"</span> <span class=\"attr\">propagation</span>=<span class=\"string\">\"REQUIRED\"</span> <span class=\"attr\">read-only</span>=<span class=\"string\">\"false\"</span> <span class=\"attr\">timeout</span>=<span class=\"string\">\"-1\"</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">tx:attributes</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">tx:advice</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">aop:config</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">aop:pointcut</span> <span class=\"attr\">id</span>=<span class=\"string\">\"serviceImplPointcut\"</span> <span class=\"attr\">expression</span>=<span class=\"string\">\"execution(public void service.impl.AccountServiceImpl.transfer(int, int, int))\"</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">aop:advisor</span> <span class=\"attr\">advice-ref</span>=<span class=\"string\">\"transactionAdvice\"</span> <span class=\"attr\">pointcut-ref</span>=<span class=\"string\">\"serviceImplPointcut\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">aop:advisor</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">aop:config</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"事务的传播行为\">事务的传播行为<a href=\"#事务的传播行为\" title=\"事务的传播行为\"></a></h2><p>我们的事务目前加在<code>Service</code>中的方法上，但当业务逻辑特别复杂时，可能出现业务层方法互相调用的情况，这时候需要需要使用传播行为来管理两个方法间的事务关系。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> MockService&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">A</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    doSomethingA();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">B</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    A()</span><br><span class=\"line\">    doSomethingB();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"保证在同一事务中\">保证在同一事务中<a href=\"#保证在同一事务中\" title=\"保证在同一事务中\"></a></h3><p><strong>PROPOGATION_REQUIRED</strong></p>\n<ul><li>若A中有事务，则使用A中的事务将B方法全部包括起来</li>\n<li>若A中无事务，则创建一个新的事务，将B方法全部包括起来</li>\n</ul><p><strong>PROPOGATION_SUPPORTS</strong></p>\n<ul><li>若A中有事务，则使用A中的事务将B方法全部包括起来</li>\n<li>若A中无事务，则B方法不使用事务</li>\n</ul><p><strong>PROPOGATION_MANDATORY</strong></p>\n<ul><li>若A中有事务，则使用A中的事务将B方法全部包括起来</li>\n<li>若A中无事务，抛出异常</li>\n</ul><h3 id=\"保证不在同一事务中\">保证不在同一事务中<a href=\"#保证不在同一事务中\" title=\"保证不在同一事务中\"></a></h3><p><strong>PROPOGATION_REQUIRE_NEW</strong></p>\n<ul><li>若A中有事务，将A的事务暂停，创建一个新事务，只包括B本身的操作<code>doSomethingB()</code></li>\n<li>若A中无事务，创建一个新事务，只包括B本身的操作<code>doSomethingB()</code></li>\n</ul><p><strong>PROPOGATION_NOT_SUPPORTS</strong></p>\n<ul><li>若A中有事务，将A的事务暂停，不使用事务管理。</li>\n</ul><p><strong>PROPOGATION_NEVER</strong></p>\n<ul><li>如果A中有事务，抛出异常。</li>\n</ul><h3 id=\"嵌套事务\">嵌套事务<a href=\"#嵌套事务\" title=\"嵌套事务\"></a></h3><p><strong>PROPOGATION_NESTED</strong></p>\n<ol><li>若A中有事务，按照A的事务执行，执行完后，设置一个保存点</li>\n<li>执行B中的操作<code>doSomethingB()</code><ul><li>无异常，执行成功</li>\n<li>有异常，可以回滚到初始状态，也可以回滚到保存点</li>\n</ul></li>\n</ol><h2 id=\"事务回滚控制\">事务回滚控制<a href=\"#事务回滚控制\" title=\"事务回滚控制\"></a></h2><p><code>Spring</code>中默认只有当事务执行时发生了<code>RuntimeException</code>或<code>Error</code>时会发生事务回滚，因此在发生了非运行期异常时，不会发生回滚。</p>\n<h3 id=\"回滚控制\">回滚控制<a href=\"#回滚控制\" title=\"回滚控制\"></a></h3><p>使用<code>rollback-for</code>指定遇到什么类型的异常时发生回滚。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">tx:advice</span> <span class=\"attr\">id</span>=<span class=\"string\">\"transactionAdvice\"</span> <span class=\"attr\">transaction-manager</span>=<span class=\"string\">\"transactionManager\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">tx:attributes</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!--发生所有异常时都回滚--&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">tx:method</span> <span class=\"attr\">name</span>=<span class=\"string\">\"transfer\"</span> <span class=\"attr\">isolation</span>=<span class=\"string\">\"REPEATABLE_READ\"</span> <span class=\"attr\">propagation</span>=<span class=\"string\">\"REQUIRED\"</span> <span class=\"attr\">read-only</span>=<span class=\"string\">\"false\"</span> <span class=\"attr\">timeout</span>=<span class=\"string\">\"-1\"</span> <span class=\"attr\">no-rollback-for</span>=<span class=\"string\">\"Exception\"</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">tx:attributes</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">tx:advice</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"不回滚控制\">不回滚控制<a href=\"#不回滚控制\" title=\"不回滚控制\"></a></h3><p>使用<code>no-rollback-for</code>指定遇到什么类型的异常时不发生回滚。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">tx:advice</span> <span class=\"attr\">id</span>=<span class=\"string\">\"transactionAdvice\"</span> <span class=\"attr\">transaction-manager</span>=<span class=\"string\">\"transactionManager\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">tx:attributes</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">tx:method</span> <span class=\"attr\">name</span>=<span class=\"string\">\"transfer\"</span> <span class=\"attr\">isolation</span>=<span class=\"string\">\"REPEATABLE_READ\"</span> <span class=\"attr\">propagation</span>=<span class=\"string\">\"REQUIRED\"</span> <span class=\"attr\">read-only</span>=<span class=\"string\">\"false\"</span> <span class=\"attr\">timeout</span>=<span class=\"string\">\"-1\"</span> <span class=\"attr\">no-rollback-for</span>=<span class=\"string\">\"ArithmeticException\"</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">tx:attributes</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">tx:advice</span>&gt;</span></span><br></pre></td></tr></table></figure>","prev":{"title":"7-Spring之XML配置加注解开发","link":"post/Java/Spring/7-Spring之XML配置加注解开发"},"next":{"title":"5-Spring之JdbcTemplate","link":"post/Java/Spring/5-Spring之JdbcTemplate"},"plink":"https://beginc.github.io/post/Java/Spring/6-Spring之事务管理/","toc":[{"id":"事务","title":"事务","index":"1","children":[{"id":"事务的特性","title":"事务的特性","index":"1.1","children":[{"id":"atomicity","title":"Atomicity","index":"1.1.1"},{"id":"consistency","title":"Consistency","index":"1.1.2"},{"id":"isolation","title":"Isolation","index":"1.1.3"},{"id":"durability","title":"Durability","index":"1.1.4"}]},{"id":"acid的实现","title":"ACID的实现","index":"1.2","children":[{"id":"atomicity-1","title":"Atomicity","index":"1.2.1"},{"id":"consistency-1","title":"Consistency","index":"1.2.2"},{"id":"isolation-1","title":"Isolation","index":"1.2.3"},{"id":"ddurability","title":"D(Durability)","index":"1.2.4"}]}]},{"id":"spring声明式事务","title":"Spring声明式事务","index":"2","children":[{"id":"配置事务管理器","title":"配置事务管理器","index":"2.1"},{"id":"配置事务通知","title":"配置事务通知","index":"2.2"},{"id":"配置事务aop切面","title":"配置事务AOP切面","index":"2.3"},{"id":"事务的传播行为","title":"事务的传播行为","index":"2.4","children":[{"id":"保证在同一事务中","title":"保证在同一事务中","index":"2.4.1"},{"id":"保证不在同一事务中","title":"保证不在同一事务中","index":"2.4.2"},{"id":"嵌套事务","title":"嵌套事务","index":"2.4.3"}]},{"id":"事务回滚控制","title":"事务回滚控制","index":"2.5","children":[{"id":"回滚控制","title":"回滚控制","index":"2.5.1"},{"id":"不回滚控制","title":"不回滚控制","index":"2.5.2"}]}]}]}