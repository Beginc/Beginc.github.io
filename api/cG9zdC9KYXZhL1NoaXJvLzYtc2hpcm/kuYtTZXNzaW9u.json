{"title":"6-shiro之Session","date":"2020-02-06T06:32:18.000Z","date_formatted":{"ll":"Feb 6, 2020","L":"02/06/2020","MM-DD":"02-06"},"thumbnail":"post/Java/Shiro/6-shiro之Session/cover.jpg","link":"post/Java/Shiro/6-shiro之Session","categories":["Java","Shiro"],"updated":"2020-02-08T02:51:47.279Z","content":"<h1 id=\"shiro-session特点\">Shiro Session特点<a href=\"#shiro-session特点\" title=\"Shiro Session特点\"></a></h1><ol><li><code>Shiro</code>采用<code>SessionDAO</code>来对<code>Session</code>进行存储，可以通过自定义<code>SessionDAO</code>将<code>Session</code>存储到不同的位置，如数据库，文件系统等。</li>\n<li><code>Shiro</code>完全实现了一套<code>Sesssion</code>机制，不依赖任何运行时容器，如<code>Servlet Container</code>。</li>\n<li><code>Shiro</code>提供了<code>Session Listener</code>来监听<code>Session</code>生命周期的各个事件。</li>\n<li>...</li>\n</ol><h1 id=\"shiro-session-api\">Shiro Session API<a href=\"#shiro-session-api\" title=\"Shiro Session API\"></a></h1><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">Session</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 获取Session ID</span></span><br><span class=\"line\">    <span class=\"function\">Serializable <span class=\"title\">getId</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">    <span class=\"comment\">// 获取启动Session的时间</span></span><br><span class=\"line\">    <span class=\"function\">Date <span class=\"title\">getStartTimestamp</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">    <span class=\"comment\">// 获取上次交互的时间</span></span><br><span class=\"line\">    <span class=\"function\">Date <span class=\"title\">getLastAccessTime</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">    <span class=\"comment\">// 获取剩余超时时间</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">long</span> <span class=\"title\">getTimeout</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> InvalidSessionException</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 设置Session最大存活时间</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setTimeout</span><span class=\"params\">(<span class=\"keyword\">long</span> maxIdleTimeInMillis)</span> <span class=\"keyword\">throws</span> InvalidSessionException</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 获取创建Session的主机的Host</span></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">getHost</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">    <span class=\"comment\">// 更新lastAccessTime</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">touch</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> InvalidSessionException</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 销毁Session</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">stop</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> InvalidSessionException</span>; </span><br><span class=\"line\">    <span class=\"comment\">// 获取属性键集合</span></span><br><span class=\"line\">    <span class=\"function\">Collection&lt;Object&gt; <span class=\"title\">getAttributeKeys</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> InvalidSessionException</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 获取属性</span></span><br><span class=\"line\">    <span class=\"function\">Object <span class=\"title\">getAttribute</span><span class=\"params\">(Object key)</span> <span class=\"keyword\">throws</span> InvalidSessionException</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 设置属性</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setAttribute</span><span class=\"params\">(Object key, Object value)</span> <span class=\"keyword\">throws</span> InvalidSessionException</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 移除所有属性</span></span><br><span class=\"line\">    <span class=\"function\">Object <span class=\"title\">removeAttribute</span><span class=\"params\">(Object key)</span> <span class=\"keyword\">throws</span> InvalidSessionException</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"sessionmanager\">SessionManager<a href=\"#sessionmanager\" title=\"SessionManager\"></a></h1><p><code>Shiro</code>提供了<code>SessionManager</code>来对<code>Session</code>做统一管理，同时<code>SessionManager</code>又由<code>SecurityManager</code>进行管理。</p>\n<ul><li>默认的<code>SessionManager</code>为<code>DefaultSessionManager</code></li>\n<li><code>Web</code>环境下应该使用<code>DefaultWebSessionManager</code></li>\n</ul><h2 id=\"配置\">配置<a href=\"#配置\" title=\"配置\"></a></h2><ul><li><code>globalSessionTimeout</code>会话超时时间，默认为30分钟</li>\n<li><code>sessionListeners</code>会话监听器</li>\n<li><code>sessionDAO</code>会话存储DAO，默认存在内存里</li>\n<li><code>sessionValidationScheduler</code>会话检测调度器，负责按一定规律验证并清理孤儿会话(Orphan Session)</li>\n<li><code>sessionValidationSchedulerEnabled</code>决定会话检测调度器是否启用</li>\n<li><code>deleteInvalidSessions</code>决定是否删除无效的会话</li>\n<li><code>sessionValidationInterval</code>会话检测调度器检测的时间间隔</li>\n</ul><h2 id=\"组件\">组件<a href=\"#组件\" title=\"组件\"></a></h2><h3 id=\"sessionlistener\">SessionListener<a href=\"#sessionlistener\" title=\"SessionListener\"></a></h3><h4 id=\"监听的事件\">监听的事件<a href=\"#监听的事件\" title=\"监听的事件\"></a></h4><ul><li><code>onStart</code>开启<code>Session</code></li>\n<li><code>onStop</code>关闭<code>Session</code></li>\n<li><code>onExpiration</code>会话过期</li>\n</ul><h4 id=\"实现sessionlistener\">实现SessionListener<a href=\"#实现sessionlistener\" title=\"实现SessionListener\"></a></h4><p>实现<code>SessionListener</code>接口，重写三个方法。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SessionListener1</span> <span class=\"keyword\">implements</span> <span class=\"title\">SessionListener</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onStart</span><span class=\"params\">(Session session)</span> </span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">\"Session\"</span> + session.getId() + <span class=\"string\">\" started on \"</span> + session.getHost());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onStop</span><span class=\"params\">(Session session)</span> </span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">\"Session\"</span> + session.getId() + <span class=\"string\">\" stopped on \"</span> + session.getHost());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onExpiration</span><span class=\"params\">(Session session)</span> </span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">\"Session\"</span> + session.getId() + <span class=\"string\">\" expired on \"</span> + session.getHost());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"配置sessionlistener\">配置SessionListener<a href=\"#配置sessionlistener\" title=\"配置SessionListener\"></a></h4><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[users]</span></span><br><span class=\"line\"><span class=\"attr\">user1</span>=<span class=\"number\">123</span>,user</span><br><span class=\"line\"><span class=\"attr\">user2</span>=<span class=\"number\">456</span>,admin</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[roles]</span></span><br><span class=\"line\"><span class=\"attr\">user</span>=user:query</span><br><span class=\"line\"><span class=\"attr\">admin</span>=user:*</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[main]</span></span><br><span class=\"line\"><span class=\"attr\">listener1</span>=cn.edu.njust.listener.SessionListener1</span><br><span class=\"line\"><span class=\"attr\">securityManager.sessionManager.globalSessionTimeout</span>=<span class=\"number\">10000</span></span><br><span class=\"line\"><span class=\"attr\">securityManager.sessionManager.sessionListeners</span>=<span class=\"variable\">$listener1</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"sessionvalidationscheduler\">SessionValidationScheduler<a href=\"#sessionvalidationscheduler\" title=\"SessionValidationScheduler\"></a></h3><p>TODO</p>\n<h3 id=\"sessiondao\">SessionDAO<a href=\"#sessiondao\" title=\"SessionDAO\"></a></h3><p>TODO</p>\n","prev":{"title":"7-shiro集成Web","link":"post/Java/Shiro/7-shiro集成Web"},"next":{"title":"5-shiro加密","link":"post/Java/Shiro/5-shiro加密"},"plink":"https://beginc.github.io/post/Java/Shiro/6-shiro之Session/","toc":[{"id":"shiro-session特点","title":"Shiro Session特点","index":"1"},{"id":"shiro-session-api","title":"Shiro Session API","index":"2"},{"id":"sessionmanager","title":"SessionManager","index":"3","children":[{"id":"配置","title":"配置","index":"3.1"},{"id":"组件","title":"组件","index":"3.2","children":[{"id":"sessionlistener","title":"SessionListener","index":"3.2.1"},{"id":"sessionvalidationscheduler","title":"SessionValidationScheduler","index":"3.2.2"},{"id":"sessiondao","title":"SessionDAO","index":"3.2.3"}]}]}]}