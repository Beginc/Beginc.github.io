{"title":"MyBatis动态SQL","date":"2019-08-24T01:12:43.000Z","thumbnail":"/post/MyBatis动态SQL/cover.jpg","link":"post/MyBatis动态SQL","tags":["MyBatis"],"categories":["Java"],"updated":"2019-08-29T15:11:10.609Z","content":"<h1 id=\"环境搭建\">环境搭建<a href=\"post/MyBatis动态SQL#环境搭建\"></a></h1><p>详见<a href=\"/post/MyBatis入门/\" title=\"MyBatis入门\">MyBatis入门</a></p>\n<ul>\n<li>创建Maven项目</li>\n<li>引入依赖</li>\n<li>配置SqlMapConfig.xml</li>\n<li>建立pojo对象</li>\n<li>为pojo对象建立SqlMap配置文件</li>\n</ul>\n<h1 id=\"If-Where标签\">If-Where标签<a href=\"post/MyBatis动态SQL#If-Where标签\"></a></h1><h2 id=\"需求\">需求<a href=\"post/MyBatis动态SQL#需求\"></a></h2><ul>\n<li>根据名字和年龄查询用户</li>\n</ul>\n<h2 id=\"编写SqlMap文件\">编写SqlMap文件<a href=\"post/MyBatis动态SQL#编写SqlMap文件\"></a></h2><ul>\n<li>用If来判断name和age是否存在, 仅当存在时才作为查询条件</li>\n<li>Where可用于处理条件语句, 还可以去掉<strong>前导and</strong>(当只有age做条件时, 需要去掉前面的and)</li>\n</ul>\n<figure class=\"highlight xml\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">\"findByNameAndAge\"</span> <span class=\"attr\">parameterType</span>=<span class=\"string\">\"User\"</span> <span class=\"attr\">resultType</span>=<span class=\"string\">\"User\"</span>&gt;</span></span><br><span class=\"line\">    select * from user</span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">where</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">if</span> <span class=\"attr\">test</span>=<span class=\"string\">\"name != null and name != ''\"</span>&gt;</span></span><br><span class=\"line\">            name = #&#123;name&#125;</span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">if</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">if</span> <span class=\"attr\">test</span>=<span class=\"string\">\"age != null\"</span>&gt;</span></span><br><span class=\"line\">            and age = #&#123;age&#125;</span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">if</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">where</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br></pre></td></tr></table></div></figure>\n\n<h2 id=\"编写测试\">编写测试<a href=\"post/MyBatis动态SQL#编写测试\"></a></h2><figure class=\"highlight java\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Test</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">test01</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    SqlSession session = <span class=\"keyword\">this</span>.factory.openSession();</span><br><span class=\"line\">    User query;</span><br><span class=\"line\">    List&lt;User&gt; users;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 两个条件都有</span></span><br><span class=\"line\">    query = <span class=\"keyword\">new</span> User();</span><br><span class=\"line\">    query.setName(<span class=\"string\">\"Rylynn\"</span>);</span><br><span class=\"line\">    query.setAge(<span class=\"number\">18</span>);</span><br><span class=\"line\">    users = session.selectList(<span class=\"string\">\"findByNameAndAge\"</span>, query);</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (User user : users) &#123;</span><br><span class=\"line\">        System.out.println(user);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    System.out.println();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 只有名字</span></span><br><span class=\"line\">    query = <span class=\"keyword\">new</span> User();</span><br><span class=\"line\">    query.setName(<span class=\"string\">\"Bob\"</span>);</span><br><span class=\"line\">    users = session.selectList(<span class=\"string\">\"findByNameAndAge\"</span>, query);</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (User user : users) &#123;</span><br><span class=\"line\">        System.out.println(user);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    System.out.println();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 只有年龄</span></span><br><span class=\"line\">    query = <span class=\"keyword\">new</span> User();</span><br><span class=\"line\">    query.setAge(<span class=\"number\">1</span>);</span><br><span class=\"line\">    users = session.selectList(<span class=\"string\">\"findByNameAndAge\"</span>, query);</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (User user : users) &#123;</span><br><span class=\"line\">        System.out.println(user);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 都没有</span></span><br><span class=\"line\">    query = <span class=\"keyword\">new</span> User();</span><br><span class=\"line\">    users = session.selectList(<span class=\"string\">\"findByNameAndAge\"</span>, query);</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (User user : users) &#123;</span><br><span class=\"line\">        System.out.println(user);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    session.close();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n<h1 id=\"ForEach标签\">ForEach标签<a href=\"post/MyBatis动态SQL#ForEach标签\"></a></h1><h2 id=\"需求-1\">需求<a href=\"post/MyBatis动态SQL#需求-1\"></a></h2><ul>\n<li>给定一串id, 查找id在其中的用户(不定数量的id)</li>\n</ul>\n<h2 id=\"编写SqlMap文件-1\">编写SqlMap文件<a href=\"post/MyBatis动态SQL#编写SqlMap文件-1\"></a></h2><ul>\n<li><code>collection</code>指定要遍历的数组或集合</li>\n<li><code>item</code>指定取出的元素名</li>\n<li><code>open</code>指定前缀</li>\n<li><code>close</code>指定后缀</li>\n<li><code>seperator</code>指定分隔符</li>\n</ul>\n<h3 id=\"数组\">数组<a href=\"post/MyBatis动态SQL#数组\"></a></h3><ul>\n<li>数组类型可写为<code>iterator</code></li>\n<li><strong>传数组时, 名字必须为array</strong></li>\n</ul>\n<figure class=\"highlight xml\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">\"findByIdsArray\"</span> <span class=\"attr\">parameterType</span>=<span class=\"string\">\"iterator\"</span> <span class=\"attr\">resultType</span>=<span class=\"string\">\"User\"</span>&gt;</span></span><br><span class=\"line\">    select * from user where id in</span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">foreach</span> <span class=\"attr\">collection</span>=<span class=\"string\">\"array\"</span> <span class=\"attr\">item</span>=<span class=\"string\">\"id\"</span> <span class=\"attr\">open</span>=<span class=\"string\">\"(\"</span> <span class=\"attr\">close</span>=<span class=\"string\">\")\"</span> <span class=\"attr\">separator</span>=<span class=\"string\">\",\"</span>&gt;</span></span><br><span class=\"line\">        #&#123;id&#125;</span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">foreach</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br></pre></td></tr></table></div></figure>\n\n<h3 id=\"List\">List<a href=\"post/MyBatis动态SQL#List\"></a></h3><ul>\n<li>List类型可写成<code>list</code></li>\n<li><strong>传List时, 名字必须为list</strong></li>\n</ul>\n<figure class=\"highlight xml\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">\"findByIdsList\"</span> <span class=\"attr\">parameterType</span>=<span class=\"string\">\"list\"</span> <span class=\"attr\">resultType</span>=<span class=\"string\">\"User\"</span>&gt;</span></span><br><span class=\"line\">    select * from user where id in</span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">foreach</span> <span class=\"attr\">collection</span>=<span class=\"string\">\"list\"</span> <span class=\"attr\">item</span>=<span class=\"string\">\"id\"</span> <span class=\"attr\">open</span>=<span class=\"string\">\"(\"</span> <span class=\"attr\">close</span>=<span class=\"string\">\")\"</span> <span class=\"attr\">separator</span>=<span class=\"string\">\",\"</span>&gt;</span></span><br><span class=\"line\">        #&#123;id&#125;</span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">foreach</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br></pre></td></tr></table></div></figure>\n\n<p><strong>测试样例</strong></p>\n<figure class=\"highlight java\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Test</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">test03</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    SqlSession session = <span class=\"keyword\">this</span>.factory.openSession();</span><br><span class=\"line\">    ArrayList&lt;Integer&gt; ids = <span class=\"keyword\">new</span> ArrayList&lt;Integer&gt;();</span><br><span class=\"line\">    ids.add(<span class=\"number\">11</span>);</span><br><span class=\"line\">    ids.add(<span class=\"number\">6</span>);</span><br><span class=\"line\">    ids.add(<span class=\"number\">7</span>);</span><br><span class=\"line\">    List&lt;User&gt; users = session.selectList(<span class=\"string\">\"findByIdsList\"</span>, ids);</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (User user : users) &#123;</span><br><span class=\"line\">        System.out.println(user);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    session.close();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n<h1 id=\"SQL片段\">SQL片段<a href=\"post/MyBatis动态SQL#SQL片段\"></a></h1><ul>\n<li>可用于提取常用的一些SQL片段</li>\n</ul>\n<figure class=\"highlight xml\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">sql</span> <span class=\"attr\">id</span>=<span class=\"string\">\"selectAllUser\"</span>&gt;</span></span><br><span class=\"line\">    select * from user</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">sql</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">\"findByIdsList\"</span> <span class=\"attr\">parameterType</span>=<span class=\"string\">\"list\"</span> <span class=\"attr\">resultType</span>=<span class=\"string\">\"User\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">include</span> <span class=\"attr\">refid</span>=<span class=\"string\">\"selectAllUser\"</span>/&gt;</span> where id in</span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">foreach</span> <span class=\"attr\">collection</span>=<span class=\"string\">\"list\"</span> <span class=\"attr\">item</span>=<span class=\"string\">\"id\"</span> <span class=\"attr\">open</span>=<span class=\"string\">\"(\"</span> <span class=\"attr\">close</span>=<span class=\"string\">\")\"</span> <span class=\"attr\">separator</span>=<span class=\"string\">\",\"</span>&gt;</span></span><br><span class=\"line\">        #&#123;id&#125;</span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">foreach</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br></pre></td></tr></table></div></figure>","prev":{"title":"MyBatis关联查询","link":"post/MyBatis关联查询"},"next":{"title":"MyBatis动态代理开发","link":"post/MyBatis动态代理开发"},"plink":"https://beginc.github.io/post/MyBatis动态SQL/","toc":[{"title":"环境搭建","id":"环境搭建","index":"1"},{"title":"If-Where标签","id":"If-Where标签","index":"2","children":[{"title":"需求","id":"需求","index":"2.1"},{"title":"编写SqlMap文件","id":"编写SqlMap文件","index":"2.2"},{"title":"编写测试","id":"编写测试","index":"2.3"}]},{"title":"ForEach标签","id":"ForEach标签","index":"3","children":[{"title":"需求","id":"需求-1","index":"3.1"},{"title":"编写SqlMap文件","id":"编写SqlMap文件-1","index":"3.2","children":[{"title":"数组","id":"数组","index":"3.2.1"},{"title":"List","id":"List","index":"3.2.2"}]}]},{"title":"SQL片段","id":"SQL片段","index":"4"}]}