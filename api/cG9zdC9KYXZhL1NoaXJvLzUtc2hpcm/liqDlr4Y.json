{"title":"5-shiro加密","date":"2020-02-06T04:38:18.000Z","date_formatted":{"ll":"Feb 6, 2020","L":"02/06/2020","MM-DD":"02-06"},"thumbnail":"post/Java/Shiro/5-shiro加密/cover.jpg","link":"post/Java/Shiro/5-shiro加密","categories":["Java","Shiro"],"updated":"2020-02-08T02:51:44.253Z","content":"<h1 id=\"敏感信息存储\">敏感信息存储<a href=\"#敏感信息存储\" title=\"敏感信息存储\"></a></h1><p>在数据库中存储用户的敏感信息时我们不能直接存储明文，否则万一数据库信息泄露，则用户的敏感信息会被直接窃取。\n因此我们需要将用户的敏感信息进行加密后，再存储到数据库中。而加密又可分为可逆加密和不可逆加密，我们应使用不可逆加密算法来对用户的信息进行加密。</p>\n<p><strong>带加密的注册过程</strong></p>\n<img src=\"/post/Java/Shiro/5-shiro%E5%8A%A0%E5%AF%86/1.png\" class=\"\">\n\n<p><strong>带加密的登录过程</strong></p>\n<img src=\"/post/Java/Shiro/5-shiro%E5%8A%A0%E5%AF%86/2.png\" class=\"\">\n\n<h1 id=\"shiro加密方式\">Shiro加密方式<a href=\"#shiro加密方式\" title=\"Shiro加密方式\"></a></h1><h2 id=\"直接加密\">直接加密<a href=\"#直接加密\" title=\"直接加密\"></a></h2><p>直接对信息使用加密算法进行加密，该方式易受到暴力破解。</p>\n<p><code>info = encrypt(info)</code></p>\n<h2 id=\"加盐加密\">加盐加密<a href=\"#加盐加密\" title=\"加盐加密\"></a></h2><p>加上一个<code>Salt</code>之后再进行加密。</p>\n<p><code>info = encrypt(info + salt)</code></p>\n<h2 id=\"加盐多次迭代加密\">加盐多次迭代加密<a href=\"#加盐多次迭代加密\" title=\"加盐多次迭代加密\"></a></h2><p>多次进行加盐和加密。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> _ <span class=\"keyword\">in</span> range(iter):</span><br><span class=\"line\">    info = encrypt(info + salt)</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"shiro加密api\">Shiro加密API<a href=\"#shiro加密api\" title=\"Shiro加密API\"></a></h1><ul><li><code>Md5Hash</code></li>\n<li><code>Sha256Hash</code></li>\n<li><code>Sha512Hash</code></li>\n</ul><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">String password = <span class=\"string\">\"123\"</span>;</span><br><span class=\"line\">String salt = UUID.randomUUID().toString();</span><br><span class=\"line\"><span class=\"keyword\">int</span> iter = <span class=\"number\">50</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 简单加密</span></span><br><span class=\"line\"><span class=\"comment\">// 简单加密 ---&gt; 16进制</span></span><br><span class=\"line\">String pwd = <span class=\"keyword\">new</span> Md5Hash(password).toHex();</span><br><span class=\"line\"><span class=\"comment\">// 简单加密 ---&gt; Base64编码</span></span><br><span class=\"line\">pwd = <span class=\"keyword\">new</span> Md5Hash(password).toBase64();</span><br><span class=\"line\"><span class=\"comment\">// 加盐加密 ---&gt; Base64编码</span></span><br><span class=\"line\">pwd = <span class=\"keyword\">new</span> Md5Hash(password, salt).toBase64();</span><br><span class=\"line\"><span class=\"comment\">// 加盐多次迭代加密 ---&gt; Base64编码</span></span><br><span class=\"line\">pwd = <span class=\"keyword\">new</span> Md5Hash(password, salt, iter).toBase64();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 简单加密</span></span><br><span class=\"line\"><span class=\"comment\">// 简单加密 ---&gt; 16进制</span></span><br><span class=\"line\">pwd = <span class=\"keyword\">new</span> Sha256Hash(password).toHex();</span><br><span class=\"line\"><span class=\"comment\">// 简单加密 ---&gt; Base64编码</span></span><br><span class=\"line\">pwd = <span class=\"keyword\">new</span> Sha256Hash(password).toBase64();</span><br><span class=\"line\"><span class=\"comment\">// 加盐加密 ---&gt; Base64编码</span></span><br><span class=\"line\">pwd = <span class=\"keyword\">new</span> Sha256Hash(password, salt).toBase64();</span><br><span class=\"line\"><span class=\"comment\">// 加盐多次迭代加密 ---&gt; Base64编码</span></span><br><span class=\"line\">pwd = <span class=\"keyword\">new</span> Sha256Hash(password, salt, iter).toBase64();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 简单加密</span></span><br><span class=\"line\"><span class=\"comment\">// 简单加密 ---&gt; 16进制</span></span><br><span class=\"line\">pwd = <span class=\"keyword\">new</span> Sha512Hash(password).toHex();</span><br><span class=\"line\"><span class=\"comment\">// 简单加密 ---&gt; Base64编码</span></span><br><span class=\"line\">pwd = <span class=\"keyword\">new</span> Sha512Hash(password).toBase64();</span><br><span class=\"line\"><span class=\"comment\">// 加盐加密 ---&gt; Base64编码</span></span><br><span class=\"line\">pwd = <span class=\"keyword\">new</span> Sha512Hash(password, salt).toBase64();</span><br><span class=\"line\"><span class=\"comment\">// 加盐多次迭代加密 ---&gt; Base64编码</span></span><br><span class=\"line\">pwd = <span class=\"keyword\">new</span> Sha512Hash(password, salt, iter).toBase64();</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"shiro加密认证\">Shiro加密认证<a href=\"#shiro加密认证\" title=\"Shiro加密认证\"></a></h1><ul><li>对密码进行加密后，则在认证时无法直接使用默认的密码比对器进行密码比对，需要使用<code>HashedCredentialsMatcher</code>。</li>\n<li>对密码进行加盐加密后，则<code>Realm</code>在返回<code>AuthenticationInfo</code>时，还需要传入加密时所加的<code>salt</code>。</li>\n</ul><h2 id=\"配置\">配置<a href=\"#配置\" title=\"配置\"></a></h2><ul><li><code>hashAlgorithmName</code>加密算法</li>\n<li><code>hashIterations</code>迭代次数</li>\n<li><code>hashSalted</code>是否加盐</li>\n<li><code>storedCredentialsHexEncoded</code>是否是16进制编码<ul><li><code>toBase64</code>: <code>false</code></li>\n<li><code>toHex</code>: <code>true</code></li>\n</ul></li>\n</ul><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[main]</span></span><br><span class=\"line\"><span class=\"attr\">credentialsMatcher</span>=org.apache.shiro.authc.credential.HashedCredentialsMatcher</span><br><span class=\"line\"><span class=\"attr\">credentialsMatcher.hashAlgorithmName</span>=MD5</span><br><span class=\"line\"><span class=\"attr\">credentialsMatcher.hashIterations</span>=<span class=\"number\">50</span></span><br><span class=\"line\"><span class=\"attr\">credentialsMatcher.hashSalted</span>=<span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">credentialsMatcher.storedCredentialsHexEncoded</span>=<span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">realm3</span> = cn.edu.njust.realm.Realm3</span><br><span class=\"line\"><span class=\"attr\">realm3.credentialsMatcher</span>=<span class=\"variable\">$credentialsMatcher</span></span><br><span class=\"line\"><span class=\"attr\">securityManager.realms</span> = <span class=\"variable\">$realm3</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"realm\">Realm<a href=\"#realm\" title=\"Realm\"></a></h2><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Realm3</span> <span class=\"keyword\">extends</span> <span class=\"title\">AuthorizingRealm</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> AuthorizationInfo <span class=\"title\">doGetAuthorizationInfo</span><span class=\"params\">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class=\"line\">        String username = (String) principals.getPrimaryPrincipal();</span><br><span class=\"line\">        SimpleAuthorizationInfo info = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 直接Hard Code</span></span><br><span class=\"line\">        <span class=\"comment\">//  可替换成数据库操作</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (username.equals(<span class=\"string\">\"user3\"</span>)) &#123;</span><br><span class=\"line\">            Set&lt;String&gt; roles = <span class=\"keyword\">new</span> HashSet&lt;&gt;();</span><br><span class=\"line\">            roles.add(<span class=\"string\">\"user\"</span>);</span><br><span class=\"line\">            Set&lt;String&gt; permissions = <span class=\"keyword\">new</span> HashSet&lt;&gt;();</span><br><span class=\"line\">            permissions.add(<span class=\"string\">\"user:query\"</span>);</span><br><span class=\"line\">            info = <span class=\"keyword\">new</span> SimpleAuthorizationInfo(roles);</span><br><span class=\"line\">            info.addStringPermissions(permissions);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> info;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> AuthenticationInfo <span class=\"title\">doGetAuthenticationInfo</span><span class=\"params\">(AuthenticationToken token)</span> <span class=\"keyword\">throws</span> AuthenticationException </span>&#123;</span><br><span class=\"line\">        String username = (String) token.getPrincipal();</span><br><span class=\"line\">        SimpleAuthenticationInfo info = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (username.equals(<span class=\"string\">\"user3\"</span>))&#123;</span><br><span class=\"line\">            <span class=\"comment\">// 传入salt</span></span><br><span class=\"line\">            String salt = <span class=\"string\">\"salt\"</span>;</span><br><span class=\"line\">            info = <span class=\"keyword\">new</span> SimpleAuthenticationInfo(<span class=\"string\">\"user3\"</span>, <span class=\"string\">\"zjnFk4aKrdISF6OTslZKCQ==\"</span>, ByteSource.Util.bytes(salt), getName());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> info;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"测试\">测试<a href=\"#测试\" title=\"测试\"></a></h2><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Test03</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Test</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">test03</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        Factory&lt;SecurityManager&gt; factory = <span class=\"keyword\">new</span> IniSecurityManagerFactory(<span class=\"string\">\"classpath:shiro.ini\"</span>);</span><br><span class=\"line\">        SecurityManager securityManager = factory.getInstance();</span><br><span class=\"line\">        SecurityUtils.setSecurityManager(securityManager);</span><br><span class=\"line\"></span><br><span class=\"line\">        Subject subject = SecurityUtils.getSubject();</span><br><span class=\"line\">        UsernamePasswordToken token = <span class=\"keyword\">new</span> UsernamePasswordToken();</span><br><span class=\"line\">        token.setUsername(<span class=\"string\">\"user3\"</span>);</span><br><span class=\"line\">        token.setPassword(<span class=\"string\">\"123\"</span>.toCharArray());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span>&#123;</span><br><span class=\"line\">            subject.login(token);</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"登录成功\"</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (AuthenticationException e)&#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"登录失败\"</span>);</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","prev":{"title":"6-shiro之Session","link":"post/Java/Shiro/6-shiro之Session"},"next":{"title":"4-shiro授权","link":"post/Java/Shiro/4-shiro授权"},"plink":"https://beginc.github.io/post/Java/Shiro/5-shiro加密/","toc":[{"id":"敏感信息存储","title":"敏感信息存储","index":"1"},{"id":"shiro加密方式","title":"Shiro加密方式","index":"2","children":[{"id":"直接加密","title":"直接加密","index":"2.1"},{"id":"加盐加密","title":"加盐加密","index":"2.2"},{"id":"加盐多次迭代加密","title":"加盐多次迭代加密","index":"2.3"}]},{"id":"shiro加密api","title":"Shiro加密API","index":"3"},{"id":"shiro加密认证","title":"Shiro加密认证","index":"4","children":[{"id":"配置","title":"配置","index":"4.1"},{"id":"realm","title":"Realm","index":"4.2"},{"id":"测试","title":"测试","index":"4.3"}]}]}