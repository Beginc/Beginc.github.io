{"title":"JVM之类文件结构","date":"2020-03-03T06:33:46.000Z","date_formatted":{"ll":"Mar 3, 2020","L":"03/03/2020","MM-DD":"03-03"},"thumbnail":"post/Java/JVM/JVM之类文件结构/cover.jpg","link":"post/Java/JVM/JVM之类文件结构","categories":["JVM","Java"],"updated":"2020-03-03T09:55:28.639Z","content":"<h1 id=\"类文件结构\">类文件结构<a href=\"#类文件结构\" title=\"类文件结构\"></a></h1><ul><li>魔数</li>\n<li>版本<ul><li>次版本号</li>\n<li>主版本号</li>\n</ul></li>\n<li>常量池</li>\n<li>访问标志</li>\n<li>本类索引</li>\n<li>父类索引</li>\n<li>接口</li>\n<li>字段</li>\n<li>方法</li>\n<li>属性</li>\n</ul><img src=\"/post/Java/JVM/JVM%E4%B9%8B%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20200303144220163.png\" class=\"\">\n\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Main</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> field;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Main</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        field = <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        String str = <span class=\"string\">\"Hello Java\"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>对应的反编译后的信息。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Classfile /C:/Users/Administrator/Desktop/Main<span class=\"class\">.<span class=\"keyword\">class</span></span></span><br><span class=\"line\"><span class=\"class\">  <span class=\"title\">Last</span> <span class=\"title\">modified</span> 2020-3-3</span>; size <span class=\"number\">294</span> bytes</span><br><span class=\"line\">  MD5 checksum d044bf6f49686f9050ce57df066d7b98</span><br><span class=\"line\">  Compiled from <span class=\"string\">\"Main.java\"</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Main</span></span></span><br><span class=\"line\">  minor version: 0</span><br><span class=\"line\">  major version: <span class=\"number\">52</span></span><br><span class=\"line\">  flags: ACC_PUBLIC, ACC_SUPER</span><br><span class=\"line\">Constant pool:</span><br><span class=\"line\">   #1 = Methodref          #5.#15         // java/lang/Object.\"&lt;init&gt;\":()V</span><br><span class=\"line\">   #2 = Fieldref           #4.#16         // Main.field:I</span><br><span class=\"line\">   #3 = String             #17            // Hello Java</span><br><span class=\"line\">   #4 = Class              #18            // Main</span><br><span class=\"line\">   #5 = Class              #19            // java/lang/Object</span><br><span class=\"line\">   #6 = Utf8               field</span><br><span class=\"line\">   #7 = Utf8               I</span><br><span class=\"line\">   #8 = Utf8               &lt;init&gt;</span><br><span class=\"line\">   #9 = Utf8               ()V</span><br><span class=\"line\">  #10 = Utf8               Code</span><br><span class=\"line\">  #11 = Utf8               LineNumberTable</span><br><span class=\"line\">  #12 = Utf8               main</span><br><span class=\"line\">  #13 = Utf8               SourceFile</span><br><span class=\"line\">  #14 = Utf8               Main.java</span><br><span class=\"line\">  #15 = NameAndType        #8:#9          // \"&lt;init&gt;\":()V</span><br><span class=\"line\">  #16 = NameAndType        #6:#7          // field:I</span><br><span class=\"line\">  #17 = Utf8               Hello Java</span><br><span class=\"line\">  #18 = Utf8               Main</span><br><span class=\"line\">  #19 = Utf8               java/lang/Object</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> field;</span><br><span class=\"line\">    descriptor: I</span><br><span class=\"line\">    flags:</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Main</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">    descriptor: ()V</span><br><span class=\"line\">    flags: ACC_PUBLIC</span><br><span class=\"line\">    Code:</span><br><span class=\"line\">      stack=<span class=\"number\">2</span>, locals=<span class=\"number\">1</span>, args_size=<span class=\"number\">1</span></span><br><span class=\"line\">         <span class=\"number\">0</span>: aload_0</span><br><span class=\"line\">         1: invokespecial #1                  // Method java/lang/Object.\"&lt;init&gt;\":()V</span><br><span class=\"line\">         <span class=\"number\">4</span>: aload_0</span><br><span class=\"line\">         <span class=\"number\">5</span>: iconst_1</span><br><span class=\"line\">         6: putfield      #2                  // Field field:I</span><br><span class=\"line\">         <span class=\"number\">9</span>: <span class=\"keyword\">return</span></span><br><span class=\"line\">      LineNumberTable:</span><br><span class=\"line\">        line <span class=\"number\">4</span>: <span class=\"number\">0</span></span><br><span class=\"line\">        line <span class=\"number\">5</span>: <span class=\"number\">4</span></span><br><span class=\"line\">        line <span class=\"number\">6</span>: <span class=\"number\">9</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">    descriptor: ()V</span><br><span class=\"line\">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class=\"line\">    Code:</span><br><span class=\"line\">      stack=<span class=\"number\">1</span>, locals=<span class=\"number\">1</span>, args_size=<span class=\"number\">0</span></span><br><span class=\"line\">         0: ldc           #3                  // String Hello Java</span><br><span class=\"line\">         <span class=\"number\">2</span>: astore_0</span><br><span class=\"line\">         <span class=\"number\">3</span>: <span class=\"keyword\">return</span></span><br><span class=\"line\">      LineNumberTable:</span><br><span class=\"line\">        line <span class=\"number\">9</span>: <span class=\"number\">0</span></span><br><span class=\"line\">        line <span class=\"number\">10</span>: <span class=\"number\">3</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">SourceFile: <span class=\"string\">\"Main.java\"</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"魔数\">魔数<a href=\"#魔数\" title=\"魔数\"></a></h2><p>开头四个字节，固定为0xCAFEBABE，标识为Java字节码，若没有则为无效类文件。</p>\n<h2 id=\"版本\">版本<a href=\"#版本\" title=\"版本\"></a></h2><p>描述版本信息。</p>\n<h2 id=\"常量池\">常量池<a href=\"#常量池\" title=\"常量池\"></a></h2><h3 id=\"常量池表项数\">常量池表项数<a href=\"#常量池表项数\" title=\"常量池表项数\"></a></h3><p>为constant_pool_count - 1。</p>\n<h3 id=\"常量池表\">常量池表<a href=\"#常量池表\" title=\"常量池表\"></a></h3><p>主要存放两类信息</p>\n<ul><li>字面量</li>\n<li>符号引用<ul><li>类和接口的全限定名</li>\n<li>字段的名称和描述符</li>\n<li>方法的名称和描述符</li>\n</ul></li>\n</ul><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Constant pool:</span><br><span class=\"line\">   #1 = Methodref          #5.#15         // java/lang/Object.\"&lt;init&gt;\":()V</span><br><span class=\"line\">   #2 = Fieldref           #4.#16         // Main.field:I</span><br><span class=\"line\">   #3 = String             #17            // Hello Java</span><br><span class=\"line\">   #4 = Class              #18            // Main</span><br><span class=\"line\">   #5 = Class              #19            // java/lang/Object</span><br><span class=\"line\">   #6 = Utf8               field</span><br><span class=\"line\">   #7 = Utf8               I</span><br><span class=\"line\">   #8 = Utf8               &lt;init&gt;</span><br><span class=\"line\">   #9 = Utf8               ()V</span><br><span class=\"line\">  #10 = Utf8               Code</span><br><span class=\"line\">  #11 = Utf8               LineNumberTable</span><br><span class=\"line\">  #12 = Utf8               main</span><br><span class=\"line\">  #13 = Utf8               SourceFile</span><br><span class=\"line\">  #14 = Utf8               Main.java</span><br><span class=\"line\">  #15 = NameAndType        #8:#9          // \"&lt;init&gt;\":()V</span><br><span class=\"line\">  #16 = NameAndType        #6:#7          // field:I</span><br><span class=\"line\">  #17 = Utf8               Hello Java</span><br><span class=\"line\">  #18 = Utf8               Main</span><br><span class=\"line\">  #19 = Utf8               java/lang/Object</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"访问标志\">访问标志<a href=\"#访问标志\" title=\"访问标志\"></a></h2><img src=\"/post/Java/JVM/JVM%E4%B9%8B%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20200303145712178.png\" class=\"\">\n\n<h1 id=\"语法原理\">语法原理<a href=\"#语法原理\" title=\"语法原理\"></a></h1><h2 id=\"构造方法\">构造方法<a href=\"#构造方法\" title=\"构造方法\"></a></h2><h3 id=\"cinit\">cinit<a href=\"#cinit\" title=\"cinit\"></a></h3><p>编译器会从上至下收集所有静态代码块和静态成员赋值的代码，合并成为一个<cinit>()V方法</p>\n<ul><li>该方法在类加载的<strong>初始化阶段</strong>被调用</li>\n</ul><img src=\"/post/Java/JVM/JVM%E4%B9%8B%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20200303150629909.png\" class=\"\">\n\n<img src=\"/post/Java/JVM/JVM%E4%B9%8B%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20200303150640729.png\" class=\"\">\n\n\n\n<h3 id=\"init\">init<a href=\"#init\" title=\"init\"></a></h3><p>编译器会从上至下收集{}初始化代码块和成员变量赋值的代码，形成新的构造方法，但原始构</p>\n<p>造方法内的代码总是在最后。</p>\n<h2 id=\"多态\">多态<a href=\"#多态\" title=\"多态\"></a></h2><img src=\"/post/Java/JVM/JVM%E4%B9%8B%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20200303153006959.png\" class=\"\">\n\n<p>本类方法：实际调用的方法地址</p>\n<img src=\"/post/Java/JVM/JVM%E4%B9%8B%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/image-20200303153040230.png\" class=\"\">\n\n<p><strong>invokevirtual</strong></p>\n<ol><li>通过对象的对象头KClass部分找到实际的Class</li>\n<li>KClass结构中有vtable，方法映射规则在编译器已经写好了</li>\n<li>查表获取方法的具体地址</li>\n<li>执行字节码</li>\n</ol>","prev":{"title":"JVM之类加载","link":"post/Java/JVM/JVM之类加载"},"next":{"title":"Java之动态代理","link":"post/Java/Java语言/Java之动态代理"},"plink":"https://beginc.github.io/post/Java/JVM/JVM之类文件结构/","toc":[{"id":"类文件结构","title":"类文件结构","index":"1","children":[{"id":"魔数","title":"魔数","index":"1.1"},{"id":"版本","title":"版本","index":"1.2"},{"id":"常量池","title":"常量池","index":"1.3","children":[{"id":"常量池表项数","title":"常量池表项数","index":"1.3.1"},{"id":"常量池表","title":"常量池表","index":"1.3.2"}]},{"id":"访问标志","title":"访问标志","index":"1.4"}]},{"id":"语法原理","title":"语法原理","index":"2","children":[{"id":"构造方法","title":"构造方法","index":"2.1","children":[{"id":"cinit","title":"cinit","index":"2.1.1"},{"id":"init","title":"init","index":"2.1.2"}]},{"id":"多态","title":"多态","index":"2.2"}]}]}