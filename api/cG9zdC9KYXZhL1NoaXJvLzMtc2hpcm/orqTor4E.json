{"title":"3-shiro认证","date":"2020-02-05T14:04:33.000Z","date_formatted":{"ll":"Feb 5, 2020","L":"02/05/2020","MM-DD":"02-05"},"thumbnail":"post/Java/Shiro/3-shiro认证/cover.jpg","link":"post/Java/Shiro/3-shiro认证","categories":["Java","Shiro"],"updated":"2020-02-08T02:51:38.356Z","content":"<h1 id=\"shiro认证api\">Shiro认证API<a href=\"#shiro认证api\" title=\"Shiro认证API\"></a></h1><ul><li><code>Subject.login</code></li>\n<li><code>Subject.logout</code></li>\n</ul><h1 id=\"shiro认证流程\">Shiro认证流程<a href=\"#shiro认证流程\" title=\"Shiro认证流程\"></a></h1><ol><li><p><code>Subject.login(token)</code>进行认证</p>\n</li>\n<li><p><code>SecurityManager</code>调用<code>Authenticator</code>进行认证</p>\n</li>\n<li><p><code>Authenticator</code>调用<code>Realm</code>进行认证信息查询与比对</p>\n</li>\n<li><p><code>Authenticator</code>根据<code>AuthenticationStrategy</code>决定认证是否通过</p>\n</li>\n</ol><h2 id=\"源码分析\">源码分析<a href=\"#源码分析\" title=\"源码分析\"></a></h2><ol><li><code>DelegatingSubject</code>调用<code>login</code>方法进行认证。</li>\n</ol><img src=\"/post/Java/Shiro/3-shiro%E8%AE%A4%E8%AF%81/1.png\" class=\"\">\n\n<ol><li><code>DelegatingSubject</code>调用<code>DefaultSecurityManager</code>的<code>login</code>方法进行认证。</li>\n</ol><img src=\"/post/Java/Shiro/3-shiro%E8%AE%A4%E8%AF%81/2.png\" class=\"\">\n\n<ol><li><code>login</code>方法定义在<code>AuthenticatingSecurityManager</code>中，调用<code>authenticate</code>方法进行认证。</li>\n</ol><img src=\"/post/Java/Shiro/3-shiro%E8%AE%A4%E8%AF%81/3.png\" class=\"\">\n\n<ol><li><code>authenticate</code>方法定义在父类<code>AuthenticatingSecurityManager</code>中，调用自身的<code>authenticator</code>的<code>authenticate</code>方法进行认证。</li>\n</ol><img src=\"/post/Java/Shiro/3-shiro%E8%AE%A4%E8%AF%81/4.png\" class=\"\">\n\n<ol><li><code>DefaultSecurityManager</code>的默认<code>authenticator</code>为<code>ModularRealmAuthenticator</code>，其<code>authenticate</code>方法定义在父类<code>AbstractAuthenticator</code>中，该方法调用<code>doAuthenticate</code>方法进行认证。</li>\n</ol><img src=\"/post/Java/Shiro/3-shiro%E8%AE%A4%E8%AF%81/5.png\" class=\"\">\n\n<ol><li><code>doAuthenticate</code>方法为抽象方法，要由子类实现。</li>\n</ol><img src=\"/post/Java/Shiro/3-shiro%E8%AE%A4%E8%AF%81/6.png\" class=\"\">\n\n<ol><li><code>ModularRealmAuthenticator</code>重写了<code>doAuthenticate</code>方法，根据<code>Realms</code>的数量调用<code>doSingleRealmAuthentication</code>方法或<code>doMultiRealmAuthentication</code>方法。</li>\n</ol><img src=\"/post/Java/Shiro/3-shiro%E8%AE%A4%E8%AF%81/7.png\" class=\"\">\n\n<ol><li><code>doSingleRealmAuthentication</code>直接调用<code>Realm</code>的<code>getAuthenticationInfo</code>方法进行认证信息查询和比对。</li>\n</ol><img src=\"/post/Java/Shiro/3-shiro%E8%AE%A4%E8%AF%81/8.png\" class=\"\">\n\n<ol><li><code>doMultiRealmAuthentication</code>对多个<code>Realm</code>进行认证信息查询和比对，根据<code>AuthenticationStrategy</code>对多个结果进行聚合，决定认证是否通过。</li>\n</ol><img src=\"/post/Java/Shiro/3-shiro%E8%AE%A4%E8%AF%81/9.png\" class=\"\">\n\n<ol><li><code>Realm</code>的<code>getAuthenticationInfo</code>在<code>AuthenticatingRealm</code>中进行了实现，该方法调用<code>doGetAuthenticationInfo</code>方法进行认证信息查询，然后通过<code>CredentialsMatcher</code>进行认证信息比对，决定认证是否通过。</li>\n</ol><img src=\"/post/Java/Shiro/3-shiro%E8%AE%A4%E8%AF%81/10.png\" class=\"\">\n\n<ol><li><code>doGetAuthenticationInfo</code>为抽象方法，子类需要实现该方法进行认证信息查询。</li>\n</ol><img src=\"/post/Java/Shiro/3-shiro%E8%AE%A4%E8%AF%81/11.png\" class=\"\">\n\n<h1 id=\"认证相关组件\">认证相关组件<a href=\"#认证相关组件\" title=\"认证相关组件\"></a></h1><h2 id=\"authenticator\">Authenticator<a href=\"#authenticator\" title=\"Authenticator\"></a></h2><h3 id=\"作用\">作用<a href=\"#作用\" title=\"作用\"></a></h3><p>由源码分析可知，<code>Authenticator</code>主要职责就是实现<code>authenticate</code>方法进行认证。</p>\n<h3 id=\"扩展\">扩展<a href=\"#扩展\" title=\"扩展\"></a></h3><p>可通过继承<code>AbstractAuthenticator</code>，重写<code>doAuthenticate</code>方法来自定义<code>Authentiactor</code>。</p>\n<h3 id=\"配置\">配置<a href=\"#配置\" title=\"配置\"></a></h3><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[main]</span></span><br><span class=\"line\"><span class=\"attr\">authenticator</span> = cn.edu.njust.authenticator.CustomAuthenticator</span><br><span class=\"line\"><span class=\"attr\">securityManager.authenticator</span> = <span class=\"variable\">$authenticator</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"authenticationstrategy\">AuthenticationStrategy<a href=\"#authenticationstrategy\" title=\"AuthenticationStrategy\"></a></h2><h3 id=\"作用-1\">作用<a href=\"#作用-1\" title=\"作用\"></a></h3><p>由源码分析可知，<code>AuthenticationStrategy</code>主要是在有多个<code>Realm</code>的情况下发挥作用。</p>\n<h3 id=\"实现\">实现<a href=\"#实现\" title=\"实现\"></a></h3><ul><li><code>AtLeastOneSuccessfulStrategy</code>只要有一个<code>Realm</code>认证成功就算成功。</li>\n<li><code>FirstSuccessfulStrategy</code>第一个<code>Realm</code>认证成功就算成功。</li>\n<li><code>AllSuccessfulStrategy</code>全部<code>Realm</code>认证成功就算成功。</li>\n</ul><h3 id=\"扩展-1\">扩展<a href=\"#扩展-1\" title=\"扩展\"></a></h3><p>TODO</p>\n<h2 id=\"realm\">Realm<a href=\"#realm\" title=\"Realm\"></a></h2><h3 id=\"作用-2\">作用<a href=\"#作用-2\" title=\"作用\"></a></h3><p>由源码分析可知，<code>Realm</code>作用就是根据查询认证信息，和<code>token</code>进行比对。</p>\n<h3 id=\"扩展-2\">扩展<a href=\"#扩展-2\" title=\"扩展\"></a></h3><p>继承<code>AuthenticatingRealm</code>，实现<code>doGetAuthenticationInfo</code>方法。</p>\n<h3 id=\"配置-1\">配置<a href=\"#配置-1\" title=\"配置\"></a></h3><p>配置主要牵涉到<code>Realm</code>的查询顺序问题</p>\n<p><strong>隐式顺序</strong>\n按声明的顺序, <code>realm1</code>, <code>realm2</code>, <code>realm3</code>。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[main]</span></span><br><span class=\"line\"><span class=\"attr\">realm1</span> = cn.edu.njust.realm.Realm1</span><br><span class=\"line\"><span class=\"attr\">realm2</span> = cn.edu.njust.realm.Realm1</span><br><span class=\"line\"><span class=\"attr\">realm3</span> = cn.edu.njust.realm.Realm1</span><br></pre></td></tr></table></figure>\n\n<p><strong>显式顺序</strong>\n按设置的顺序, <code>realm2</code>, <code>realm1</code>, <code>realm3</code>。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[main]</span></span><br><span class=\"line\"><span class=\"attr\">realm1</span> = cn.edu.njust.realm.Realm1</span><br><span class=\"line\"><span class=\"attr\">realm2</span> = cn.edu.njust.realm.Realm1</span><br><span class=\"line\"><span class=\"attr\">realm3</span> = cn.edu.njust.realm.Realm1</span><br><span class=\"line\"><span class=\"attr\">securityManager.realms</span> = <span class=\"variable\">$realm2</span>, <span class=\"variable\">$realm1</span>, <span class=\"variable\">$realm3</span></span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"自定义realm实现认证\">自定义Realm实现认证<a href=\"#自定义realm实现认证\" title=\"自定义Realm实现认证\"></a></h1><h2 id=\"扩展realm\">扩展Realm<a href=\"#扩展realm\" title=\"扩展Realm\"></a></h2><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Realm1</span> <span class=\"keyword\">extends</span> <span class=\"title\">AuthenticatingRealm</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> AuthenticationInfo <span class=\"title\">doGetAuthenticationInfo</span><span class=\"params\">(AuthenticationToken token)</span> <span class=\"keyword\">throws</span> AuthenticationException </span>&#123;</span><br><span class=\"line\">        String username = (String) token.getPrincipal();</span><br><span class=\"line\">        SimpleAuthenticationInfo info = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"comment\">// 此处直接Hard Code</span></span><br><span class=\"line\">        <span class=\"comment\">// 可以换成数据库查询操作</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (username.equals(<span class=\"string\">\"user1\"</span>))</span><br><span class=\"line\">            info = <span class=\"keyword\">new</span> SimpleAuthenticationInfo(<span class=\"string\">\"user1\"</span>, <span class=\"string\">\"123\"</span>, getName());</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(username.equals(<span class=\"string\">\"user2\"</span>))</span><br><span class=\"line\">            info = <span class=\"keyword\">new</span> SimpleAuthenticationInfo(<span class=\"string\">\"user2\"</span>, <span class=\"string\">\"456\"</span>, getName());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> info;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置realm\">配置Realm<a href=\"#配置realm\" title=\"配置Realm\"></a></h2><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[main]</span></span><br><span class=\"line\"><span class=\"attr\">realm1</span> = cn.edu.njust.realm.Realm1</span><br><span class=\"line\"><span class=\"attr\">securityManager.realms</span> = <span class=\"variable\">$realm1</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"测试\">测试<a href=\"#测试\" title=\"测试\"></a></h2><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Test01</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Test</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">test01</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        Factory&lt;SecurityManager&gt; factory = <span class=\"keyword\">new</span> IniSecurityManagerFactory(<span class=\"string\">\"classpath:shiro.ini\"</span>);</span><br><span class=\"line\">        SecurityManager securityManager = factory.getInstance();</span><br><span class=\"line\">        SecurityUtils.setSecurityManager(securityManager);</span><br><span class=\"line\"></span><br><span class=\"line\">        Subject subject = SecurityUtils.getSubject();</span><br><span class=\"line\">        UsernamePasswordToken token = <span class=\"keyword\">new</span> UsernamePasswordToken();</span><br><span class=\"line\">        token.setUsername(<span class=\"string\">\"user1\"</span>);</span><br><span class=\"line\">        token.setPassword(<span class=\"string\">\"456\"</span>.toCharArray());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span>&#123;</span><br><span class=\"line\">            subject.login(token);</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"登录成功\"</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (AuthenticationException e)&#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"登录失败\"</span>);</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n","prev":{"title":"4-shiro授权","link":"post/Java/Shiro/4-shiro授权"},"next":{"title":"2-shiro架构概述","link":"post/Java/Shiro/2-shiro架构概述"},"plink":"https://beginc.github.io/post/Java/Shiro/3-shiro认证/","toc":[{"id":"shiro认证api","title":"Shiro认证API","index":"1"},{"id":"shiro认证流程","title":"Shiro认证流程","index":"2","children":[{"id":"源码分析","title":"源码分析","index":"2.1"}]},{"id":"认证相关组件","title":"认证相关组件","index":"3","children":[{"id":"authenticator","title":"Authenticator","index":"3.1","children":[{"id":"作用","title":"作用","index":"3.1.1"},{"id":"扩展","title":"扩展","index":"3.1.2"},{"id":"配置","title":"配置","index":"3.1.3"}]},{"id":"authenticationstrategy","title":"AuthenticationStrategy","index":"3.2","children":[{"id":"作用-1","title":"作用","index":"3.2.1"},{"id":"实现","title":"实现","index":"3.2.2"},{"id":"扩展-1","title":"扩展","index":"3.2.3"}]},{"id":"realm","title":"Realm","index":"3.3","children":[{"id":"作用-2","title":"作用","index":"3.3.1"},{"id":"扩展-2","title":"扩展","index":"3.3.2"},{"id":"配置-1","title":"配置","index":"3.3.3"}]}]},{"id":"自定义realm实现认证","title":"自定义Realm实现认证","index":"4","children":[{"id":"扩展realm","title":"扩展Realm","index":"4.1"},{"id":"配置realm","title":"配置Realm","index":"4.2"},{"id":"测试","title":"测试","index":"4.3"}]}]}